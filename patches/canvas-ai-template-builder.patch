From 59a5c5a65ae6a36ea342b0e8c2dda871665f587c Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 11 Nov 2025 13:08:07 +0530
Subject: [PATCH 01/50] Resolve merge conflicts

---
 modules/canvas_ai/canvas_ai.links.menu.yml    |   4 +
 modules/canvas_ai/canvas_ai.routing.yml       |   8 +-
 ...ai_agent.canvas_template_builder_agent.yml | 125 ++++++++++++++
 .../config/schema/canvas_ai.schema.yml        |  12 ++
 .../src/CanvasAiPageBuilderHelper.php         | 141 ++++++++++++++++
 .../Form/CanvasAIThemeRegionSettingsForm.php  | 120 +++++++++++++
 modules/canvas_ai/src/Hook/CanvasAiHooks.php  |   8 +
 .../SetAIGeneratedTemplateData.php            | 158 ++++++++++++++++++
 8 files changed, 575 insertions(+), 1 deletion(-)
 create mode 100644 modules/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
 create mode 100644 modules/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
 create mode 100644 modules/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php

diff --git a/canvas_ai/canvas_ai.links.menu.yml b/canvas_ai/canvas_ai.links.menu.yml
index 3f77b376c..82f45338a 100644
--- a/canvas_ai/canvas_ai.links.menu.yml
+++ b/canvas_ai/canvas_ai.links.menu.yml
@@ -9,3 +9,7 @@ canvas_ai.setting:
   description: 'Set the max image upload size.'
   parent: ai.admin_settings
   route_name: canvas_ai.setting
+canvas_ai.theme_region_settings:
+  title: Canvas AI Theme Region Settings
+  parent: ai.admin_settings
+  route_name: canvas_ai.theme_region_settings
diff --git a/canvas_ai/canvas_ai.routing.yml b/canvas_ai/canvas_ai.routing.yml
index 9a66bb78a..10c8f34d0 100644
--- a/canvas_ai/canvas_ai.routing.yml
+++ b/canvas_ai/canvas_ai.routing.yml
@@ -14,7 +14,7 @@ canvas_ai.csrf_token:
     _method: 'POST'
 
 canvas_ai.component_description_settings:
-  path: '/admin/config/system/canvas-ai-component-description-settings'
+  path: '/admin/config/ai/canvas-ai-component-description-settings'
   defaults:
     _title: 'Canvas AI Component Description Settings Form'
     _form: 'Drupal\canvas_ai\Form\CanvasAiComponentDescriptionSettingsForm'
@@ -26,6 +26,12 @@ canvas_ai.setting:
   defaults:
     _title: 'Canvas AI Settings Form'
     _form: 'Drupal\canvas_ai\Form\CanvasAiSettingsForm'
+
+canvas_ai.theme_region_settings:
+  path: '/admin/config/ai/canvas-ai-theme-region-settings'
+  defaults:
+    _title: 'XB AI Theme Region Settings'
+    _form: 'Drupal\canvas_ai\Form\XBAIThemeRegionSettingsForm'
   requirements:
     _permission: 'use Drupal Canvas AI'
 
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
new file mode 100644
index 000000000..d0d868602
--- /dev/null
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -0,0 +1,125 @@
+langcode: en
+status: true
+dependencies:
+  enforced:
+    module:
+      - canvas_ai
+id: canvas_template_builder_agent
+label: 'Experience Builder Template Builder Agent'
+description: 'This sub-agent specializes in building templates for entire pages using available components. It can also be used to generate headers and footers for pages. Use it for all template-building requests where a complete page needs to be generated.'
+system_prompt: |-
+  You are an AI assistant specialized in creating complete web page templates by strategically placing available Components into designated regions. Your role encompasses creating page body content and optionally headers/footers when explicitly requested.
+
+  You are a looping agent meaning you can run multiple times till you get enough information to generate the required response and save the page template.
+
+  ## Core Responsibilities
+
+  ### 1. Component Placement Strategy
+  - **Primary Focus**: Place components in the 'content' region as the main page body structure
+  - **Minimum Content Requirement**: Generate minimum 5 well-structured sections for the page body
+  - **Region Restriction**: ONLY use the 'content' region for page body components unless explicitly asked by the user to use other regions
+  - **Header/Footer Generation**: Generate header and footer components ONLY when user explicitly requests to include header and footer
+  - **Standalone Header/Footer**: If the request is specifically for generating only header or only footer, generate ONLY that component without creating the complete template
+  - **Region Awareness**: When generating headers/footers, utilize respective header/footer regions if available, adapting to varying region names based on the active theme
+
+  ### 2. Component Selection and Configuration
+  - **Strict Adherence**: Only use components explicitly provided in the context
+  - **Component Type Filtering**: Never use header/footer-specific components when generating page body content
+  - **Deep Analysis**: Carefully study each component's description for:
+    - Usage guidelines and best practices
+    - Component variants, when and how to use
+    - Appropriate prop values and data types
+    - Slot component recommendations
+    - Available enum values for props
+    - Standalone vs. nested component usage patterns
+  - **Content Generation**: Create high-quality, professional, creative, production-ready content for all props
+
+  ### 3. Template Interpretation and Enhancement
+  - **Flexible Input Handling**: Work with both brief requests ("create a landing page for an IT agency") and detailed specifications
+  - **Creative Expansion**: For minimal prompts, intelligently design minimum 5 well-structured sections for page body
+  - **User Journey Focus**: Prioritize user engagement and logical content flow
+  - **Professional Standards**: Deliver production-ready templates with meaningful, contextual content
+
+  ### 4. Layout Integration
+  - **JSON Layout Processing**: Analyze provided layout information to understand available regions and their usage
+  - **Strategic Region Usage**: Make informed decisions about component placement across regions when explicitly requested
+
+  ## Content Guidelines
+  ### Text and Links
+  - **Link URLs**: Use "#" as default href value - do not generate actual URLs
+  - **Link Labels**: Create meaningful, contextual text for buttons and link components
+  - **Content Quality**: Generate professional, relevant content appropriate for the template purpose
+
+  ### Media and Styling
+  - **No Image URLs or Alt Text**: Never set src or alt text props.
+  - You may set image-specific layout/design props (like aspect_ratio) only if defined in the component.
+  - **HTML Attributes**: Do not generate values for props corresponding to HTML attributes (Eg: 'class', 'id')
+  - **Prop Restrictions**: Only use existing component props - never add custom props
+
+  ## Page Template Design Structure
+
+  ### Format Specification
+  Design the complete page template in YAML format following this structure:
+
+  ```yml
+  region_name:
+    - sdc_machine_name_1:
+        props:
+          prop_key_A: "value"
+          prop_key_B: true
+        slots:
+          slot_name_X:
+            - nested_sdc_machine_name_A:
+                props:
+                  # ...
+          slot_name_Y:
+            - nested_sdc_machine_name_B:
+                props:
+                  # ...
+    - sdc_machine_name_2:
+        # No props or slots
+  another_region:
+    - sdc_machine_name_3:
+        props:
+          # ...
+  ```
+  - Never add any comments in the yml.
+
+  ## OUTPUT RULES (MANDATORY)
+  - DO NOT return the YAML in your output.
+  - ALWAYS use the `set_template_data` tool to pass the YAML.
+  - The `set_template_data` tool will return a JSON structure corresponding to the YAML when the template data is successfully saved.
+  - Treat the successful JSON response from the tool as confirmation that the template has been saved correctly.
+  - If there are problems with the YAML reported by the tool, correct them and repeat the cycle until you receive the successful JSON response.
+  - AFTER receiving the successful JSON response from the tool, output a short summary message in 1-2 sentences in plain text.
+  - The summary should briefly mention the main components used and their purpose.
+  - Example output: "Created a product page template using hero section, feature cards, testimonials, pricing table, and CTA components for the main content."
+  - DO NOT add any YAML, explanation, or system messages.
+  - ONLY return the summary message.
+
+  ## Success Criteria
+
+  Your success is measured by creating templates that are:
+  - **Functionally Complete**: All components properly configured with meaningful content
+  - **User-Focused**: Designed with clear user journeys and engagement patterns
+  - **Contextually Appropriate**: Content and structure match the requested template purpose
+  - **Implementation Ready**: YAML output can be directly processed without modification
+  - **Content Rich**: Page body contains minimum 5 well-structured sections with professional content
+secured_system_prompt: '[ai_agent:agent_instructions]'
+tools:
+  'canvas_ai:set_template_data': true
+tool_settings:
+  'canvas_ai:set_template_data':
+    return_directly: 0
+orchestration_agent: false
+triage_agent: false
+max_loops: 10
+default_information_tools: "current_layout:\r\n  label: 'Current layout'\r\n  description: 'The current layout of the page is:'\r\n  tool: 'canvas_ai:get_current_layout'\r\n  parameters: {  }\r\navailable_components:\r\n  label: 'Available components'\r\n  description: 'These are the Components available to use'\r\n  tool: 'canvas_ai:get_component_context'\r\n  parameters: {  }\r\n"
+tool_usage_limits:
+  'canvas_ai:set_template_data':
+    component_structure:
+      action: ''
+      hide_property: 0
+      values: ''
+exclude_users_role: false
+masquerade_roles: {  }
diff --git a/canvas_ai/config/schema/canvas_ai.schema.yml b/canvas_ai/config/schema/canvas_ai.schema.yml
index 28dd23134..72ac19954 100644
--- a/canvas_ai/config/schema/canvas_ai.schema.yml
+++ b/canvas_ai/config/schema/canvas_ai.schema.yml
@@ -37,3 +37,15 @@ component_source_entry:
     data:
       type: text
       label: 'YAML string of components'
+
+xb_ai.theme_region.settings:
+  type: config_object
+  label: 'XB AI Theme Region Settings'
+  mapping:
+    region_descriptions:
+      type: mapping
+      label: 'Region Descriptions'
+      mapping:
+        '*':
+          type: text
+          label: 'Description'
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 25e2ca313..556baa461 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1191,6 +1191,147 @@ class CanvasAiPageBuilderHelper {
     return !empty($node[$slot_name]);
   }
 
+ /**
+   * Gets the region indices from the current layout.
+   *
+   * @param string $current_layout
+   *   The current layout JSON string.
+   *
+   * @return array
+   *   An array with region names as keys and their nodePathPrefix values.
+   */
+  public function getRegionIndex(string $current_layout): array {
+    $layout_array = Json::decode($current_layout);
+    $regions = [];
+
+    if (isset($layout_array['regions']) && is_array($layout_array['regions'])) {
+      foreach ($layout_array['regions'] as $region_name => $region_data) {
+        if (isset($region_data['nodePathPrefix'])) {
+          $regions[$region_name] = $region_data['nodePathPrefix'][0];
+        }
+      }
+    }
+
+    return $regions;
+  }
+
+  /**
+   * Gets the available regions from the current layout along with their descriptions, if configured.
+   *
+   * @param string $current_layout
+   *   The current layout JSON string.
+   *
+   * @return array
+   *   An array with region names as keys and their nodePathPrefix values and descriptions.
+   */
+  public function getAvailableRegions(string $current_layout) : array {
+    $region_index_mapping = $this->getRegionIndex($current_layout);
+    $region_descriptions = $this->configFactory->get('xb_ai.theme_region.settings')->get('region_descriptions') ?? [];
+    $available_regions = [];
+    foreach ($region_index_mapping as $region_name => $region_index) {
+      $available_regions[$region_name] = [
+        'nodePathPrefix' => $region_index,
+        'description' => $region_descriptions[$region_name] ?? '',
+      ];
+    }
+    return $available_regions;
+  }
+
+  /**
+   * Processes the parsed YAML array for UI representation.
+   *
+   * This function processes the yml generated by the template generation agent
+   * and converts it into a JSON structure that can be used in the UI.
+   *
+   * @param array $parsed_array
+   *   The parsed YAML array.
+   * @param string $current_layout
+   *   The current layout of the page.
+   */
+  public function processTemplateYmlForUi(array $parsed_array, string $current_layout): string {
+    $result = [
+      'operations' => [
+        [
+          'operation' => 'ADD',
+          'components' => [],
+        ],
+      ],
+    ];
+    $region_index_mapping = $this->getRegionIndex($current_layout);
+
+    $component_index = 0;
+    foreach ($parsed_array as $region => $components) {
+      if (!is_array($components)) {
+        continue;
+      }
+
+      $region_index = $region_index_mapping[$region] ?? 0;
+
+      foreach ($components as $index => $component) {
+        $this->processComponent($component, $region_index, $index, $result['operations'][0]['components'], $component_index);
+        $component_index++;
+      }
+    }
+
+    return Json::encode($result);
+  }
+
+  /**
+   * Recursively processes a component and its slots.
+   *
+   * @param array $component
+   *   The component data.
+   * @param int $region_index
+   *   The region index.
+   * @param int $component_index
+   *   The component index in the region.
+   * @param array $components
+   *   The array to store processed components.
+   * @param int $global_index
+   *   The global component index.
+   * @param array $parent_path
+   *   The parent node path.
+   */
+  protected function processComponent(array $component, int $region_index, int $component_index, array &$components, int &$global_index, array $parent_path = []): void {
+    foreach ($component as $component_type => $component_data) {
+      $node_path = empty($parent_path) ? [$region_index, $component_index] : array_merge($parent_path, [$component_index]);
+
+      $component_structure = [
+        'id' => $component_type,
+        'nodePath' => $node_path,
+        'fieldValues' => [],
+      ];
+
+      // Process props if they exist.
+      if (isset($component_data['props'])) {
+        $component_structure['fieldValues'] = $component_data['props'];
+      }
+
+      $components[] = $component_structure;
+      $global_index++;
+
+      // Process slots if they exist.
+      if (isset($component_data['slots'])) {
+        foreach ($component_data['slots'] as $slot_name => $slot_components) {
+          if (!is_array($slot_components)) {
+            continue;
+          }
+
+          foreach ($slot_components as $slot_index => $slot_component) {
+            $this->processComponent(
+              $slot_component,
+              $region_index,
+              $slot_index,
+              $components,
+              $global_index,
+              array_merge($node_path, [array_search($slot_name, array_keys($component_data['slots']))])
+            );
+          }
+        }
+      }
+    }
+  }
+
   /**
    * Generate verbose context for Orchestrator.
    *
diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
new file mode 100644
index 000000000..7c0a66435
--- /dev/null
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -0,0 +1,120 @@
+<?php
+
+declare(strict_types=1);
+
+namespace Drupal\canvas_ai\Form;
+
+use Drupal\Core\Form\ConfigFormBase;
+use Drupal\Core\Form\FormStateInterface;
+use Drupal\canvas\Entity\PageRegion;
+
+/**
+ * Configure Canvas AI settings for this site.
+ */
+final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
+
+  /**
+   * {@inheritdoc}
+   */
+  public function getFormId(): string {
+    return 'canvas_ai_theme_region_settings';
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  protected function getEditableConfigNames(): array {
+    return ['canvas_ai.theme_region.settings'];
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function buildForm(array $form, FormStateInterface $form_state): array {
+    $config = $this->config('canvas_ai.theme_region.settings');
+    $active_regions = $this->getActiveRegions();
+    $form['#tree'] = TRUE;
+
+    if (empty($active_regions)) {
+      $form['message'] = [
+        '#type' => 'markup',
+        '#markup' => $this->t('You dont have any global regions enabled in your theme.'),
+      ];
+      return $form;
+    }
+
+    $form['message'] = [
+      '#type' => 'markup',
+      '#markup' => $this->t('Use this form to give proper descriptions for all the Global regions, which will be used by AI to generate content for those regions.'),
+    ];
+
+    $descriptions = $config->get('region_descriptions') ?? [];
+
+    foreach ($active_regions as $region) {
+      $region_id = $this->getRegionId($region);
+      $form[$region_id] = [
+        '#type' => 'details',
+        '#title' => $region->label(),
+        '#open' => TRUE,
+      ];
+      $form[$region_id]['description'] = [
+        '#type' => 'textarea',
+        '#title' => $this->t('Description'),
+        '#description' => $this->t('Provide a description for what kind of content should be placed in this region.'),
+        '#default_value' => $descriptions[$region_id] ?? '',
+      ];
+    }
+
+    return parent::buildForm($form, $form_state);
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function submitForm(array &$form, FormStateInterface $form_state): void {
+    $active_regions = $this->getActiveRegions();
+
+    $descriptions = [];
+    foreach ($active_regions as $region) {
+      $region_id = $this->getRegionId($region);
+      $descriptions[$region_id] = $form_state->getValue([$region_id, 'description']);
+    }
+
+    $this->config('canvas_ai.theme_region.settings')
+      ->set('region_descriptions', $descriptions)
+      ->save();
+
+    parent::submitForm($form, $form_state);
+  }
+
+  /**
+   * Get active theme regions.
+   *
+   * @return array
+   *   An array of active theme regions.
+   */
+  protected function getActiveRegions(): array {
+    $regions = PageRegion::loadMultiple();
+    return array_filter($regions, fn($region) => $region->status());
+  }
+
+  /**
+   * Get region ID.
+   *
+   * @param \Drupal\canvas\Entity\PageRegion $region
+   *   The page region.
+   *
+   * @return string
+   *   The region ID.
+   */
+  protected function getRegionId(PageRegion $region): string {
+    $region_id = $region->id();
+    // Remove the theme prefix.
+    if (str_contains($region_id, '.')) {
+      $parts = explode('.', $region_id, 2);
+      return $parts[1] ?? $region_id;
+    }
+    return $region_id;
+  }
+
+}
diff --git a/canvas_ai/src/Hook/CanvasAiHooks.php b/canvas_ai/src/Hook/CanvasAiHooks.php
index be9c040f2..80c127022 100644
--- a/canvas_ai/src/Hook/CanvasAiHooks.php
+++ b/canvas_ai/src/Hook/CanvasAiHooks.php
@@ -79,6 +79,10 @@ class CanvasAiHooks {
             'name' => $this->t('JSON API Module status'),
             'description' => $this->t('Returns the status of JSON API module.'),
           ],
+          'available_regions' => [
+            'name' => $this->t('Available Regions'),
+            'description' => $this->t('Returns the available regions in experience builder.'),
+          ],
           'verbose_context_for_orchestrator' => [
             'name' => $this->t('Verbose Context for Orchestrator'),
             'description' => $this->t('Returns a detailed context summary for the AI Orchestrator.'),
@@ -146,6 +150,10 @@ class CanvasAiHooks {
             $replacements[$original] = $data['json_api_module_status'];
             break;
 
+          case 'available_regions':
+            $replacements[$original] = !empty($data['available_regions']) ? $data['available_regions'] : NULL;
+            break;
+
           case 'verbose_context_for_orchestrator':
             $replacements[$original] = !empty($data['verbose_context_for_orchestrator']) ? $data['verbose_context_for_orchestrator'] : NULL;
             break;
diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
new file mode 100644
index 000000000..e3ef0e6d4
--- /dev/null
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -0,0 +1,158 @@
+<?php
+
+namespace Drupal\canvas_ai\Plugin\AiFunctionCall;
+
+use Drupal\Core\Plugin\Context\ContextDefinition;
+use Drupal\Core\StringTranslation\TranslatableMarkup;
+use Drupal\ai\Attribute\FunctionCall;
+use Drupal\ai\Base\FunctionCallBase;
+use Drupal\ai\Service\FunctionCalling\ExecutableFunctionCallInterface;
+use Drupal\ai\Service\FunctionCalling\FunctionCallInterface;
+use Drupal\ai\Utility\ContextDefinitionNormalizer;
+use Drupal\ai_agents\PluginInterfaces\AiAgentContextInterface;
+use Drupal\Component\Serialization\Json;
+use Drupal\Component\Serialization\Yaml;
+use Symfony\Component\DependencyInjection\ContainerInterface;
+use Drupal\Core\Logger\LoggerChannelFactoryInterface;
+use Drupal\Core\Session\AccountProxyInterface;
+use Drupal\canvas_ai\AiResponseValidator;
+use Drupal\canvas_ai\CanvasAiPageBuilderHelper;
+use Drupal\canvas_ai\CanvasAiTempStore;
+
+/**
+ * Function call plugin to set the component structure generated by AI.
+ */
+#[FunctionCall(
+  id: 'canvas_ai:set_template_data',
+  function_name: 'set_template_data',
+  name: 'Set Template Data',
+  description: 'This tool is used to add components across various regions of the page to build the desired templates, headers, or footers. The component structure must be provided in valid YAML format.',
+  group: 'modification_tools',
+  context_definitions: [
+    'component_structure' => new ContextDefinition(
+      data_type: 'string',
+      label: new TranslatableMarkup("Component structure in yml format"),
+      description: new TranslatableMarkup("The component structure to store in YAML format."),
+      required: TRUE,
+    ),
+    'reference_component_nodepath' => new ContextDefinition(
+      data_type: 'string',
+      label: new TranslatableMarkup("The nodePath of the reference component"),
+      description: new TranslatableMarkup("The nodePath of the component after which the generated footer components must be placed."),
+      required: FALSE,
+    ),
+  ],
+)]
+final class SetAIGeneratedTemplateData extends FunctionCallBase implements ExecutableFunctionCallInterface, AiAgentContextInterface {
+
+  /**
+   * The Canvas page builder helper service.
+   *
+   * @var \Drupal\canvas_ai\CanvasAiPageBuilderHelper
+   */
+  protected CanvasAiPageBuilderHelper $pageBuilderHelper;
+
+  /**
+   * The logger factory.
+   *
+   * @var \Drupal\Core\Logger\LoggerChannelFactoryInterface
+   */
+  protected LoggerChannelFactoryInterface $loggerFactory;
+
+  /**
+   * The current user.
+   *
+   * @var \Drupal\Core\Session\AccountProxyInterface
+   */
+  protected AccountProxyInterface $currentUser;
+
+  /**
+   * The Canvas AI temp store service.
+   *
+   * @var \Drupal\canvas_ai\CanvasAiTempStore
+   */
+  protected CanvasAiTempStore $tempStore;
+
+  /**
+   * The AI response validator service.
+   *
+   * @var \Drupal\canvas_ai\AiResponseValidator
+   */
+  protected AiResponseValidator $responseValidator;
+
+  /**
+   * Load from dependency injection container.
+   */
+  public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition): FunctionCallInterface | static {
+    $instance = new static(
+      $configuration,
+      $plugin_id,
+      $plugin_definition,
+      new ContextDefinitionNormalizer(),
+    );
+    $instance->pageBuilderHelper = $container->get('canvas_ai.page_builder_helper');
+    $instance->loggerFactory = $container->get('logger.factory');
+    $instance->currentUser = $container->get('current_user');
+    $instance->tempStore = $container->get('canvas_ai.tempstore');
+    $instance->responseValidator = $container->get('canvas_ai.response_validator');
+    return $instance;
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function execute(): void {
+    // Make sure that the user has the right permissions.
+    if (!$this->currentUser->hasPermission('use experience builder ai')) {
+      throw new \Exception('The current user does not have the right permissions to run this tool.');
+    }
+    try {
+      // Get reference component uuid.
+      $reference_nodepath = !empty($this->getContextValue('reference_component_nodepath')) ? $this->getContextValue('reference_component_nodepath') : [];
+      // Convert the reference nodepath to an array.
+      if (!is_array($reference_nodepath)) {
+        $reference_nodepath = Json::decode($reference_nodepath);
+      }
+      // If reference nodepath is provided, ensure that it is valid by checking
+      // if there are even number of elements.
+      if (!empty($reference_nodepath) && count($reference_nodepath) % 2 !== 0) {
+        throw new \Exception(sprintf('The reference nodepath %s is incomplete and missing elements. Provide the complete nodepath from current layout.', implode(', ', $reference_nodepath)));
+      }
+      $component_structure = $this->getContextValue('component_structure');
+      // Try to decode the YAML structure.
+      try {
+        $component_structure_array = Yaml::decode($component_structure);
+      }
+      catch (\Exception $e) {
+        throw new \Exception('Invalid YAML format provided.');
+      }
+
+      // Validate if regions are correct.
+      $current_layout = $this->tempStore->getData(CanvasAiTempStore::CURRENT_LAYOUT_KEY) ?? '';
+      $layout_regions = $this->pageBuilderHelper->getRegionIndex($current_layout);
+      foreach (array_keys($component_structure_array) as $region) {
+        if (!array_key_exists($region, $layout_regions)) {
+          $available_regions = implode(', ', array_keys($layout_regions));
+          throw new \Exception(sprintf(
+            'Region "%s" does not exist. Available regions are: %s.',
+            $region,
+            $available_regions
+          ));
+        }
+      }
+
+      // Validate the component structure for each region.
+      foreach ($component_structure_array as $components) {
+        $this->responseValidator->validateComponentStructure($components);
+      }
+      // Process the YAML structure for UI representation.
+      $processed_structure = $this->pageBuilderHelper->processTemplateYmlForUi($component_structure_array, $current_layout, $reference_nodepath);
+      $this->setOutput($processed_structure);
+    }
+    catch (\Exception $e) {
+      $this->loggerFactory->get('canvas_ai')->error($e->getMessage());
+      $this->setOutput(sprintf('Failed to save: %s', $e->getMessage()));
+    }
+  }
+
+}
-- 
GitLab


From b9c3e5e4e99e804fdea4e34e60381078f7f39f0d Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:31:36 +0530
Subject: [PATCH 02/50] Resolve merge conflicts

---
 ...ai_agent.canvas_template_builder_agent.yml | 42 +++++++++++++++++--
 .../src/CanvasAiPageBuilderHelper.php         | 26 ++++++++----
 .../Form/CanvasAIThemeRegionSettingsForm.php  |  2 +-
 3 files changed, 57 insertions(+), 13 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index d0d868602..6d56e7dce 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -20,7 +20,7 @@ system_prompt: |-
   - **Region Restriction**: ONLY use the 'content' region for page body components unless explicitly asked by the user to use other regions
   - **Header/Footer Generation**: Generate header and footer components ONLY when user explicitly requests to include header and footer
   - **Standalone Header/Footer**: If the request is specifically for generating only header or only footer, generate ONLY that component without creating the complete template
-  - **Region Awareness**: When generating headers/footers, utilize respective header/footer regions if available, adapting to varying region names based on the active theme
+  - **Region Awareness**: When generating headers/footers, utilize respective header/footer or any similar regions if available, adapting to varying region names based on the active theme. If no dedicated regions are available, use the 'content' region.
 
   ### 2. Component Selection and Configuration
   - **Strict Adherence**: Only use components explicitly provided in the context
@@ -44,11 +44,38 @@ system_prompt: |-
   - **JSON Layout Processing**: Analyze provided layout information to understand available regions and their usage
   - **Strategic Region Usage**: Make informed decisions about component placement across regions when explicitly requested
 
+  ## Template Tool Configuration
+
+  ### Tool Parameters
+  The `set_template_data` tool has two inputs:
+  1. `component_structure` - the YAML template structure
+  2. `reference_component_nodepath` - for specific footer placement scenarios
+
+  ### Reference Component Nodepath Usage
+  This parameter should be used ONLY when ALL three conditions are met:
+  1. **Request Type**: The request is specifically for generating footer components only
+  2. **Region Limitation**: The current layout has only the 'content' region available (no dedicated footer region)
+  3. **Existing Content**: The content region already contains components from previous placements
+
+  ### Implementation Logic
+  When these conditions are met:
+  - Analyze existing components in the current layout
+  - **Specifically look for components with nodepath containing exactly 2 elements** (e.g., [0, 5], [0, 7])
+  - **Identify the component with the highest second element value** among these 2-element nodepaths
+  - Use that component's nodepath as the `reference_component_nodepath`
+  - This ensures footer components are placed after the last main page body component
+
+  #### Example:
+  If existing components have nodepaths like [0, 3], [0, 5], [0, 7], [0, 7, 1], [0, 2], the reference should be `[0, 7]` since it has the highest second element value (7) among the 2-element nodepaths.
+
+  ### Default Behavior
+  In all other scenarios, leave the `reference_component_nodepath` field empty, as the default top-to-bottom placement will work correctly.
+
   ## Content Guidelines
   ### Text and Links
-  - **Link URLs**: Use "#" as default href value - do not generate actual URLs
-  - **Link Labels**: Create meaningful, contextual text for buttons and link components
-  - **Content Quality**: Generate professional, relevant content appropriate for the template purpose
+  - **Link URLs**:  If the link's format is `uri-reference`, use `{ "uri": value, "options": [] }`; otherwise, use `href: "#"` unless the user explicitly requests a specific URL.
+  - **Link Labels**: Create meaningful, contextual text for buttons and link components.
+  - **Content Quality**: Generate professional, relevant content appropriate for the template purpose.
 
   ### Media and Styling
   - **No Image URLs or Alt Text**: Never set src or alt text props.
@@ -105,6 +132,9 @@ system_prompt: |-
   - **Contextually Appropriate**: Content and structure match the requested template purpose
   - **Implementation Ready**: YAML output can be directly processed without modification
   - **Content Rich**: Page body contains minimum 5 well-structured sections with professional content
+
+  ## Available regions
+  [xb_ai:available_regions]
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_template_data': true
@@ -121,5 +151,9 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
+    reference_component_nodepath:
+      action: ''
+      hide_property: 0
+      values: ''
 exclude_users_role: false
 masquerade_roles: {  }
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 556baa461..7047b1825 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1247,8 +1247,10 @@ class CanvasAiPageBuilderHelper {
    *   The parsed YAML array.
    * @param string $current_layout
    *   The current layout of the page.
+   * @param array $reference_nodepath
+   *   The nodepath of the reference component, if any.
    */
-  public function processTemplateYmlForUi(array $parsed_array, string $current_layout): string {
+  public function processTemplateYmlForUi(array $parsed_array, string $current_layout, array $reference_nodepath = []): string {
     $result = [
       'operations' => [
         [
@@ -1257,19 +1259,27 @@ class CanvasAiPageBuilderHelper {
         ],
       ],
     ];
-    $region_index_mapping = $this->getRegionIndex($current_layout);
-
-    $component_index = 0;
     foreach ($parsed_array as $region => $components) {
       if (!is_array($components)) {
         continue;
       }
 
-      $region_index = $region_index_mapping[$region] ?? 0;
+      // If reference nodepath is given, calculate the nodepath of other components
+      // based on it.
+      if ($reference_nodepath) {
+        $this->processComponentsBelow($parsed_array, $reference_nodepath, $result['operations'][0]['components']);
+      }
+      else {
+        $region_index_mapping = $this->getRegionIndex($current_layout);
 
-      foreach ($components as $index => $component) {
-        $this->processComponent($component, $region_index, $index, $result['operations'][0]['components'], $component_index);
-        $component_index++;
+        $component_index = 0;
+
+        $region_index = $region_index_mapping[$region] ?? 0;
+
+        foreach ($components as $index => $component) {
+          $this->processComponent($component, $region_index, $index, $result['operations'][0]['components'], $component_index);
+          $component_index++;
+        }
       }
     }
 
diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index 7c0a66435..ba386888d 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -38,7 +38,7 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
     if (empty($active_regions)) {
       $form['message'] = [
         '#type' => 'markup',
-        '#markup' => $this->t('You dont have any global regions enabled in your theme.'),
+        '#markup' => $this->t('You don\'t have any global regions enabled in your theme.'),
       ];
       return $form;
     }
-- 
GitLab


From 534079d25b9d38090e78cc67d88e2b8d81fd9c04 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 28 Jul 2025 17:23:16 +0530
Subject: [PATCH 03/50] Issues/3533079: Fix pipeline issues.

---
 modules/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index ba386888d..e0732de4d 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -38,7 +38,7 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
     if (empty($active_regions)) {
       $form['message'] = [
         '#type' => 'markup',
-        '#markup' => $this->t('You don\'t have any global regions enabled in your theme.'),
+        '#markup' => $this->t("You don't have any global regions enabled in your theme."),
       ];
       return $form;
     }
-- 
GitLab


From 65cf86863c855a203e391cda8d78fe8d7bd3d8a5 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 28 Jul 2025 19:42:03 +0530
Subject: [PATCH 04/50] Issues/3533079: Fix pipeline issues.

---
 modules/canvas_ai/src/CanvasAiPageBuilderHelper.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 7047b1825..3014a5455 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1267,7 +1267,7 @@ class CanvasAiPageBuilderHelper {
       // If reference nodepath is given, calculate the nodepath of other components
       // based on it.
       if ($reference_nodepath) {
-        $this->processComponentsBelow($parsed_array, $reference_nodepath, $result['operations'][0]['components']);
+        $this->processComponentsBelow($components, $reference_nodepath, $result['operations'][0]['components']);
       }
       else {
         $region_index_mapping = $this->getRegionIndex($current_layout);
-- 
GitLab


From 8314530e6a9d3cc030a510602daf95738da1825c Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 11 Nov 2025 13:09:32 +0530
Subject: [PATCH 05/50] Resolve merge conflicts

---
 ...ents.ai_agent.canvas_template_builder_agent.yml | 14 ++++++++++++--
 modules/canvas_ai/src/Controller/CanvasBuilder.php |  2 +-
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 6d56e7dce..f891bf602 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -134,7 +134,7 @@ system_prompt: |-
   - **Content Rich**: Page body contains minimum 5 well-structured sections with professional content
 
   ## Available regions
-  [xb_ai:available_regions]
+  [canvas_ai:available_regions]
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_template_data': true
@@ -144,7 +144,17 @@ tool_settings:
 orchestration_agent: false
 triage_agent: false
 max_loops: 10
-default_information_tools: "current_layout:\r\n  label: 'Current layout'\r\n  description: 'The current layout of the page is:'\r\n  tool: 'canvas_ai:get_current_layout'\r\n  parameters: {  }\r\navailable_components:\r\n  label: 'Available components'\r\n  description: 'These are the Components available to use'\r\n  tool: 'canvas_ai:get_component_context'\r\n  parameters: {  }\r\n"
+default_information_tools: |
+  current_layout:
+    label: 'Current layout'
+    description: 'The current layout of the page is:'
+    tool: 'canvas_ai:get_current_layout'
+    parameters: {  }
+  available_components:
+    label: 'Available components'
+    description: 'These are the Components available to use'
+    tool: 'canvas_ai:get_component_context'
+    parameters: {  }
 tool_usage_limits:
   'canvas_ai:set_template_data':
     component_structure:
diff --git a/canvas_ai/src/Controller/CanvasBuilder.php b/canvas_ai/src/Controller/CanvasBuilder.php
index d581afd95..49340f3e6 100644
--- a/canvas_ai/src/Controller/CanvasBuilder.php
+++ b/canvas_ai/src/Controller/CanvasBuilder.php
@@ -264,7 +264,7 @@ final class CanvasBuilder extends ControllerBase {
           if ($tool instanceof AiAgentWrapper) {
             $response['message'] = $tool->getReadableOutput();
           }
-          if ($tool->getPluginId() === 'ai_agents::ai_agent::canvas_page_builder_agent') {
+          if (in_array($tool->getPluginId(), ['ai_agents::ai_agent::canvas_ai_template_builder_agent', 'ai_agents::ai_agent::canvas_ai_page_builder_agent'])) {
             $this->canvasAiTempStore->deleteData(CanvasAiTempStore::CURRENT_LAYOUT_KEY);
           }
         }
-- 
GitLab


From 647e52c8c3e443f4f0dd9035f107055640e2dcc9 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 3 Nov 2025 16:47:44 +0530
Subject: [PATCH 06/50] Resolve merge conflicts.

---
 .../SetAIGeneratedTemplateDataTest.php        | 295 ++++++++++++++++++
 1 file changed, 295 insertions(+)
 create mode 100644 modules/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
new file mode 100644
index 000000000..4833055db
--- /dev/null
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -0,0 +1,295 @@
+<?php
+
+declare(strict_types=1);
+
+namespace Drupal\Tests\canvas_ai\Kernel\Plugin\AiFunctionCall;
+
+use Drupal\ai\Service\FunctionCalling\ExecutableFunctionCallInterface;
+use Drupal\Core\Session\AccountInterface;
+use Drupal\KernelTests\KernelTestBase;
+use Drupal\Tests\user\Traits\UserCreationTrait;
+use Drupal\user\Entity\User;
+use Drupal\canvas_ai\CanvasAiPageBuilderHelper;
+use Drupal\canvas_ai\CanvasAiTempStore;
+
+/**
+ * Tests for the SetAIGeneratedTemplateData function call plugin.
+ *
+ * @group canvas_ai
+ */
+final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
+
+  use UserCreationTrait;
+
+  /**
+   * The function call plugin manager.
+   *
+   * @var \Drupal\Component\Plugin\PluginManagerInterface
+   */
+  protected $functionCallManager;
+
+  /**
+   * A test user with AI permissions.
+   *
+   * @var \Drupal\Core\Session\AccountInterface
+   */
+  protected AccountInterface $privilegedUser;
+
+  /**
+   * A test user without AI permissions.
+   *
+   * @var \Drupal\Core\Session\AccountInterface
+   */
+  protected AccountInterface $unprivilegedUser;
+
+  /**
+   * The Canvas AI temp store service mock.
+   *
+   * @var \Drupal\canvas_ai\CanvasAiTempStore|\PHPUnit\Framework\MockObject\MockObject
+   */
+  protected $mockTempStore;
+
+  /**
+   * The mock page builder helper.
+   *
+   * @var \Drupal\canvas_ai\CanvasAiPageBuilderHelper|\PHPUnit\Framework\MockObject\MockObject
+   */
+  protected $pageBuilderHelper;
+
+  /**
+   * {@inheritdoc}
+   */
+  protected static $modules = [
+    'ai',
+    'ai_agents',
+    'experience_builder',
+    'system',
+    'user',
+    'canvas_ai',
+  ];
+
+  /**
+   * {@inheritdoc}
+   */
+  protected function setUp(): void {
+    parent::setUp();
+    $this->installEntitySchema('user');
+
+    $this->functionCallManager = $this->container->get('plugin.manager.ai.function_calls');
+    $privileged_user = $this->createUser(['use experience builder ai']);
+    $unprivileged_user = $this->createUser();
+    if (!$privileged_user instanceof User || !$unprivileged_user instanceof User) {
+      throw new \Exception('Failed to create test users');
+    }
+    $this->privilegedUser = $privileged_user;
+    $this->unprivilegedUser = $unprivileged_user;
+
+    $this->mockTempStore = $this->createMock(CanvasAiTempStore::class);
+    $this->container->set('canvas_ai.tempstore', $this->mockTempStore);
+
+    $this->pageBuilderHelper = $this->createPageBuilderMock();
+    $this->container->set('canvas_ai.page_builder_helper', $this->pageBuilderHelper);
+  }
+
+  /**
+   * Creates a mock PageBuilderHelper.
+   */
+  protected function createPageBuilderMock(): CanvasAiPageBuilderHelper {
+    $mock_helper = $this->getMockBuilder(CanvasAiPageBuilderHelper::class)
+      ->disableOriginalConstructor()
+      ->onlyMethods(['getComponentContextForAi'])
+      ->getMock();
+
+    // Mock component context data.
+    $component_context_yaml = <<<YAML
+sdc.xb_test_sdc.card:
+  id: sdc.xb_test_sdc.card
+  name: Card
+  description: Card component
+  group: ''
+  props:
+    title:
+      name: Title
+      description: Card title
+      type: string
+      default: ''
+    content:
+      name: Content
+      description: Card content
+      type: string
+      default: ''
+sdc.xb_test_sdc.text:
+  id: sdc.xb_test_sdc.text
+  name: Text
+  description: Text component
+  group: ''
+  props:
+    text:
+      name: Text
+      description: Text content
+      type: string
+      default: ''
+YAML;
+
+    $mock_helper->expects($this->any())
+      ->method('getComponentContextForAi')
+      ->willReturn($component_context_yaml);
+
+    return $mock_helper;
+  }
+
+  /**
+   * Tests the tool output.
+   */
+  public function testSetTemplateDataTool(): void {
+    $this->container->get('current_user')->setAccount($this->privilegedUser);
+
+    $valid_yaml = <<<YAML
+content:
+  - sdc.xb_test_sdc.card:
+      props:
+        title: 'Test Card'
+        content: 'Test content'
+sidebar:
+  - sdc.xb_test_sdc.text:
+      props:
+        text: 'Sidebar text'
+YAML;
+
+    $mock_layout = [
+      "layout" => [
+        "content" => [
+          "nodePathPrefix" => [0],
+          "components" => []
+        ],
+        "sidebar" => [
+          "nodePathPrefix" => [1],
+          "components" => []
+        ]
+      ]
+    ];
+    $layout_json = \json_encode($mock_layout);
+
+    $this->mockTempStore->expects($this->once())
+      ->method('getData')
+      ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
+      ->willReturn($layout_json);
+
+    $expected_output = [
+      'operations' => [
+        [
+          'operation' => 'ADD',
+          'components' => [
+            [
+              'id' => 'sdc.xb_test_sdc.card',
+              'nodePath' => [0, 0],
+              'fieldValues' => [
+                'title' => 'Test Card',
+                'content' => 'Test content',
+              ],
+            ],
+            [
+              'id' => 'sdc.xb_test_sdc.text',
+              'nodePath' => [1, 0],
+              'fieldValues' => [
+                'text' => 'Sidebar text',
+              ],
+            ],
+          ],
+        ],
+      ],
+    ];
+
+    $tool = $this->functionCallManager->createInstance('canvas_ai:set_template_data');
+    $this->assertInstanceOf(ExecutableFunctionCallInterface::class, $tool);
+
+    $tool->setContextValue('component_structure', $valid_yaml);
+    $tool->execute();
+
+    $result = $tool->getReadableOutput();
+    $this->assertEquals(
+      json_encode($expected_output),
+      $result,
+      "The component structure was not processed correctly"
+    );
+  }
+
+  /**
+   * Tests the tool output when reference nodepath is given.
+   */
+  public function testSetTemplateDataToolWithReferenceNodepath(): void {
+    $this->container->get('current_user')->setAccount($this->privilegedUser);
+
+    $valid_yaml = <<<YAML
+content:
+  - sdc.xb_test_sdc.card:
+      props:
+        title: 'Test Card'
+        content: 'Test content'
+  - sdc.xb_test_sdc.text:
+      props:
+        text: 'Sidebar text'
+YAML;
+
+    $mock_layout = [
+      "layout" => [
+        "content" => [
+          "nodePathPrefix" => [0],
+          "components" => [
+            [
+              "name" => "sdc.xb_test_sdc.card",
+              "uuid" => "9cadf75e-7116-444a-9d05-e3c86483d178",
+              "nodePath" => [0, 0]
+            ],
+            [
+              "name" => "sdc.xb_test_sdc.card",
+              "uuid" => "ab9b70d7-554d-421a-8303-725f4f6a6b9c",
+              "nodePath" => [0, 1]
+            ]]
+        ],
+      ]
+    ];
+
+    $this->mockTempStore->expects($this->once())
+      ->method('getData')
+      ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
+      ->willReturn(\json_encode($mock_layout));
+
+    $expected_output = [
+      'operations' => [
+        [
+          'operation' => 'ADD',
+          'components' => [
+            [
+              'id' => 'sdc.xb_test_sdc.card',
+              'nodePath' => [0, 2],
+              'fieldValues' => [
+                'title' => 'Test Card',
+                'content' => 'Test content',
+              ],
+            ],
+            [
+              'id' => 'sdc.xb_test_sdc.text',
+              'nodePath' => [0, 3],
+              'fieldValues' => [
+                'text' => 'Sidebar text',
+              ],
+            ],
+          ],
+        ],
+      ],
+    ];
+
+    $tool = $this->functionCallManager->createInstance('canvas_ai:set_template_data');
+    $this->assertInstanceOf(ExecutableFunctionCallInterface::class, $tool);
+
+    $tool->setContextValue('component_structure', $valid_yaml);
+    // Set the reference nodepath.
+    $tool->setContextValue('reference_component_nodepath', [0, 1]);
+    $tool->execute();
+
+    $result = $tool->getReadableOutput();
+    $this->assertEquals(\json_encode($expected_output), $result);
+  }
+
+}
-- 
GitLab


From 213a1a25739026e601420384b0f776cd0b63b7d1 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 12 Aug 2025 17:45:36 +0530
Subject: [PATCH 07/50] Fix phpcs

---
 .../SetAIGeneratedTemplateDataTest.php          | 17 +++++++++--------
 1 file changed, 9 insertions(+), 8 deletions(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 4833055db..b02afcce8 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -160,13 +160,13 @@ YAML;
       "layout" => [
         "content" => [
           "nodePathPrefix" => [0],
-          "components" => []
+          "components" => [],
         ],
         "sidebar" => [
           "nodePathPrefix" => [1],
-          "components" => []
-        ]
-      ]
+          "components" => [],
+        ],
+      ],
     ];
     $layout_json = \json_encode($mock_layout);
 
@@ -239,15 +239,16 @@ YAML;
             [
               "name" => "sdc.xb_test_sdc.card",
               "uuid" => "9cadf75e-7116-444a-9d05-e3c86483d178",
-              "nodePath" => [0, 0]
+              "nodePath" => [0, 0],
             ],
             [
               "name" => "sdc.xb_test_sdc.card",
               "uuid" => "ab9b70d7-554d-421a-8303-725f4f6a6b9c",
-              "nodePath" => [0, 1]
-            ]]
+              "nodePath" => [0, 1],
+            ],
+          ],
         ],
-      ]
+      ],
     ];
 
     $this->mockTempStore->expects($this->once())
-- 
GitLab


From 640e9db4d1a09275b6c58a9bd044e1fa652ca5b2 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 29 Sep 2025 15:26:38 +0530
Subject: [PATCH 08/50] Resolve merge conflicts'

---
 ...ai_agent.canvas_template_builder_agent.yml | 33 ++++++++++++-------
 1 file changed, 22 insertions(+), 11 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index f891bf602..96ebc8f19 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -71,17 +71,28 @@ system_prompt: |-
   ### Default Behavior
   In all other scenarios, leave the `reference_component_nodepath` field empty, as the default top-to-bottom placement will work correctly.
 
-  ## Content Guidelines
-  ### Text and Links
-  - **Link URLs**:  If the link's format is `uri-reference`, use `{ "uri": value, "options": [] }`; otherwise, use `href: "#"` unless the user explicitly requests a specific URL.
-  - **Link Labels**: Create meaningful, contextual text for buttons and link components.
-  - **Content Quality**: Generate professional, relevant content appropriate for the template purpose.
-
-  ### Media and Styling
-  - **No Image URLs or Alt Text**: Never set src or alt text props.
-  - You may set image-specific layout/design props (like aspect_ratio) only if defined in the component.
-  - **HTML Attributes**: Do not generate values for props corresponding to HTML attributes (Eg: 'class', 'id')
-  - **Prop Restrictions**: Only use existing component props - never add custom props
+  ## Content and Prop Value Guidelines
+
+  ### Prop Setting Logic
+  Follow this step-by-step logic for every prop of every component:
+
+  **1. Default Prop Formatting:**
+  - By default, set prop values in the standard `prop_name: "value"` format.
+  - Generate professional, relevant content appropriate for the template's purpose.
+  - Create meaningful, contextual text for all text-based props, including buttons and link labels.
+
+  **2. Conditional Formatting for URL/Link Props:**
+  - When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'.  If the user provides a specific URL, use that instead of `"https://example.com"`
+
+  **3. Strict Omission of Image Source Props (CRITICAL):**
+  - Any prop related to an image source or alternative text (e.g., `src`, `alt`, `image_source`, `image_alt`) **MUST be completely omitted** from the YAML output.
+  - DO NOT include these props at all.
+  - You MAY set image-related *styling* or *layout* props if they are defined in the component (e.g., `aspect_ratio`, `image_position`).
+
+  **4. General Prop Restrictions:**
+  - **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
+  - **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
+  - **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
 
   ## Page Template Design Structure
 
-- 
GitLab


From 1e9a8b7587185cc25547274c4da87a1aba715f4a Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 3 Nov 2025 16:55:51 +0530
Subject: [PATCH 09/50] Resolve merge conflicts.

---
 modules/canvas_ai/canvas_ai.routing.yml                       | 4 ++--
 .../ai_agents.ai_agent.canvas_template_builder_agent.yml      | 2 +-
 modules/canvas_ai/config/schema/canvas_ai.schema.yml          | 4 ++--
 3 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/canvas_ai/canvas_ai.routing.yml b/canvas_ai/canvas_ai.routing.yml
index 10c8f34d0..38b9a84bd 100644
--- a/canvas_ai/canvas_ai.routing.yml
+++ b/canvas_ai/canvas_ai.routing.yml
@@ -30,8 +30,8 @@ canvas_ai.setting:
 canvas_ai.theme_region_settings:
   path: '/admin/config/ai/canvas-ai-theme-region-settings'
   defaults:
-    _title: 'XB AI Theme Region Settings'
-    _form: 'Drupal\canvas_ai\Form\XBAIThemeRegionSettingsForm'
+    _title: 'Canvas AI Theme Region Settings'
+    _form: 'Drupal\canvas_ai\Form\CanvasAIThemeRegionSettingsForm'
   requirements:
     _permission: 'use Drupal Canvas AI'
 
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 96ebc8f19..d73214eb2 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -5,7 +5,7 @@ dependencies:
     module:
       - canvas_ai
 id: canvas_template_builder_agent
-label: 'Experience Builder Template Builder Agent'
+label: 'Canvas Template Builder Agent'
 description: 'This sub-agent specializes in building templates for entire pages using available components. It can also be used to generate headers and footers for pages. Use it for all template-building requests where a complete page needs to be generated.'
 system_prompt: |-
   You are an AI assistant specialized in creating complete web page templates by strategically placing available Components into designated regions. Your role encompasses creating page body content and optionally headers/footers when explicitly requested.
diff --git a/canvas_ai/config/schema/canvas_ai.schema.yml b/canvas_ai/config/schema/canvas_ai.schema.yml
index 72ac19954..db8a120d8 100644
--- a/canvas_ai/config/schema/canvas_ai.schema.yml
+++ b/canvas_ai/config/schema/canvas_ai.schema.yml
@@ -38,9 +38,9 @@ component_source_entry:
       type: text
       label: 'YAML string of components'
 
-xb_ai.theme_region.settings:
+canvas_ai.theme_region.settings:
   type: config_object
-  label: 'XB AI Theme Region Settings'
+  label: 'Canvas AI Theme Region Settings'
   mapping:
     region_descriptions:
       type: mapping
-- 
GitLab


From 41cca7a3312f64a7a4fd1cd37769244bcc608b92 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 8 Sep 2025 09:45:33 +0530
Subject: [PATCH 10/50] Rebase + phpstan fix

---
 .../Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php    | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index b02afcce8..5ae2cb12f 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -52,7 +52,7 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
   /**
    * The mock page builder helper.
    *
-   * @var \Drupal\canvas_ai\CanvasAiPageBuilderHelper|\PHPUnit\Framework\MockObject\MockObject
+   * @var \Drupal\canvas_ai\CanvasAiPageBuilderHelper
    */
   protected $pageBuilderHelper;
 
-- 
GitLab


From 2c72664c9c9539d86bb30fd0fbebb2eca79ba08c Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 29 Sep 2025 15:36:37 +0530
Subject: [PATCH 11/50] Update template builder agent comfig

---
 .../ai_agents.ai_agent.canvas_template_builder_agent.yml     | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index d73214eb2..37333bb07 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -152,6 +152,9 @@ tools:
 tool_settings:
   'canvas_ai:set_template_data':
     return_directly: 0
+    description_override: ''
+    progress_message: ''
+    use_artifacts: 0
 orchestration_agent: false
 triage_agent: false
 max_loops: 10
@@ -178,3 +181,5 @@ tool_usage_limits:
       values: ''
 exclude_users_role: false
 masquerade_roles: {  }
+structured_output_enabled: false
+structured_output_schema: ''
-- 
GitLab


From 45b2f8e47c99885573e5b62e3d8386674462e0ef Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 29 Sep 2025 16:21:41 +0530
Subject: [PATCH 12/50] Update template builder prompt to place image props.

---
 ...ai_agent.canvas_template_builder_agent.yml | 32 ++++++++++++++-----
 1 file changed, 24 insertions(+), 8 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 37333bb07..d20c094cf 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -82,12 +82,25 @@ system_prompt: |-
   - Create meaningful, contextual text for all text-based props, including buttons and link labels.
 
   **2. Conditional Formatting for URL/Link Props:**
-  - When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'.  If the user provides a specific URL, use that instead of `"https://example.com"`
-
-  **3. Strict Omission of Image Source Props (CRITICAL):**
-  - Any prop related to an image source or alternative text (e.g., `src`, `alt`, `image_source`, `image_alt`) **MUST be completely omitted** from the YAML output.
-  - DO NOT include these props at all.
-  - You MAY set image-related *styling* or *layout* props if they are defined in the component (e.g., `aspect_ratio`, `image_position`).
+  - When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
+
+  **3. Strict Image Prop Handling (CRITICAL):**
+  - When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
+  - Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
+  - **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
+  - **DO NOT** change, omit, or add any keys or values.
+  - **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
+  - **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
+  - **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
+
+  **Correct Example:**
+  ```yaml
+  props:
+    banner_image:
+      src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
+      alt: "A good dog"
+      width: 601
+      height: 402
 
   **4. General Prop Restrictions:**
   - **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
@@ -98,13 +111,16 @@ system_prompt: |-
 
   ### Format Specification
   Design the complete page template in YAML format following this structure:
-
   ```yml
   region_name:
     - sdc_machine_name_1:
         props:
           prop_key_A: "value"
-          prop_key_B: true
+          image_prop:
+            src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
+            alt: "A good dog"
+            width: 601
+            height: 402
         slots:
           slot_name_X:
             - nested_sdc_machine_name_A:
-- 
GitLab


From 07951ab1fa1929948ae0f2e9fc08b35b1f968a00 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 29 Sep 2025 16:40:57 +0530
Subject: [PATCH 13/50] Remove unwanted references to xb

---
 .../src/CanvasAiPageBuilderHelper.php         |  2 +-
 .../SetAIGeneratedTemplateDataTest.php        | 28 +++++++++----------
 2 files changed, 15 insertions(+), 15 deletions(-)

diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 3014a5455..7365a83c8 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1226,7 +1226,7 @@ class CanvasAiPageBuilderHelper {
    */
   public function getAvailableRegions(string $current_layout) : array {
     $region_index_mapping = $this->getRegionIndex($current_layout);
-    $region_descriptions = $this->configFactory->get('xb_ai.theme_region.settings')->get('region_descriptions') ?? [];
+    $region_descriptions = $this->configFactory->get('canvas_ai.theme_region.settings')->get('region_descriptions') ?? [];
     $available_regions = [];
     foreach ($region_index_mapping as $region_name => $region_index) {
       $available_regions[$region_name] = [
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 5ae2cb12f..0c9e19bb5 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -102,8 +102,8 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
 
     // Mock component context data.
     $component_context_yaml = <<<YAML
-sdc.xb_test_sdc.card:
-  id: sdc.xb_test_sdc.card
+sdc.canvas_test_sdc.card:
+  id: sdc.canvas_test_sdc.card
   name: Card
   description: Card component
   group: ''
@@ -118,8 +118,8 @@ sdc.xb_test_sdc.card:
       description: Card content
       type: string
       default: ''
-sdc.xb_test_sdc.text:
-  id: sdc.xb_test_sdc.text
+sdc.canvas_test_sdc.text:
+  id: sdc.canvas_test_sdc.text
   name: Text
   description: Text component
   group: ''
@@ -146,12 +146,12 @@ YAML;
 
     $valid_yaml = <<<YAML
 content:
-  - sdc.xb_test_sdc.card:
+  - sdc.canvas_test_sdc.card:
       props:
         title: 'Test Card'
         content: 'Test content'
 sidebar:
-  - sdc.xb_test_sdc.text:
+  - sdc.canvas_test_sdc.text:
       props:
         text: 'Sidebar text'
 YAML;
@@ -181,7 +181,7 @@ YAML;
           'operation' => 'ADD',
           'components' => [
             [
-              'id' => 'sdc.xb_test_sdc.card',
+              'id' => 'sdc.canvas_test_sdc.card',
               'nodePath' => [0, 0],
               'fieldValues' => [
                 'title' => 'Test Card',
@@ -189,7 +189,7 @@ YAML;
               ],
             ],
             [
-              'id' => 'sdc.xb_test_sdc.text',
+              'id' => 'sdc.canvas_test_sdc.text',
               'nodePath' => [1, 0],
               'fieldValues' => [
                 'text' => 'Sidebar text',
@@ -222,11 +222,11 @@ YAML;
 
     $valid_yaml = <<<YAML
 content:
-  - sdc.xb_test_sdc.card:
+  - sdc.canvas_test_sdc.card:
       props:
         title: 'Test Card'
         content: 'Test content'
-  - sdc.xb_test_sdc.text:
+  - sdc.canvas_test_sdc.text:
       props:
         text: 'Sidebar text'
 YAML;
@@ -237,12 +237,12 @@ YAML;
           "nodePathPrefix" => [0],
           "components" => [
             [
-              "name" => "sdc.xb_test_sdc.card",
+              "name" => "sdc.canvas_test_sdc.card",
               "uuid" => "9cadf75e-7116-444a-9d05-e3c86483d178",
               "nodePath" => [0, 0],
             ],
             [
-              "name" => "sdc.xb_test_sdc.card",
+              "name" => "sdc.canvas_test_sdc.card",
               "uuid" => "ab9b70d7-554d-421a-8303-725f4f6a6b9c",
               "nodePath" => [0, 1],
             ],
@@ -262,7 +262,7 @@ YAML;
           'operation' => 'ADD',
           'components' => [
             [
-              'id' => 'sdc.xb_test_sdc.card',
+              'id' => 'sdc.canvas_test_sdc.card',
               'nodePath' => [0, 2],
               'fieldValues' => [
                 'title' => 'Test Card',
@@ -270,7 +270,7 @@ YAML;
               ],
             ],
             [
-              'id' => 'sdc.xb_test_sdc.text',
+              'id' => 'sdc.canvas_test_sdc.text',
               'nodePath' => [0, 3],
               'fieldValues' => [
                 'text' => 'Sidebar text',
-- 
GitLab


From 221069cf51758721e06081fb4f4f1b38f01a4e4e Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 29 Sep 2025 16:45:43 +0530
Subject: [PATCH 14/50] Remove unwanted references to xb

---
 modules/canvas_ai/src/Hook/CanvasAiHooks.php                  | 2 +-
 .../src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php  | 3 ++-
 .../Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php  | 4 ++--
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/canvas_ai/src/Hook/CanvasAiHooks.php b/canvas_ai/src/Hook/CanvasAiHooks.php
index 80c127022..b922b9a57 100644
--- a/canvas_ai/src/Hook/CanvasAiHooks.php
+++ b/canvas_ai/src/Hook/CanvasAiHooks.php
@@ -81,7 +81,7 @@ class CanvasAiHooks {
           ],
           'available_regions' => [
             'name' => $this->t('Available Regions'),
-            'description' => $this->t('Returns the available regions in experience builder.'),
+            'description' => $this->t('Returns the available regions.'),
           ],
           'verbose_context_for_orchestrator' => [
             'name' => $this->t('Verbose Context for Orchestrator'),
diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index e3ef0e6d4..fa1bd0b15 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -17,6 +17,7 @@ use Drupal\Core\Logger\LoggerChannelFactoryInterface;
 use Drupal\Core\Session\AccountProxyInterface;
 use Drupal\canvas_ai\AiResponseValidator;
 use Drupal\canvas_ai\CanvasAiPageBuilderHelper;
+use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 
 /**
@@ -103,7 +104,7 @@ final class SetAIGeneratedTemplateData extends FunctionCallBase implements Execu
    */
   public function execute(): void {
     // Make sure that the user has the right permissions.
-    if (!$this->currentUser->hasPermission('use experience builder ai')) {
+    if (!$this->currentUser->hasPermission(CanvasAiPermissions::USE_CANVAS_AI)) {
       throw new \Exception('The current user does not have the right permissions to run this tool.');
     }
     try {
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 0c9e19bb5..96f004462 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -10,6 +10,7 @@ use Drupal\KernelTests\KernelTestBase;
 use Drupal\Tests\user\Traits\UserCreationTrait;
 use Drupal\user\Entity\User;
 use Drupal\canvas_ai\CanvasAiPageBuilderHelper;
+use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 
 /**
@@ -62,7 +63,6 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
   protected static $modules = [
     'ai',
     'ai_agents',
-    'experience_builder',
     'system',
     'user',
     'canvas_ai',
@@ -76,7 +76,7 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
     $this->installEntitySchema('user');
 
     $this->functionCallManager = $this->container->get('plugin.manager.ai.function_calls');
-    $privileged_user = $this->createUser(['use experience builder ai']);
+    $privileged_user = $this->createUser([CanvasAiPermissions::USE_CANVAS_AI]);
     $unprivileged_user = $this->createUser();
     if (!$privileged_user instanceof User || !$unprivileged_user instanceof User) {
       throw new \Exception('Failed to create test users');
-- 
GitLab


From c59401d855d1e0ad8cfb8c1bdb36e5c1dc351b85 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 30 Sep 2025 10:26:30 +0530
Subject: [PATCH 15/50] Fix test

---
 .../SetAIGeneratedTemplateDataTest.php        | 101 ++++++------------
 1 file changed, 32 insertions(+), 69 deletions(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 96f004462..4ad8487c9 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -12,6 +12,7 @@ use Drupal\user\Entity\User;
 use Drupal\canvas_ai\CanvasAiPageBuilderHelper;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
+use Drupal\Core\Extension\ModuleInstallerInterface;
 
 /**
  * Tests for the SetAIGeneratedTemplateData function call plugin.
@@ -65,6 +66,7 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
     'ai_agents',
     'system',
     'user',
+    'canvas',
     'canvas_ai',
   ];
 
@@ -83,59 +85,14 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
     }
     $this->privilegedUser = $privileged_user;
     $this->unprivilegedUser = $unprivileged_user;
-
+    $this->container->get(ModuleInstallerInterface::class)->install(['canvas_test_sdc']);
+    $this->container->get('theme_installer')->install(['stark']);
+    $this->container->get('config.factory')
+      ->getEditable('system.theme')
+      ->set('default', 'stark')
+      ->save();
     $this->mockTempStore = $this->createMock(CanvasAiTempStore::class);
     $this->container->set('canvas_ai.tempstore', $this->mockTempStore);
-
-    $this->pageBuilderHelper = $this->createPageBuilderMock();
-    $this->container->set('canvas_ai.page_builder_helper', $this->pageBuilderHelper);
-  }
-
-  /**
-   * Creates a mock PageBuilderHelper.
-   */
-  protected function createPageBuilderMock(): CanvasAiPageBuilderHelper {
-    $mock_helper = $this->getMockBuilder(CanvasAiPageBuilderHelper::class)
-      ->disableOriginalConstructor()
-      ->onlyMethods(['getComponentContextForAi'])
-      ->getMock();
-
-    // Mock component context data.
-    $component_context_yaml = <<<YAML
-sdc.canvas_test_sdc.card:
-  id: sdc.canvas_test_sdc.card
-  name: Card
-  description: Card component
-  group: ''
-  props:
-    title:
-      name: Title
-      description: Card title
-      type: string
-      default: ''
-    content:
-      name: Content
-      description: Card content
-      type: string
-      default: ''
-sdc.canvas_test_sdc.text:
-  id: sdc.canvas_test_sdc.text
-  name: Text
-  description: Text component
-  group: ''
-  props:
-    text:
-      name: Text
-      description: Text content
-      type: string
-      default: ''
-YAML;
-
-    $mock_helper->expects($this->any())
-      ->method('getComponentContextForAi')
-      ->willReturn($component_context_yaml);
-
-    return $mock_helper;
   }
 
   /**
@@ -146,14 +103,18 @@ YAML;
 
     $valid_yaml = <<<YAML
 content:
-  - sdc.canvas_test_sdc.card:
+  - sdc.canvas_test_sdc.my-hero:
       props:
-        title: 'Test Card'
-        content: 'Test content'
+        heading: 'My Hero'
+        subheading: 'SubSnub'
+        cta1: 'View it!'
+        cta1href: 'https://canvas-example.com'
+        cta2: 'Click it!'
 sidebar:
-  - sdc.canvas_test_sdc.text:
+  - sdc.canvas_test_sdc.heading:
       props:
-        text: 'Sidebar text'
+        text: 'Some text'
+        element: 'h1'
 YAML;
 
     $mock_layout = [
@@ -181,19 +142,20 @@ YAML;
           'operation' => 'ADD',
           'components' => [
             [
-              'id' => 'sdc.canvas_test_sdc.card',
+              'id' => 'sdc.canvas_test_sdc.my-hero',
               'nodePath' => [0, 0],
               'fieldValues' => [
-                'title' => 'Test Card',
-                'content' => 'Test content',
+                'heading' => 'My Hero',
+                'subheading' => 'SubSnub',
+                'cta1' => 'View it!',
+                'cta1href' => 'https://canvas-example.com',
+                'cta2' => 'Click it!',
               ],
             ],
             [
-              'id' => 'sdc.canvas_test_sdc.text',
+              'id' => 'sdc.canvas_test_sdc.heading',
               'nodePath' => [1, 0],
-              'fieldValues' => [
-                'text' => 'Sidebar text',
-              ],
+              'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
             ],
           ],
         ],
@@ -226,9 +188,11 @@ content:
       props:
         title: 'Test Card'
         content: 'Test content'
-  - sdc.canvas_test_sdc.text:
+        loading: 'lazy'
+  - sdc.canvas_test_sdc.heading:
       props:
-        text: 'Sidebar text'
+        text: 'Some text'
+        element: 'h1'
 YAML;
 
     $mock_layout = [
@@ -267,14 +231,13 @@ YAML;
               'fieldValues' => [
                 'title' => 'Test Card',
                 'content' => 'Test content',
+                'loading' => 'lazy',
               ],
             ],
             [
-              'id' => 'sdc.canvas_test_sdc.text',
+              'id' => 'sdc.canvas_test_sdc.heading',
               'nodePath' => [0, 3],
-              'fieldValues' => [
-                'text' => 'Sidebar text',
-              ],
+              'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
             ],
           ],
         ],
-- 
GitLab


From 04243374eb631da6216dfee8fe69f1f4ec82c24a Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 30 Sep 2025 10:53:26 +0530
Subject: [PATCH 16/50] Resolve merge conflicts

---
 .../AiFunctionCall/SetAIGeneratedTemplateDataTest.php     | 8 --------
 1 file changed, 8 deletions(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 4ad8487c9..531d95f7e 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -9,7 +9,6 @@ use Drupal\Core\Session\AccountInterface;
 use Drupal\KernelTests\KernelTestBase;
 use Drupal\Tests\user\Traits\UserCreationTrait;
 use Drupal\user\Entity\User;
-use Drupal\canvas_ai\CanvasAiPageBuilderHelper;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 use Drupal\Core\Extension\ModuleInstallerInterface;
@@ -51,13 +50,6 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
    */
   protected $mockTempStore;
 
-  /**
-   * The mock page builder helper.
-   *
-   * @var \Drupal\canvas_ai\CanvasAiPageBuilderHelper
-   */
-  protected $pageBuilderHelper;
-
   /**
    * {@inheritdoc}
    */
-- 
GitLab


From 6fabe6d93eb0eaaa486eafd8b5cf9c299d5858fc Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 30 Sep 2025 14:22:24 +0530
Subject: [PATCH 17/50] Fix tests

---
 .../Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php  | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 531d95f7e..1197c3283 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -110,7 +110,7 @@ sidebar:
 YAML;
 
     $mock_layout = [
-      "layout" => [
+      "regions" => [
         "content" => [
           "nodePathPrefix" => [0],
           "components" => [],
@@ -188,7 +188,7 @@ content:
 YAML;
 
     $mock_layout = [
-      "layout" => [
+      "regions" => [
         "content" => [
           "nodePathPrefix" => [0],
           "components" => [
-- 
GitLab


From cf7f9ed12c4e593ac907f79a9bc36401f90daa09 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Mon, 3 Nov 2025 16:56:31 +0530
Subject: [PATCH 18/50] Resolve merge conflicts.

---
 modules/canvas_ai/src/CanvasAiPageBuilderHelper.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 7365a83c8..6194dc61a 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1191,7 +1191,7 @@ class CanvasAiPageBuilderHelper {
     return !empty($node[$slot_name]);
   }
 
- /**
+  /**
    * Gets the region indices from the current layout.
    *
    * @param string $current_layout
-- 
GitLab


From 7ff9aaec09e0eef733036d0358da6b17bbd8a350 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Tue, 30 Sep 2025 18:56:42 +0530
Subject: [PATCH 19/50] Use image prop in test to ensure that image validations
 work correctly

---
 .../AiFunctionCall/SetAIGeneratedTemplateDataTest.php | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 1197c3283..3a1c99120 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -181,6 +181,11 @@ content:
         title: 'Test Card'
         content: 'Test content'
         loading: 'lazy'
+        image:
+          src: /modules/contrib/canvas/tests/modules/canvas_test_sdc/components/card/balloons.png
+          alt: 'Hot air balloons'
+          width: 640
+          height: 427
   - sdc.canvas_test_sdc.heading:
       props:
         text: 'Some text'
@@ -224,6 +229,12 @@ YAML;
                 'title' => 'Test Card',
                 'content' => 'Test content',
                 'loading' => 'lazy',
+                'image' => [
+                  'src' => '/modules/contrib/canvas/tests/modules/canvas_test_sdc/components/card/balloons.png',
+                  'alt' => 'Hot air balloons',
+                  'width' => 640,
+                  'height' => 427,
+                ],
               ],
             ],
             [
-- 
GitLab


From 8b3eac5022d192ec901742c3696d632130176f11 Mon Sep 17 00:00:00 2001
From: Souvik Pal <souvik.techy21@gmail.com>
Date: Tue, 7 Oct 2025 19:58:44 +0530
Subject: [PATCH 20/50] Modified comment in CanvasAIThemeRegionSettingsForm.php
 for better clarity

---
 modules/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index e0732de4d..d80fa5764 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -9,7 +9,7 @@ use Drupal\Core\Form\FormStateInterface;
 use Drupal\canvas\Entity\PageRegion;
 
 /**
- * Configure Canvas AI settings for this site.
+ * Configure the theme regions for AI content generation.
  */
 final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
 
-- 
GitLab


From b2fd12471b0434c5742fdd8f31e41cafa314466d Mon Sep 17 00:00:00 2001
From: Souvik Pal <souvik.techy21@gmail.com>
Date: Tue, 7 Oct 2025 19:59:43 +0530
Subject: [PATCH 21/50] Modified comment in SetAIGeneratedTemplateData.php for
 better clarity

---
 .../src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php    | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index fa1bd0b15..5b5f2b058 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -21,7 +21,7 @@ use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 
 /**
- * Function call plugin to set the component structure generated by AI.
+ * Function call to set the template data generated by AI.
  */
 #[FunctionCall(
   id: 'canvas_ai:set_template_data',
-- 
GitLab


From 2a3c3d97cbd55fb0cb15d5368b682a229d901641 Mon Sep 17 00:00:00 2001
From: Souvik Pal <souvik.techy21@gmail.com>
Date: Tue, 7 Oct 2025 20:01:58 +0530
Subject: [PATCH 22/50] Refactor: Inject the ContextDefinitionNormalizer
 service instead of direct instantiation.

---
 .../src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php    | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index 5b5f2b058..61cd85746 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -89,7 +89,7 @@ final class SetAIGeneratedTemplateData extends FunctionCallBase implements Execu
       $configuration,
       $plugin_id,
       $plugin_definition,
-      new ContextDefinitionNormalizer(),
+      $container->get('ai.context_definition_normalizer'),
     );
     $instance->pageBuilderHelper = $container->get('canvas_ai.page_builder_helper');
     $instance->loggerFactory = $container->get('logger.factory');
-- 
GitLab


From 5a74c6477b4aa11306689b18ac2a8ab09f5e95fd Mon Sep 17 00:00:00 2001
From: Souvik Pal <souvik.techy21@gmail.com>
Date: Tue, 7 Oct 2025 20:03:06 +0530
Subject: [PATCH 23/50] Included missing permission for canvas_ai.setting

---
 modules/canvas_ai/canvas_ai.routing.yml | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/canvas_ai/canvas_ai.routing.yml b/canvas_ai/canvas_ai.routing.yml
index 38b9a84bd..62573b3f4 100644
--- a/canvas_ai/canvas_ai.routing.yml
+++ b/canvas_ai/canvas_ai.routing.yml
@@ -26,6 +26,8 @@ canvas_ai.setting:
   defaults:
     _title: 'Canvas AI Settings Form'
     _form: 'Drupal\canvas_ai\Form\CanvasAiSettingsForm'
+  requirements:
+    _permission: 'use Drupal Canvas AI'
 
 canvas_ai.theme_region_settings:
   path: '/admin/config/ai/canvas-ai-theme-region-settings'
-- 
GitLab


From 3d1a819e9319e6e76f9847d1b95cc5ce81efd951 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 9 Oct 2025 14:45:37 +0530
Subject: [PATCH 24/50] Include title and metadata generation

---
 ...ai_agent.canvas_template_builder_agent.yml | 99 +++++++++++++++++--
 1 file changed, 93 insertions(+), 6 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index d20c094cf..33356c843 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -7,12 +7,60 @@ dependencies:
 id: canvas_template_builder_agent
 label: 'Canvas Template Builder Agent'
 description: 'This sub-agent specializes in building templates for entire pages using available components. It can also be used to generate headers and footers for pages. Use it for all template-building requests where a complete page needs to be generated.'
-system_prompt: |-
-  You are an AI assistant specialized in creating complete web page templates by strategically placing available Components into designated regions. Your role encompasses creating page body content and optionally headers/footers when explicitly requested.
+system_prompt: |
+  You are an AI assistant specialized in Drupal Canvas. Your primary function is to generate complete web page templates, including page content, title, and metadata, by using a predefined set of tools and adhering to a strict operational flow.
 
-  You are a looping agent meaning you can run multiple times till you get enough information to generate the required response and save the page template.
+  You are a looping agent, meaning you can run multiple times to correct errors until a successful result is achieved.
 
-  ## Core Responsibilities
+  ---
+
+  ## **Contextual Data Structure**
+
+  All critical information for your tasks will be provided within a `<critical_data>` block in the context. You must parse this block to find the following values:
+
+  -   `entity_type`: The entity type of the current page.
+  -   `page_title`: The current title of the page.
+  -   `page_description`: The current meta description of the page.
+
+  If a key (e.g., `page_description`) is not present within the block, you must treat its value as `null`.
+
+  ---
+
+  ### **STEP 1: CRITICAL VALIDATION (MANDATORY FIRST ACTION)**
+
+  Your first and most critical task is to validate the entity type. This step must be completed before any other action.
+
+  1.  **Locate and Inspect**: Find the `<critical_data>` block in the provided context and extract the value for `entity_type`.
+  2.  **Strict Validation**: Check if the `entity_type` value is **exactly** `canvas_page`.
+  3.  **Decision Gate**:
+      *   **IF the value is exactly `canvas_page`**: You are authorized to proceed to Step 2.
+      *   **IF the value is anything else (e.g., `article`, `basic_page`), is empty, or is not present**: You **MUST STOP** all further processing. Your ONLY action is to return the following exact message: `"This operation is only valid for Drupal Canvas pages."`
+      *   **DO NOT** under any circumstances use any tools (`set_template_data`, `canvas_title_generation_agent`, `canvas_metadata_generation_agent`) if this check fails. This rule is absolute.
+
+  ---
+
+  ### **STEP 2: PARALLEL TASK EXECUTION**
+
+  Once the entity type validation in Step 1 has passed, you will perform the following three tasks in parallel: Page Title Generation, Page Metadata Generation, and Page Template Design.
+
+  #### **Task A: Page Title Handling**
+
+  1.  **Inspect Title**: Check the `page_title` value from the `<critical_data>` block.
+  2.  **Condition for Generation**: If the `page_title` is empty, `null`, or the exact string `"Untitled page"`, you **MUST** use the `canvas_title_generation_agent` tool to generate an appropriate title based on the user's request.
+  3.  **Preservation Rule**: If the `page_title` contains any other value, you **MUST NOT** use the tool. The existing title must be preserved.
+
+  #### **Task B: Page Metadata Handling**
+
+  1.  **Inspect Description**: Check the `page_description` value from the `<critical_data>` block.
+  2.  **Condition for Generation**: If the `page_description` is empty or `null`, you **MUST** use the `canvas_metadata_generation_agent` tool to generate a suitable meta description.
+  3.  **Preservation Rule**: If the `page_description` already has a value, you **MUST NOT** use the tool. The existing description must be preserved.
+
+  #### **Task C: Page Template Design**
+
+  You will design the page body content by placing components. This task follows the core responsibilities outlined below.
+
+  ---
+  ## Core Responsibilities for template design
 
   ### 1. Component Placement Strategy
   - **Primary Focus**: Place components in the 'content' region as the main page body structure
@@ -44,8 +92,6 @@ system_prompt: |-
   - **JSON Layout Processing**: Analyze provided layout information to understand available regions and their usage
   - **Strategic Region Usage**: Make informed decisions about component placement across regions when explicitly requested
 
-  ## Template Tool Configuration
-
   ### Tool Parameters
   The `set_template_data` tool has two inputs:
   1. `component_structure` - the YAML template structure
@@ -160,17 +206,40 @@ system_prompt: |-
   - **Implementation Ready**: YAML output can be directly processed without modification
   - **Content Rich**: Page body contains minimum 5 well-structured sections with professional content
 
+  <critical_data>
+  ## Entity type
+  The entity_type of the current page is: [canvas_ai:entity_type]
+  ----
+  ## Page title
+  The title of the current page is: [canvas_ai:page_title]
+  ----
+  ## Page description
+  The description of the current page is: [canvas_ai:page_description]
   ## Available regions
+  The available regions are:
   [canvas_ai:available_regions]
+  </critical_data>
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_template_data': true
+  'ai_agents::ai_agent::canvas_metadata_generation_agent': true
+  'ai_agents::ai_agent::canvas_title_generation_agent': true
 tool_settings:
   'canvas_ai:set_template_data':
     return_directly: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
+  'ai_agents::ai_agent::canvas_metadata_generation_agent':
+    return_directly: 0
+    description_override: ''
+    progress_message: ''
+    use_artifacts: 0
+  'ai_agents::ai_agent::canvas_title_generation_agent':
+    return_directly: 0
+    description_override: ''
+    progress_message: ''
+    use_artifacts: 0
 orchestration_agent: false
 triage_agent: false
 max_loops: 10
@@ -195,6 +264,24 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
+  'ai_agents::ai_agent::canvas_metadata_generation_agent':
+    prompt:
+      action: ''
+      hide_property: 0
+      values: ''
+    files:
+      action: ''
+      hide_property: 0
+      values: ''
+  'ai_agents::ai_agent::canvas_title_generation_agent':
+    prompt:
+      action: ''
+      hide_property: 0
+      values: ''
+    files:
+      action: ''
+      hide_property: 0
+      values: ''
 exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
-- 
GitLab


From bacb33ea7cf3f00a51a6c8b6adc7ec7d50917827 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 23 Oct 2025 14:36:45 +0530
Subject: [PATCH 25/50] Remove unused code.

---
 .../src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php     | 1 -
 1 file changed, 1 deletion(-)

diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index 61cd85746..fafef1734 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -8,7 +8,6 @@ use Drupal\ai\Attribute\FunctionCall;
 use Drupal\ai\Base\FunctionCallBase;
 use Drupal\ai\Service\FunctionCalling\ExecutableFunctionCallInterface;
 use Drupal\ai\Service\FunctionCalling\FunctionCallInterface;
-use Drupal\ai\Utility\ContextDefinitionNormalizer;
 use Drupal\ai_agents\PluginInterfaces\AiAgentContextInterface;
 use Drupal\Component\Serialization\Json;
 use Drupal\Component\Serialization\Yaml;
-- 
GitLab


From b6d81003945c4b4514a7e78ff0f28cbf352ba578 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 23 Oct 2025 16:47:07 +0530
Subject: [PATCH 26/50] Update the test

---
 .../SetAIGeneratedTemplateDataTest.php        | 56 +++++++++++--------
 1 file changed, 33 insertions(+), 23 deletions(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 3a1c99120..ef2d37def 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -5,12 +5,14 @@ declare(strict_types=1);
 namespace Drupal\Tests\canvas_ai\Kernel\Plugin\AiFunctionCall;
 
 use Drupal\ai\Service\FunctionCalling\ExecutableFunctionCallInterface;
+use Drupal\canvas\Entity\Component;
 use Drupal\Core\Session\AccountInterface;
 use Drupal\KernelTests\KernelTestBase;
 use Drupal\Tests\user\Traits\UserCreationTrait;
 use Drupal\user\Entity\User;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
+use Drupal\Component\Serialization\Yaml;
 use Drupal\Core\Extension\ModuleInstallerInterface;
 
 /**
@@ -174,23 +176,36 @@ YAML;
   public function testSetTemplateDataToolWithReferenceNodepath(): void {
     $this->container->get('current_user')->setAccount($this->privilegedUser);
 
-    $valid_yaml = <<<YAML
-content:
-  - sdc.canvas_test_sdc.card:
-      props:
-        title: 'Test Card'
-        content: 'Test content'
-        loading: 'lazy'
-        image:
-          src: /modules/contrib/canvas/tests/modules/canvas_test_sdc/components/card/balloons.png
-          alt: 'Hot air balloons'
-          width: 640
-          height: 427
-  - sdc.canvas_test_sdc.heading:
-      props:
-        text: 'Some text'
-        element: 'h1'
-YAML;
+    $component = Component::load('sdc.canvas_test_sdc.card');
+    assert($component instanceof Component);
+    $clientNormalized = $component->normalizeForClientSide()->values;
+    // Get the default values for the image prop of the card component.
+    $default_values = $clientNormalized["propSources"]["image"]["default_values"]["resolved"];
+
+    $structure = [
+      'content' => [
+        [
+          'sdc.canvas_test_sdc.card' => [
+            'props' => [
+              'title' => 'Test Card',
+              'content' => 'Test content',
+              'loading' => 'lazy',
+              'image' => $default_values,
+            ],
+          ],
+        ],
+        [
+          'sdc.canvas_test_sdc.heading' => [
+            'props' => [
+              'text' => 'Some text',
+              'element' => 'h1',
+            ],
+          ],
+        ],
+      ],
+    ];
+
+    $valid_yaml = Yaml::encode($structure);
 
     $mock_layout = [
       "regions" => [
@@ -229,12 +244,7 @@ YAML;
                 'title' => 'Test Card',
                 'content' => 'Test content',
                 'loading' => 'lazy',
-                'image' => [
-                  'src' => '/modules/contrib/canvas/tests/modules/canvas_test_sdc/components/card/balloons.png',
-                  'alt' => 'Hot air balloons',
-                  'width' => 640,
-                  'height' => 427,
-                ],
+                'image' => $default_values,
               ],
             ],
             [
-- 
GitLab


From 7f3d09f65ef8f0433735e5645eed13bad0e697dd Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 6 Nov 2025 12:58:39 +0530
Subject: [PATCH 27/50] Update the theme region settings form and associated
 region logic.

---
 modules/canvas_ai/canvas_ai.links.menu.yml    | 14 +--
 modules/canvas_ai/canvas_ai.links.task.yml    | 16 ++++
 ...agents.ai_agent.canvas_ai_orchestrator.yml | 31 +++++-
 ...ai_agent.canvas_template_builder_agent.yml | 95 +------------------
 .../src/CanvasAiPageBuilderHelper.php         | 68 +------------
 .../Form/CanvasAIThemeRegionSettingsForm.php  | 80 ++++++++++++----
 6 files changed, 114 insertions(+), 190 deletions(-)
 create mode 100644 modules/canvas_ai/canvas_ai.links.task.yml

diff --git a/canvas_ai/canvas_ai.links.menu.yml b/canvas_ai/canvas_ai.links.menu.yml
index 82f45338a..98f535785 100644
--- a/canvas_ai/canvas_ai.links.menu.yml
+++ b/canvas_ai/canvas_ai.links.menu.yml
@@ -1,15 +1,5 @@
-canvas_ai.component_description_settings:
-  title: Canvas AI Component Description Settings
-  description: 'Update the descriptions of available components and their props and slots, for the AI page builder.'
-  parent: ai.admin_settings
-  route_name: canvas_ai.component_description_settings
-
 canvas_ai.setting:
-  title: Canvas AI Settings Form
-  description: 'Set the max image upload size.'
+  title: 'Canvas AI'
+  description: 'Canvas AI configuration and settings'
   parent: ai.admin_settings
   route_name: canvas_ai.setting
-canvas_ai.theme_region_settings:
-  title: Canvas AI Theme Region Settings
-  parent: ai.admin_settings
-  route_name: canvas_ai.theme_region_settings
diff --git a/canvas_ai/canvas_ai.links.task.yml b/canvas_ai/canvas_ai.links.task.yml
new file mode 100644
index 000000000..878056259
--- /dev/null
+++ b/canvas_ai/canvas_ai.links.task.yml
@@ -0,0 +1,16 @@
+canvas_ai.setting:
+  title: 'General Settings'
+  route_name: canvas_ai.setting
+  base_route: canvas_ai.setting
+
+canvas_ai.component_description_settings:
+  title: 'Component Descriptions'
+  route_name: canvas_ai.component_description_settings
+  base_route: canvas_ai.setting
+  weight: 10
+
+canvas_ai.theme_region_settings:
+  title: 'Page Region Descriptions'
+  route_name: canvas_ai.theme_region_settings
+  base_route: canvas_ai.setting
+  weight: 20
\ No newline at end of file
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
index c53665e10..10eea8579 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
@@ -28,6 +28,7 @@ system_prompt: |-
   *   `canvas_page_builder_agent(prompt: str)`: Adds components to a page by using *existing* components (blocks, SDCs, etc.). This agent assembles the page.
   *   `canvas_title_generation_agent(prompt: str)`: Generates an SEO-friendly title for the current `canvas_page` entity based on the context you provide or the page content.
   *   `canvas_metadata_generation_agent(prompt: str)`: Generates an SEO-friendly meta description for the current `canvas_page` entity based on the context you provide or the page content.
+  *   `canvas_template_builder_agent(prompt: str)`: Creates a complete page template using available components, including headers and footers.
 
   ---
 
@@ -37,7 +38,7 @@ system_prompt: |-
 
   **Rule #1: Critical Entity Type Validation**
   This is your first and most important check for any page modification task.
-  *   **Condition:** Before invoking `canvas_page_builder_agent`, `canvas_title_generation_agent`, or `canvas_metadata_generation_agent`, you MUST check the `entity type` of the current page.
+  *   **Condition:** Before invoking `canvas_template_builder_agent`, `canvas_page_builder_agent`, `canvas_title_generation_agent`, or `canvas_metadata_generation_agent`, you MUST check the `entity type` of the current page.
   *   **Action if `entity type` is 'node'**: Immediately stop and respond with: "This operation is only supported on canvas_page entities."
   *   **Action if `User has not created any entities`**: This means the user is not on a page. Immediately stop and respond with: "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
   *   **Exemption:** The `canvas_component_agent` is exempt from this check.
@@ -57,9 +58,9 @@ system_prompt: |-
   *   When a `selected_component_uuid` is available and the user's prompt is relative (e.g., "add a heading to this"), modify the prompt for `canvas_page_builder_agent` to be explicit.
   *   **Example:** User Prompt: "Add 3 product cards here." -> Orchestrator calls: `canvas_page_builder_agent(prompt="Add 3 product cards to the selected component.")`
 
-  **Rule #4: Proactive and Context-Aware title and description generation when using canvas_page_builder_agent**
+  **Rule #4: Proactive and Context-Aware title and description generation when using canvas_page_builder_agent or canvas_template_builder_agent **
   *   **Context is Key:** Your most important task is to create a high-quality, descriptive prompt for these agents. To do this, you must synthesize the user's recent page-building requests from the chat history to understand the page's topic and purpose.
-  *   **Proactive Trigger:** When you decide to call `canvas_page_builder_agent`, check the page's title and metadata.
+  *   **Proactive Trigger:** When you decide to call `canvas_page_builder_agent` or `canvas_template_builder_agent`, check the page's title and metadata.
       *   If `page title` is 'Untitled page' or empty, you MUST ALWAYS call `canvas_title_generation_agent` to generate a suitable title for the page.
       *   If `page metadata` is empty, you MUST ALWAYS call `canvas_metadata_generation_agent` to generate a suitable description for the page.
       *   You can use all the 3 tools in parallel at the same time.
@@ -86,9 +87,10 @@ system_prompt: |-
 
   **Rule #7: Other Common Rules**
   *  Do not ask the user whether they have created a Canvas Page entity. If the entity type information is not available, assume that they have not created one.
-  *  If the user's request requires the page_builder tool, DO NOT suggest components in the prompt. The agent can design sections, choose the right components, and handle the request using the provided context.
+  *  If the user's request requires the canvas_page_builder_agent or canvas_template_builder_agent tool, DO NOT suggest components in the prompt. The agent can design sections, choose the right components, and handle the request using the provided context.
   *  Do not generate a title or metadata description when `canvas_component_agent` is used under any circumstances.
   *  Do not mention the name of any of your tools to the user.
+  *  When the user requests to create header or footer, use the `canvas_template_builder_agent` tool, not `canvas_template_builder_agent`.
 
   ---
 
@@ -181,6 +183,12 @@ system_prompt: |-
   *   **Orchestrator Analysis:** This is the first message from the user
   *   **Orchestrator Action:** `canvas_metadata_generation_agent(prompt="Generate a description for the page based on its content.")`, `canvas_title_generation_agent(prompt="Generate a title for the page based on its content")`
 
+  **Example 14: Template generation**
+  *   **Context:** "The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title is empty. Page description is empty".
+  *   **User:** "Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form."
+  *   **Orchestrator Analysis:** Request is to generate a complete page. The title and description of the current page is empty.
+  *   **Orchestrator Action:** `canvas_template_builder_agent(prompt="Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form.")`, `canvas_title_generation_agent(prompt="Generate a title for a university landing page")`, `canvas_metadata_generation_agent(prompt="Generate a description for a university landing page")`
+
   ------------------------------------------------
   ## Entity Context
   [canvas_ai:verbose_context_for_orchestrator]
@@ -189,6 +197,7 @@ tools:
   'ai_agents::ai_agent::canvas_component_agent': true
   'ai_agents::ai_agent::canvas_metadata_generation_agent': true
   'ai_agents::ai_agent::canvas_page_builder_agent': true
+  'ai_agents::ai_agent::canvas_template_builder_agent': true
   'ai_agents::ai_agent::canvas_title_generation_agent': true
   'ai_agent:verify_task_completion': true
 tool_settings:
@@ -210,6 +219,11 @@ tool_settings:
     description_override: ''
     progress_message: ''
     use_artifacts: 0
+  'ai_agents::ai_agent::canvas_template_builder_agent':
+    return_directly: 0
+    description_override: ''
+    progress_message: ''
+    use_artifacts: 0
   'ai_agents::ai_agent::canvas_title_generation_agent':
     return_directly: 0
     require_usage: 0
@@ -254,6 +268,15 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
+  'ai_agents::ai_agent::canvas_template_builder_agent':
+    prompt:
+      action: ''
+      hide_property: 0
+      values: ''
+    files:
+      action: ''
+      hide_property: 0
+      values: ''
   'ai_agents::ai_agent::canvas_title_generation_agent':
     prompt:
       action: ''
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 33356c843..b9b4bfa22 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -6,60 +6,12 @@ dependencies:
       - canvas_ai
 id: canvas_template_builder_agent
 label: 'Canvas Template Builder Agent'
-description: 'This sub-agent specializes in building templates for entire pages using available components. It can also be used to generate headers and footers for pages. Use it for all template-building requests where a complete page needs to be generated.'
-system_prompt: |
-  You are an AI assistant specialized in Drupal Canvas. Your primary function is to generate complete web page templates, including page content, title, and metadata, by using a predefined set of tools and adhering to a strict operational flow.
+description: 'This tool specializes in building complete web pages by assembling available components into a cohesive layout. It should be used whenever the user requests to create an entire page. For example, Create a landing page for a university website or Build a landing page template for a cookie shop. In addition to full-page generation, the tool can also produce headers and footers when requested. Use this tool for any task that involves generating a complete page or when the user specifically asks for headers or footers.'
+system_prompt: |-
+  You are an AI assistant specialized in Drupal Canvas. Your primary function is to generate complete web page templates by using a predefined set of tools and adhering to a strict operational flow.
 
   You are a looping agent, meaning you can run multiple times to correct errors until a successful result is achieved.
 
-  ---
-
-  ## **Contextual Data Structure**
-
-  All critical information for your tasks will be provided within a `<critical_data>` block in the context. You must parse this block to find the following values:
-
-  -   `entity_type`: The entity type of the current page.
-  -   `page_title`: The current title of the page.
-  -   `page_description`: The current meta description of the page.
-
-  If a key (e.g., `page_description`) is not present within the block, you must treat its value as `null`.
-
-  ---
-
-  ### **STEP 1: CRITICAL VALIDATION (MANDATORY FIRST ACTION)**
-
-  Your first and most critical task is to validate the entity type. This step must be completed before any other action.
-
-  1.  **Locate and Inspect**: Find the `<critical_data>` block in the provided context and extract the value for `entity_type`.
-  2.  **Strict Validation**: Check if the `entity_type` value is **exactly** `canvas_page`.
-  3.  **Decision Gate**:
-      *   **IF the value is exactly `canvas_page`**: You are authorized to proceed to Step 2.
-      *   **IF the value is anything else (e.g., `article`, `basic_page`), is empty, or is not present**: You **MUST STOP** all further processing. Your ONLY action is to return the following exact message: `"This operation is only valid for Drupal Canvas pages."`
-      *   **DO NOT** under any circumstances use any tools (`set_template_data`, `canvas_title_generation_agent`, `canvas_metadata_generation_agent`) if this check fails. This rule is absolute.
-
-  ---
-
-  ### **STEP 2: PARALLEL TASK EXECUTION**
-
-  Once the entity type validation in Step 1 has passed, you will perform the following three tasks in parallel: Page Title Generation, Page Metadata Generation, and Page Template Design.
-
-  #### **Task A: Page Title Handling**
-
-  1.  **Inspect Title**: Check the `page_title` value from the `<critical_data>` block.
-  2.  **Condition for Generation**: If the `page_title` is empty, `null`, or the exact string `"Untitled page"`, you **MUST** use the `canvas_title_generation_agent` tool to generate an appropriate title based on the user's request.
-  3.  **Preservation Rule**: If the `page_title` contains any other value, you **MUST NOT** use the tool. The existing title must be preserved.
-
-  #### **Task B: Page Metadata Handling**
-
-  1.  **Inspect Description**: Check the `page_description` value from the `<critical_data>` block.
-  2.  **Condition for Generation**: If the `page_description` is empty or `null`, you **MUST** use the `canvas_metadata_generation_agent` tool to generate a suitable meta description.
-  3.  **Preservation Rule**: If the `page_description` already has a value, you **MUST NOT** use the tool. The existing description must be preserved.
-
-  #### **Task C: Page Template Design**
-
-  You will design the page body content by placing components. This task follows the core responsibilities outlined below.
-
-  ---
   ## Core Responsibilities for template design
 
   ### 1. Component Placement Strategy
@@ -69,6 +21,7 @@ system_prompt: |
   - **Header/Footer Generation**: Generate header and footer components ONLY when user explicitly requests to include header and footer
   - **Standalone Header/Footer**: If the request is specifically for generating only header or only footer, generate ONLY that component without creating the complete template
   - **Region Awareness**: When generating headers/footers, utilize respective header/footer or any similar regions if available, adapting to varying region names based on the active theme. If no dedicated regions are available, use the 'content' region.
+  - **Region descriptions**: Region descriptions may suggest which components are preferred in each region.
 
   ### 2. Component Selection and Configuration
   - **Strict Adherence**: Only use components explicitly provided in the context
@@ -206,40 +159,18 @@ system_prompt: |
   - **Implementation Ready**: YAML output can be directly processed without modification
   - **Content Rich**: Page body contains minimum 5 well-structured sections with professional content
 
-  <critical_data>
-  ## Entity type
-  The entity_type of the current page is: [canvas_ai:entity_type]
-  ----
-  ## Page title
-  The title of the current page is: [canvas_ai:page_title]
-  ----
-  ## Page description
-  The description of the current page is: [canvas_ai:page_description]
   ## Available regions
   The available regions are:
   [canvas_ai:available_regions]
-  </critical_data>
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_template_data': true
-  'ai_agents::ai_agent::canvas_metadata_generation_agent': true
-  'ai_agents::ai_agent::canvas_title_generation_agent': true
 tool_settings:
   'canvas_ai:set_template_data':
     return_directly: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
-  'ai_agents::ai_agent::canvas_metadata_generation_agent':
-    return_directly: 0
-    description_override: ''
-    progress_message: ''
-    use_artifacts: 0
-  'ai_agents::ai_agent::canvas_title_generation_agent':
-    return_directly: 0
-    description_override: ''
-    progress_message: ''
-    use_artifacts: 0
 orchestration_agent: false
 triage_agent: false
 max_loops: 10
@@ -264,24 +195,6 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
-  'ai_agents::ai_agent::canvas_metadata_generation_agent':
-    prompt:
-      action: ''
-      hide_property: 0
-      values: ''
-    files:
-      action: ''
-      hide_property: 0
-      values: ''
-  'ai_agents::ai_agent::canvas_title_generation_agent':
-    prompt:
-      action: ''
-      hide_property: 0
-      values: ''
-    files:
-      action: ''
-      hide_property: 0
-      values: ''
 exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 6194dc61a..d2cb8057c 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -17,6 +17,7 @@ use Drupal\Core\Config\ConfigFactoryInterface;
 use Drupal\canvas\Entity\Component;
 use Drupal\canvas\Plugin\Canvas\ComponentSource\JsComponent;
 use Drupal\canvas\Plugin\Canvas\ComponentSource\SingleDirectoryComponent;
+use Drupal\Component\Utility\NestedArray;
 
 /**
  * Provides helper methods for AI page builder.
@@ -1228,10 +1229,11 @@ class CanvasAiPageBuilderHelper {
     $region_index_mapping = $this->getRegionIndex($current_layout);
     $region_descriptions = $this->configFactory->get('canvas_ai.theme_region.settings')->get('region_descriptions') ?? [];
     $available_regions = [];
+    $active_theme = $this->configFactory->get('system.theme')->get('default');
     foreach ($region_index_mapping as $region_name => $region_index) {
       $available_regions[$region_name] = [
         'nodePathPrefix' => $region_index,
-        'description' => $region_descriptions[$region_name] ?? '',
+        'info' => NestedArray::getValue($region_descriptions, [$active_theme, $region_name]),
       ];
     }
     return $available_regions;
@@ -1272,76 +1274,14 @@ class CanvasAiPageBuilderHelper {
       else {
         $region_index_mapping = $this->getRegionIndex($current_layout);
 
-        $component_index = 0;
-
         $region_index = $region_index_mapping[$region] ?? 0;
-
-        foreach ($components as $index => $component) {
-          $this->processComponent($component, $region_index, $index, $result['operations'][0]['components'], $component_index);
-          $component_index++;
-        }
+        $this->processComponents($components, [$region_index, 0], $result['operations'][0]['components']);
       }
     }
 
     return Json::encode($result);
   }
 
-  /**
-   * Recursively processes a component and its slots.
-   *
-   * @param array $component
-   *   The component data.
-   * @param int $region_index
-   *   The region index.
-   * @param int $component_index
-   *   The component index in the region.
-   * @param array $components
-   *   The array to store processed components.
-   * @param int $global_index
-   *   The global component index.
-   * @param array $parent_path
-   *   The parent node path.
-   */
-  protected function processComponent(array $component, int $region_index, int $component_index, array &$components, int &$global_index, array $parent_path = []): void {
-    foreach ($component as $component_type => $component_data) {
-      $node_path = empty($parent_path) ? [$region_index, $component_index] : array_merge($parent_path, [$component_index]);
-
-      $component_structure = [
-        'id' => $component_type,
-        'nodePath' => $node_path,
-        'fieldValues' => [],
-      ];
-
-      // Process props if they exist.
-      if (isset($component_data['props'])) {
-        $component_structure['fieldValues'] = $component_data['props'];
-      }
-
-      $components[] = $component_structure;
-      $global_index++;
-
-      // Process slots if they exist.
-      if (isset($component_data['slots'])) {
-        foreach ($component_data['slots'] as $slot_name => $slot_components) {
-          if (!is_array($slot_components)) {
-            continue;
-          }
-
-          foreach ($slot_components as $slot_index => $slot_component) {
-            $this->processComponent(
-              $slot_component,
-              $region_index,
-              $slot_index,
-              $components,
-              $global_index,
-              array_merge($node_path, [array_search($slot_name, array_keys($component_data['slots']))])
-            );
-          }
-        }
-      }
-    }
-  }
-
   /**
    * Generate verbose context for Orchestrator.
    *
diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index d80fa5764..b5f8440ad 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -6,13 +6,40 @@ namespace Drupal\canvas_ai\Form;
 
 use Drupal\Core\Form\ConfigFormBase;
 use Drupal\Core\Form\FormStateInterface;
+use Drupal\Core\Config\ConfigFactoryInterface;
+use Drupal\Core\Url;
+use Drupal\Component\Utility\NestedArray;
 use Drupal\canvas\Entity\PageRegion;
+use Symfony\Component\DependencyInjection\ContainerInterface;
 
 /**
  * Configure the theme regions for AI content generation.
  */
 final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
 
+  protected readonly string $defaultTheme;
+
+  /**
+   * Creates a new CanvasAiComponentDescriptionSettingsForm instance.
+   *
+   * @param \Drupal\Core\Config\ConfigFactoryInterface $config_factory
+   *   The config factory service.
+   */
+  public function __construct(
+    protected readonly ConfigFactoryInterface $config_factory,
+  ) {
+    $this->defaultTheme = $this->config_factory->get('system.theme')->get('default');
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public static function create(ContainerInterface $container): static {
+    return new static(
+      $container->get('config.factory'),
+    );
+  }
+
   /**
    * {@inheritdoc}
    */
@@ -32,36 +59,49 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
    */
   public function buildForm(array $form, FormStateInterface $form_state): array {
     $config = $this->config('canvas_ai.theme_region.settings');
-    $active_regions = $this->getActiveRegions();
+    $active_regions = $this->getEnabledRegionsForDefaultSiteTheme();
     $form['#tree'] = TRUE;
 
     if (empty($active_regions)) {
+      $theme_settings_url = Url::fromRoute('system.theme_settings_theme', ['theme' => $this->defaultTheme]);
+
       $form['message'] = [
         '#type' => 'markup',
-        '#markup' => $this->t("You don't have any global regions enabled in your theme."),
+        '#markup' => $this->t('No page regions are enabled in your theme. Visit the <a href=":url">theme settings</a> to enable regions.', [
+          ':url' => $theme_settings_url->toString(),
+        ]),
       ];
       return $form;
     }
 
     $form['message'] = [
       '#type' => 'markup',
-      '#markup' => $this->t('Use this form to give proper descriptions for all the Global regions, which will be used by AI to generate content for those regions.'),
+      '#markup' => $this->t('
+        <p>The following page regions are available in your theme and can be used by the <strong>Canvas Template Builder Agent</strong> to build the layout for a complete page (for example, building a homepage for a pizza shop).</p>
+
+        <p>Use this form to describe how each region should be used.</p>
+
+        <p><em>Example:</em> If your theme has two footer regions and both are enabled, footer_top and footer_bottom, you can add instructions like:</p>
+
+        <p><strong>Footer Top:</strong> <em>"Add the site name, logo, and menu links (use button components with the \'type\' prop value set to \'link\')."</em></p>
+        <p><strong>Footer Bottom:</strong> <em>"Add social media links and copyright text."</em></p>
+      '),
     ];
 
     $descriptions = $config->get('region_descriptions') ?? [];
 
     foreach ($active_regions as $region) {
       $region_id = $this->getRegionId($region);
-      $form[$region_id] = [
+      $form[$this->defaultTheme][$region_id] = [
         '#type' => 'details',
         '#title' => $region->label(),
         '#open' => TRUE,
       ];
-      $form[$region_id]['description'] = [
+      $form[$this->defaultTheme][$region_id]['description'] = [
         '#type' => 'textarea',
         '#title' => $this->t('Description'),
         '#description' => $this->t('Provide a description for what kind of content should be placed in this region.'),
-        '#default_value' => $descriptions[$region_id] ?? '',
+        '#default_value' => NestedArray::getValue($descriptions, [$this->defaultTheme, $region_id, 'description']) ?: '',
       ];
     }
 
@@ -72,12 +112,16 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
    * {@inheritdoc}
    */
   public function submitForm(array &$form, FormStateInterface $form_state): void {
-    $active_regions = $this->getActiveRegions();
+    $active_regions = $this->getEnabledRegionsForDefaultSiteTheme();
 
-    $descriptions = [];
+    $descriptions = $this->config('canvas_ai.theme_region.settings')->get('region_descriptions') ?? [];
     foreach ($active_regions as $region) {
       $region_id = $this->getRegionId($region);
-      $descriptions[$region_id] = $form_state->getValue([$region_id, 'description']);
+      $region_name = $region->label();
+      NestedArray::setValue($descriptions, [$this->defaultTheme, $region_id], [
+        'name' => $region_name,
+        'description' => $form_state->getValue([$this->defaultTheme, $region_id, 'description']),
+      ]);
     }
 
     $this->config('canvas_ai.theme_region.settings')
@@ -88,13 +132,13 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
   }
 
   /**
-   * Get active theme regions.
+   * Get the enabled theme regions for the default site theme.
    *
    * @return array
-   *   An array of active theme regions.
+   *   An array of enabled theme regions.
    */
-  protected function getActiveRegions(): array {
-    $regions = PageRegion::loadMultiple();
+  protected function getEnabledRegionsForDefaultSiteTheme(): array {
+    $regions = PageRegion::loadForTheme($this->defaultTheme);
     return array_filter($regions, fn($region) => $region->status());
   }
 
@@ -109,12 +153,10 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
    */
   protected function getRegionId(PageRegion $region): string {
     $region_id = $region->id();
-    // Remove the theme prefix.
-    if (str_contains($region_id, '.')) {
-      $parts = explode('.', $region_id, 2);
-      return $parts[1] ?? $region_id;
-    }
-    return $region_id;
+    \assert(str_contains($region_id, '.'));
+    $parts = explode('.', $region_id);
+    \assert(count($parts) === 2);
+    return $parts[1];
   }
 
 }
-- 
GitLab


From 9901f8d2dafebf8ce837dd45ddbd1c829e276047 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:34:59 +0530
Subject: [PATCH 28/50] Resolve merge conflicts

---
 ...agents.ai_agent.canvas_ai_orchestrator.yml |  5 +--
 ...ai_agent.canvas_template_builder_agent.yml | 34 +------------------
 .../src/CanvasAiPageBuilderHelper.php         | 12 +++----
 .../src/Controller/CanvasBuilder.php          |  3 +-
 .../SetAIGeneratedTemplateData.php            |  6 ++--
 modules/canvas_ai/src/PropGuidelines.txt      | 33 ++++++++++++++++++
 6 files changed, 48 insertions(+), 45 deletions(-)
 create mode 100644 modules/canvas_ai/src/PropGuidelines.txt

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
index 10eea8579..437d08b2f 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
@@ -28,7 +28,7 @@ system_prompt: |-
   *   `canvas_page_builder_agent(prompt: str)`: Adds components to a page by using *existing* components (blocks, SDCs, etc.). This agent assembles the page.
   *   `canvas_title_generation_agent(prompt: str)`: Generates an SEO-friendly title for the current `canvas_page` entity based on the context you provide or the page content.
   *   `canvas_metadata_generation_agent(prompt: str)`: Generates an SEO-friendly meta description for the current `canvas_page` entity based on the context you provide or the page content.
-  *   `canvas_template_builder_agent(prompt: str)`: Creates a complete page template using available components, including headers and footers.
+  *   `canvas_template_builder_agent(prompt: str)`: Creates a complete page using available components, including headers and footers.
 
   ---
 
@@ -59,6 +59,7 @@ system_prompt: |-
   *   **Example:** User Prompt: "Add 3 product cards here." -> Orchestrator calls: `canvas_page_builder_agent(prompt="Add 3 product cards to the selected component.")`
 
   **Rule #4: Proactive and Context-Aware title and description generation when using canvas_page_builder_agent or canvas_template_builder_agent **
+  CRITICAL: This rule is MANDATORY and must be followed without exception.
   *   **Context is Key:** Your most important task is to create a high-quality, descriptive prompt for these agents. To do this, you must synthesize the user's recent page-building requests from the chat history to understand the page's topic and purpose.
   *   **Proactive Trigger:** When you decide to call `canvas_page_builder_agent` or `canvas_template_builder_agent`, check the page's title and metadata.
       *   If `page title` is 'Untitled page' or empty, you MUST ALWAYS call `canvas_title_generation_agent` to generate a suitable title for the page.
@@ -90,7 +91,7 @@ system_prompt: |-
   *  If the user's request requires the canvas_page_builder_agent or canvas_template_builder_agent tool, DO NOT suggest components in the prompt. The agent can design sections, choose the right components, and handle the request using the provided context.
   *  Do not generate a title or metadata description when `canvas_component_agent` is used under any circumstances.
   *  Do not mention the name of any of your tools to the user.
-  *  When the user requests to create header or footer, use the `canvas_template_builder_agent` tool, not `canvas_template_builder_agent`.
+  *  When the user requests to create header or footer, use the `canvas_template_builder_agent` tool, not `canvas_page_builder_agent`.
 
   ---
 
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index b9b4bfa22..86ed4022d 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -72,39 +72,7 @@ system_prompt: |-
 
   ## Content and Prop Value Guidelines
 
-  ### Prop Setting Logic
-  Follow this step-by-step logic for every prop of every component:
-
-  **1. Default Prop Formatting:**
-  - By default, set prop values in the standard `prop_name: "value"` format.
-  - Generate professional, relevant content appropriate for the template's purpose.
-  - Create meaningful, contextual text for all text-based props, including buttons and link labels.
-
-  **2. Conditional Formatting for URL/Link Props:**
-  - When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
-
-  **3. Strict Image Prop Handling (CRITICAL):**
-  - When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
-  - Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
-  - **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
-  - **DO NOT** change, omit, or add any keys or values.
-  - **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
-  - **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
-  - **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
-
-  **Correct Example:**
-  ```yaml
-  props:
-    banner_image:
-      src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
-      alt: "A good dog"
-      width: 601
-      height: 402
-
-  **4. General Prop Restrictions:**
-  - **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
-  - **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
-  - **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
+  [canvas_ai:prop_value_guidelines]
 
   ## Page Template Design Structure
 
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index d2cb8057c..75fd1158d 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1240,19 +1240,19 @@ class CanvasAiPageBuilderHelper {
   }
 
   /**
-   * Processes the parsed YAML array for UI representation.
+   * Processes the component structure array obtained from the set_template_data tool.
    *
-   * This function processes the yml generated by the template generation agent
-   * and converts it into a JSON structure that can be used in the UI.
+   * Calculates the nodePath for each component suggested by the template
+   * builder agent based on the current layout and the reference component, if provided.
    *
    * @param array $parsed_array
    *   The parsed YAML array.
    * @param string $current_layout
    *   The current layout of the page.
    * @param array $reference_nodepath
-   *   The nodepath of the reference component, if any.
+   *   The nodePath of the reference component, if any.
    */
-  public function processTemplateYmlForUi(array $parsed_array, string $current_layout, array $reference_nodepath = []): string {
+  public function processSetTemplateDataToolInput(array $parsed_array, string $current_layout, array $reference_nodepath = []): array {
     $result = [
       'operations' => [
         [
@@ -1279,7 +1279,7 @@ class CanvasAiPageBuilderHelper {
       }
     }
 
-    return Json::encode($result);
+    return $result;
   }
 
   /**
diff --git a/canvas_ai/src/Controller/CanvasBuilder.php b/canvas_ai/src/Controller/CanvasBuilder.php
index 49340f3e6..11c631554 100644
--- a/canvas_ai/src/Controller/CanvasBuilder.php
+++ b/canvas_ai/src/Controller/CanvasBuilder.php
@@ -264,7 +264,7 @@ final class CanvasBuilder extends ControllerBase {
           if ($tool instanceof AiAgentWrapper) {
             $response['message'] = $tool->getReadableOutput();
           }
-          if (in_array($tool->getPluginId(), ['ai_agents::ai_agent::canvas_ai_template_builder_agent', 'ai_agents::ai_agent::canvas_ai_page_builder_agent'])) {
+          if (in_array($tool->getPluginId(), ['ai_agents::ai_agent::canvas_page_builder_agent', 'ai_agents::ai_agent::canvas_template_builder_agent'])) {
             $this->canvasAiTempStore->deleteData(CanvasAiTempStore::CURRENT_LAYOUT_KEY);
           }
         }
@@ -417,6 +417,7 @@ final class CanvasBuilder extends ControllerBase {
       'canvas_component_agent' => $this->t('Generate a component'),
       'canvas_metadata_generation_agent' => $this->t('Generate metadata'),
       'canvas_page_builder_agent' => $this->t('Building the page'),
+      'canvas_template_builder_agent' => $this->t('Creating the page template'),
     ];
     return $descriptions[$agent_id] ?? $this->t('@agentName working', ['@agentName' => $agent_name]);
   }
diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index fafef1734..54c469a57 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -43,7 +43,7 @@ use Drupal\canvas_ai\CanvasAiTempStore;
     ),
   ],
 )]
-final class SetAIGeneratedTemplateData extends FunctionCallBase implements ExecutableFunctionCallInterface, AiAgentContextInterface {
+final class SetAIGeneratedTemplateData extends FunctionCallBase implements ExecutableFunctionCallInterface, AiAgentContextInterface, BuilderResponseFunctionCallInterface {
 
   /**
    * The Canvas page builder helper service.
@@ -146,8 +146,8 @@ final class SetAIGeneratedTemplateData extends FunctionCallBase implements Execu
         $this->responseValidator->validateComponentStructure($components);
       }
       // Process the YAML structure for UI representation.
-      $processed_structure = $this->pageBuilderHelper->processTemplateYmlForUi($component_structure_array, $current_layout, $reference_nodepath);
-      $this->setOutput($processed_structure);
+      $processed_structure = $this->pageBuilderHelper->processSetTemplateDataToolInput($component_structure_array, $current_layout, $reference_nodepath);
+      $this->setStructuredOutput($processed_structure);
     }
     catch (\Exception $e) {
       $this->loggerFactory->get('canvas_ai')->error($e->getMessage());
diff --git a/canvas_ai/src/PropGuidelines.txt b/canvas_ai/src/PropGuidelines.txt
new file mode 100644
index 000000000..f54c7dae5
--- /dev/null
+++ b/canvas_ai/src/PropGuidelines.txt
@@ -0,0 +1,33 @@
+### Prop Setting Logic
+Follow this step-by-step logic for every prop of every component:
+
+**1. Default Prop Formatting:**
+- By default, set prop values in the standard `prop_name: "value"` format.
+- Generate professional, relevant content appropriate for the template's purpose.
+- Create meaningful, contextual text for all text-based props, including buttons and link labels.
+
+**2. Conditional Formatting for URL/Link Props:**
+- When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
+
+**3. Strict Image Prop Handling (CRITICAL):**
+- When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
+- Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
+- **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
+- **DO NOT** change, omit, or add any keys or values.
+- **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
+- **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
+- **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
+
+**Correct Example:**
+```yaml
+props:
+  banner_image:
+    src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
+    alt: "A good dog"
+    width: 601
+    height: 402
+```
+**4. General Prop Restrictions:**
+- **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
+- **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
+- **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
\ No newline at end of file
-- 
GitLab


From c4567b71d08388c65533507042c873d8125972f5 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:35:53 +0530
Subject: [PATCH 29/50] Resolve merge conflicts

---
 ...ents.ai_agent.canvas_page_builder_agent.yml | 18 ++----------------
 .../{PropGuidelines.txt => PropGuidelines.md}  |  3 ++-
 .../SetAIGeneratedTemplateDataTest.php         | 15 +++++++--------
 3 files changed, 11 insertions(+), 25 deletions(-)
 rename modules/canvas_ai/src/{PropGuidelines.txt => PropGuidelines.md} (94%)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
index aadf94fdc..c4de3550c 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
@@ -77,22 +77,8 @@ system_prompt: |
   2.  **Content Quality:** Generate professional, engaging, and production-ready content. **Avoid generic placeholders like "Lorem Ipsum" or "Sample Text."** The content must be contextually relevant to the component's purpose (e.g., a "Testimonial" component must have a realistic quote and author).
 
   3.  **Strict Prop Setting Logic:** Follow these rules for every prop of every component.
-      *   **Links/URLs:** For any prop representing a URL (e.g., `href`, `link`), set the value to `https://example.com` unless the user provides a specific URL.
-            *   **Images (CRITICAL REQUIREMENT):** If a component prop is for an image, you MUST use the **exact** default values provided for that prop. The default value is a complex object, often containing `src`, `alt`, `width`, and `height`.
-                *   You must copy **ALL** keys and values from the default object into the prop's value.
-                *   DO NOT change, omit, or add any keys or values.
-                *   **Correct Example:**
-                    ```yaml
-    props:
-      banner_image:
-          src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
-          alt: "A good dog"
-          width: 601
-          height: 402
-                    ```
-            *   **HTML Attributes:** **NEVER** generate values for `class` or `id` or any similar props.
-            *   **CRITICAL: Enum:** If a prop has an enum, use only one of the allowed values. Never add non-existing values.
-      *   **No Null/Empty Values:** Props with `null`, `{}`, or `""` values are strictly forbidden. Omit the prop entirely if you cannot generate a meaningful value.
+
+  [canvas_ai:prop_value_guidelines]
 
    **Single Location YAML Template:**
     ```yaml
diff --git a/canvas_ai/src/PropGuidelines.txt b/canvas_ai/src/PropGuidelines.md
similarity index 94%
rename from canvas_ai/src/PropGuidelines.txt
rename to canvas_ai/src/PropGuidelines.md
index f54c7dae5..7646e55e5 100644
--- a/canvas_ai/src/PropGuidelines.txt
+++ b/canvas_ai/src/PropGuidelines.md
@@ -30,4 +30,5 @@ props:
 **4. General Prop Restrictions:**
 - **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
 - **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
-- **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
\ No newline at end of file
+- **Enum:** If a prop has an enum, use only one of the allowed values. Never add non-existing values.
+- **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index ef2d37def..99277452f 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -4,7 +4,6 @@ declare(strict_types=1);
 
 namespace Drupal\Tests\canvas_ai\Kernel\Plugin\AiFunctionCall;
 
-use Drupal\ai\Service\FunctionCalling\ExecutableFunctionCallInterface;
 use Drupal\canvas\Entity\Component;
 use Drupal\Core\Session\AccountInterface;
 use Drupal\KernelTests\KernelTestBase;
@@ -12,6 +11,7 @@ use Drupal\Tests\user\Traits\UserCreationTrait;
 use Drupal\user\Entity\User;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
+use Drupal\canvas_ai\Plugin\AiFunctionCall\SetAIGeneratedTemplateData;
 use Drupal\Component\Serialization\Yaml;
 use Drupal\Core\Extension\ModuleInstallerInterface;
 
@@ -157,14 +157,13 @@ YAML;
     ];
 
     $tool = $this->functionCallManager->createInstance('canvas_ai:set_template_data');
-    $this->assertInstanceOf(ExecutableFunctionCallInterface::class, $tool);
+    $this->assertInstanceOf(SetAIGeneratedTemplateData::class, $tool);
 
     $tool->setContextValue('component_structure', $valid_yaml);
     $tool->execute();
 
-    $result = $tool->getReadableOutput();
-    $this->assertEquals(
-      json_encode($expected_output),
+    $result = $tool->getStructuredOutput();
+    $this->assertEquals($expected_output,
       $result,
       "The component structure was not processed correctly"
     );
@@ -258,15 +257,15 @@ YAML;
     ];
 
     $tool = $this->functionCallManager->createInstance('canvas_ai:set_template_data');
-    $this->assertInstanceOf(ExecutableFunctionCallInterface::class, $tool);
+    $this->assertInstanceOf(SetAIGeneratedTemplateData::class, $tool);
 
     $tool->setContextValue('component_structure', $valid_yaml);
     // Set the reference nodepath.
     $tool->setContextValue('reference_component_nodepath', [0, 1]);
     $tool->execute();
 
-    $result = $tool->getReadableOutput();
-    $this->assertEquals(\json_encode($expected_output), $result);
+    $result = $tool->getStructuredOutput();
+    $this->assertEquals($expected_output, $result);
   }
 
 }
-- 
GitLab


From 31d5dd5f13afe68c37b83f456236de633be1c6dc Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:36:24 +0530
Subject: [PATCH 30/50] Resolve merge conflicts

---
 ...agents.ai_agent.canvas_ai_orchestrator.yml | 32 ++++++++++++-------
 .../src/CanvasAiPageBuilderHelper.php         |  3 ++
 .../src/Controller/CanvasBuilder.php          |  1 +
 .../AiFunctionCall/VerifyTaskCompletion.php   |  4 +++
 4 files changed, 29 insertions(+), 11 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
index 437d08b2f..88ca7cf09 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
@@ -61,11 +61,11 @@ system_prompt: |-
   **Rule #4: Proactive and Context-Aware title and description generation when using canvas_page_builder_agent or canvas_template_builder_agent **
   CRITICAL: This rule is MANDATORY and must be followed without exception.
   *   **Context is Key:** Your most important task is to create a high-quality, descriptive prompt for these agents. To do this, you must synthesize the user's recent page-building requests from the chat history to understand the page's topic and purpose.
-  *   **Proactive Trigger:** When you decide to call `canvas_page_builder_agent` or `canvas_template_builder_agent`, check the page's title and metadata.
+  *   **Proactive Trigger:** When you decide to call `canvas_page_builder_agent` or `canvas_template_builder_agent`, check the page's title and description.
       *   If `page title` is 'Untitled page' or empty, you MUST ALWAYS call `canvas_title_generation_agent` to generate a suitable title for the page.
-      *   If `page metadata` is empty, you MUST ALWAYS call `canvas_metadata_generation_agent` to generate a suitable description for the page.
+      *   If `page description` is empty, you MUST ALWAYS call `canvas_metadata_generation_agent` to generate a suitable description for the page.
       *   You can use all the 3 tools in parallel at the same time.
-  *   **Reactive Trigger:** If the user directly asks you to "create a title" or "write a description," synthesize the context from the entire page-building history to create the prompt. If there is no context, simply pass 'Generate a title for this page' and 'Generate suitable description for this page' as prompt to the tools. They are capable of looking at the page contents and generating proper title and metadata.
+  *   **Reactive Trigger:** If the user directly asks you to "create a title" or "write a description," synthesize the context from the entire page-building history to create the prompt. If there is no context, simply pass 'Generate a title for this page' and 'Generate suitable description for this page' as prompt to the tools. They are capable of looking at the page contents and generating proper title and description.
   *   **Constraint:** Do not proactively call these agents if a title or description already exists (i.e., it's not the default 'Untitled page' or empty).
 
   **Rule #5: Image-to-Component Generation**
@@ -89,7 +89,7 @@ system_prompt: |-
   **Rule #7: Other Common Rules**
   *  Do not ask the user whether they have created a Canvas Page entity. If the entity type information is not available, assume that they have not created one.
   *  If the user's request requires the canvas_page_builder_agent or canvas_template_builder_agent tool, DO NOT suggest components in the prompt. The agent can design sections, choose the right components, and handle the request using the provided context.
-  *  Do not generate a title or metadata description when `canvas_component_agent` is used under any circumstances.
+  *  Do not generate a title or description when `canvas_component_agent` is used under any circumstances.
   *  Do not mention the name of any of your tools to the user.
   *  When the user requests to create header or footer, use the `canvas_template_builder_agent` tool, not `canvas_page_builder_agent`.
 
@@ -127,7 +127,7 @@ system_prompt: |-
   *   **User:** *(uploads image of a testimonial card)* "Create a component that looks like this."
   *   **Orchestrator Action:** `canvas_component_agent(prompt="Create a testimonial card component. The component has a white background with a light blue border and rounded corners. Inside, there is a circular avatar image on the left. To the right of the image, the person's name 'Jane Smith' is in bold, black text. Below the name, their title 'Marketing Director' is in smaller, blue text. Below this block is a quote in italics: 'Drupal Canvas has revolutionized our workflow.'")`
 
-  **Example 6: Direct Request for Metadata**
+  **Example 6: Direct Request for Page description**
   *   **Context:** User has already built a page about the services of a dental clinic (e.g., teeth whitening, check-ups, and braces). The `page description` is not empty, but the user wants to regenerate it.
   *   **User:** "Write a better SEO description for this page."
   *   **Orchestrator Analysis:** Scans chat history to understand the page content.
@@ -168,28 +168,38 @@ system_prompt: |-
       2.  `canvas_title_generation_agent(prompt="Generate an SEO-friendly title for a page whose content includes buttons with the text 'hello world'.")`
       3.  `canvas_metadata_generation_agent(prompt="Generate an SEO-friendly meta description for a page whose content includes buttons with the text 'hello world'.")`
 
-  **Example 12: Page Building When title and metadata exists**
+  **Example 12: Page Building When title and description exists**
   *   **Context:** The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title: Our Company Services. Page description: Learn about the professional services our company offers.
   *   **User:** "Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'.."
   *   **Orchestrator Analysis:**
-      1.  The request is a valid page-building task. Check the title and metadata.
-      2.  Since `page_title` is not 'Untitled page' and `page_description` is not empty, Rule #4's constraint applies. Do *not* invoke the SEO agents.
+      1.  The request is a valid page-building task. Check the title and description.
+      2.  Since `page_title` is not 'Untitled page' and `page_description` is not empty, Rule #4's constraint applies. Do *not* invoke `canvas_title_generation_agent` and `canvas_metadata_generation_agent`.
   *   **Orchestrator Action: (Parallel)**
       1.  `canvas_page_builder_agent(prompt="Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'.")`
       *(No further actions are taken)*
 
-  **Example 13: Direct Request for title and metadata without chat history**
+  **Example 13: Direct Request for title and description without chat history**
   *   **Context:** "The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title: My first page. Page description: My first page".
   *   **User:** "Generate a title and description for this page."
   *   **Orchestrator Analysis:** This is the first message from the user
   *   **Orchestrator Action:** `canvas_metadata_generation_agent(prompt="Generate a description for the page based on its content.")`, `canvas_title_generation_agent(prompt="Generate a title for the page based on its content")`
 
-  **Example 14: Template generation**
+  **Example 14: Template generation with empty title and description**
   *   **Context:** "The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title is empty. Page description is empty".
   *   **User:** "Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form."
-  *   **Orchestrator Analysis:** Request is to generate a complete page. The title and description of the current page is empty.
+  *   **Orchestrator Analysis:** Request is to generate a complete page. The title and description of the current page is empty and needs to be generated.
   *   **Orchestrator Action:** `canvas_template_builder_agent(prompt="Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form.")`, `canvas_title_generation_agent(prompt="Generate a title for a university landing page")`, `canvas_metadata_generation_agent(prompt="Generate a description for a university landing page")`
 
+  **Example 15: Template Building When title and description exists**
+  *   **Context:** The user is currently working on a canvas_page entity. Page title: University Homepage. Page description: Official homepage for the university.
+  *   **User:** "Create a complete landing page for a university website."
+  *   **Orchestrator Analysis:**
+      1.  The request is a valid template-building task. Check the title and description.
+      2.  Since `page_title` is not 'Untitled page' and `page_description` is not empty, Rule #4's constraint applies. Do *not* invoke `canvas_title_generation_agent` and `canvas_metadata_generation_agent`.
+  *   **Orchestrator Action:**
+      1.  `canvas_template_builder_agent(prompt="Create a complete landing page for a university website.")`
+      *(No title/description generation actions are taken)*
+
   ------------------------------------------------
   ## Entity Context
   [canvas_ai:verbose_context_for_orchestrator]
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 75fd1158d..e97375ff2 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1251,6 +1251,9 @@ class CanvasAiPageBuilderHelper {
    *   The current layout of the page.
    * @param array $reference_nodepath
    *   The nodePath of the reference component, if any.
+   *
+   * @return array
+   *   The processed operations array with calculated nodePaths for components.
    */
   public function processSetTemplateDataToolInput(array $parsed_array, string $current_layout, array $reference_nodepath = []): array {
     $result = [
diff --git a/canvas_ai/src/Controller/CanvasBuilder.php b/canvas_ai/src/Controller/CanvasBuilder.php
index 11c631554..19b523ee2 100644
--- a/canvas_ai/src/Controller/CanvasBuilder.php
+++ b/canvas_ai/src/Controller/CanvasBuilder.php
@@ -228,6 +228,7 @@ final class CanvasBuilder extends ControllerBase {
       'active_component_uuid' => $prompt['active_component_uuid'] ?? 'None',
       'menu_fetch_source' => $this->getMenuFetchSource(),
       'json_api_module_status' => $this->moduleHandler()->moduleExists('jsonapi') ? 'enabled' : 'disabled',
+      'available_regions' => Json::encode($this->canvasAiPageBuilderHelper->getAvailableRegions(Json::encode($prompt['current_layout']))) ?? NULL,
       'verbose_context_for_orchestrator' => $this->canvasAiPageBuilderHelper->generateVerboseContextForOrchestrator($prompt),
       'custom_libraries' => $this->getSupportedLibraries(),
     ]);
diff --git a/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php b/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php
index c3a248d81..ad876c475 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php
@@ -35,6 +35,10 @@ class VerifyTaskCompletion extends FunctionCallBase implements ExecutableFunctio
       "  - If canvas_page_builder_agent was used:\n" .
       "     Page components were added/modified\n" .
       "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
+      "     Page description was generated using canvas_metadata_generation_agent (if description was empty)\n\n" .
+      "  - If canvas_template_builder_agent was used:\n" .
+      "     Page template were added\n" .
+      "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
       "     Page description was generated using canvas_metadata_generation_agent (if description was empty)");
   }
 
-- 
GitLab


From 2f1abba782ec8eddffa0f2586a689fa875312301 Mon Sep 17 00:00:00 2001
From: narendra-drupal <87118318+narendra-drupal@users.noreply.github.com>
Date: Wed, 19 Nov 2025 13:22:57 +0530
Subject: [PATCH 31/50] Make sure title and description are generated

---
 .../install/ai_agents.ai_agent.canvas_page_builder_agent.yml | 5 +++++
 .../ai_agents.ai_agent.canvas_template_builder_agent.yml     | 5 +++++
 modules/canvas_ai/src/CanvasAiPageBuilderHelper.php          | 4 ++--
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
index c4de3550c..8ec86976c 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
@@ -148,6 +148,11 @@ system_prompt: |
 
   --------------------------------------------------
   ## selected_component_uuid: [canvas_ai:active_component_uuid]
+
+  The following is information that is important as context. Use this information to call canvas_title_generation_agent and/or canvas_metadata_generation_agent, if required:
+  ## Page Context
+  Page title: [canvas_ai:page_title]
+  Page description: [canvas_ai:page_description]
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_component_structure': true
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 86ed4022d..22c531cd8 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -130,6 +130,11 @@ system_prompt: |-
   ## Available regions
   The available regions are:
   [canvas_ai:available_regions]
+
+  The following is information that is important as context. Use this information to call canvas_title_generation_agent and/or canvas_metadata_generation_agent, if required:
+  ## Page Context
+  Page title: [canvas_ai:page_title]
+  Page description: [canvas_ai:page_description]
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_template_data': true
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index e97375ff2..1ea50101a 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -1325,7 +1325,7 @@ class CanvasAiPageBuilderHelper {
 
       // Add page title.
       if (empty($prompt['page_title']) || $prompt['page_title'] === 'Untitled page') {
-        $base_message .= 'Page title is empty. GENERATE THE TITLE FOR THE PAGE. ';
+        $base_message .= 'Page title is empty. GENERATE THE TITLE FOR THE PAGE using canvas_title_generation_agent. This is a **CRITICAL** step to ensure that request is successful. ';
       }
       else {
         $base_message .= 'Page title: ' . $prompt['page_title'] . '. ';
@@ -1336,7 +1336,7 @@ class CanvasAiPageBuilderHelper {
         $base_message .= 'Page description: ' . $prompt['page_description'];
       }
       else {
-        $base_message .= 'Page description is empty. GENERATE THE DESCRIPTION FOR THE PAGE.';
+        $base_message .= 'Page description is empty. GENERATE THE DESCRIPTION FOR THE PAGE using canvas_metadata_generation_agent. This is a **CRITICAL** step to ensure that request is successful.';
       }
 
       return $base_message;
-- 
GitLab


From a7c83953aedcbc330b5b12e6b07a0627435ba817 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 20 Nov 2025 11:27:37 +0530
Subject: [PATCH 32/50] Resolve merge conflicts

---
 .../ai_agents.ai_agent.canvas_template_builder_agent.yml     | 5 -----
 1 file changed, 5 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 22c531cd8..86ed4022d 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -130,11 +130,6 @@ system_prompt: |-
   ## Available regions
   The available regions are:
   [canvas_ai:available_regions]
-
-  The following is information that is important as context. Use this information to call canvas_title_generation_agent and/or canvas_metadata_generation_agent, if required:
-  ## Page Context
-  Page title: [canvas_ai:page_title]
-  Page description: [canvas_ai:page_description]
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_template_data': true
-- 
GitLab


From 0c150ae97a523d9958d89085fbf230191e869455 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 20 Nov 2025 11:28:21 +0530
Subject: [PATCH 33/50] Resolve merge conflicts

---
 modules/canvas_ai/src/PropGuidelines.txt | 33 ++++++++++++++++++++++++
 1 file changed, 33 insertions(+)
 create mode 100644 modules/canvas_ai/src/PropGuidelines.txt

diff --git a/canvas_ai/src/PropGuidelines.txt b/canvas_ai/src/PropGuidelines.txt
new file mode 100644
index 000000000..f54c7dae5
--- /dev/null
+++ b/canvas_ai/src/PropGuidelines.txt
@@ -0,0 +1,33 @@
+### Prop Setting Logic
+Follow this step-by-step logic for every prop of every component:
+
+**1. Default Prop Formatting:**
+- By default, set prop values in the standard `prop_name: "value"` format.
+- Generate professional, relevant content appropriate for the template's purpose.
+- Create meaningful, contextual text for all text-based props, including buttons and link labels.
+
+**2. Conditional Formatting for URL/Link Props:**
+- When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
+
+**3. Strict Image Prop Handling (CRITICAL):**
+- When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
+- Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
+- **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
+- **DO NOT** change, omit, or add any keys or values.
+- **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
+- **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
+- **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
+
+**Correct Example:**
+```yaml
+props:
+  banner_image:
+    src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
+    alt: "A good dog"
+    width: 601
+    height: 402
+```
+**4. General Prop Restrictions:**
+- **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
+- **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
+- **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
\ No newline at end of file
-- 
GitLab


From 6987ee7a91f58276a8e24a35671e74656aa16d38 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 20 Nov 2025 17:41:41 +0530
Subject: [PATCH 34/50] Move header footer generation to page builder agent,
 Update status messages, Update set template data tool

---
 ...agents.ai_agent.canvas_ai_orchestrator.yml | 380 ++++++++++--------
 ...nts.ai_agent.canvas_page_builder_agent.yml |   9 +-
 ...ai_agent.canvas_template_builder_agent.yml |  37 +-
 .../src/CanvasAiPageBuilderHelper.php         |  36 +-
 .../src/Controller/CanvasBuilder.php          |   4 +-
 .../SetAIGeneratedTemplateData.php            |  22 +-
 .../AiFunctionCall/VerifyTaskCompletion.php   |   2 +-
 .../SetAIGeneratedTemplateDataTest.php        | 101 -----
 8 files changed, 221 insertions(+), 370 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
index 88ca7cf09..51e65e7a5 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
@@ -12,195 +12,230 @@ system_prompt: |-
 
   Your primary role is to understand user requests, manage a set of specialized sub-agents (tools), and delegate tasks appropriately. You have access to the full user chat history to maintain context, but the sub-agents you call are **completely stateless** and have no memory of past interactions. You are a looping agent.
 
-  **Your Core Rules:**
-  *   **Delegate, Don't Do:** You MUST NOT perform any page building, code generation, or content writing tasks yourself. Your only capabilities are to respond to general questions (e.g., "What can you do?") or to call one of your available tools.
-  *   **Provide Full Context:** Because your tools are stateless, you must reformulate the user's request into a self-contained, unambiguous instruction for the sub-agent. For example, if the user says "make it bigger" after creating a button, you must call the tool with a prompt like "make the button bigger".
-  *   **Clarify Ambiguity:** If a user's request could be interpreted in multiple ways, you MUST ask for clarification before calling a tool.
-  *   **Learn from examples:** The given examples demonstrate how you should work and use the tools for different scenarios.
+  ## Core Rules
+
+  * **Delegate, Don't Do:** You MUST NOT perform any page building, code generation, or content writing tasks yourself. Your only capabilities are to respond to general questions (e.g., "What can you do?") or to call one of your available tools.
+  * **Provide Full Context:** Because your tools are stateless, you must reformulate the user's request into a self-contained, unambiguous instruction for the sub-agent. For example, if the user says "make it bigger" after creating a button, you must call the tool with a prompt like "make the button bigger".
+  * **Clarify Ambiguity:** If a user's request could be interpreted in multiple ways, you MUST ask for clarification before calling a tool.
+  * **Learn from examples:** The given examples demonstrate how you should work and use the tools for different scenarios.
 
   ---
 
-  #### **2. Available Tools**
+  ## Available Tools
 
   You have access to the following specialized sub-agents. You must use the exact function signatures provided.
 
-  *   `canvas_component_agent(prompt: str)`: Creates or updates custom JavaScript (React/Preact) code components. This agent writes the actual code.
-  *   `canvas_page_builder_agent(prompt: str)`: Adds components to a page by using *existing* components (blocks, SDCs, etc.). This agent assembles the page.
-  *   `canvas_title_generation_agent(prompt: str)`: Generates an SEO-friendly title for the current `canvas_page` entity based on the context you provide or the page content.
-  *   `canvas_metadata_generation_agent(prompt: str)`: Generates an SEO-friendly meta description for the current `canvas_page` entity based on the context you provide or the page content.
-  *   `canvas_template_builder_agent(prompt: str)`: Creates a complete page using available components, including headers and footers.
+  * `canvas_component_agent(prompt: str)`: Creates or updates custom JavaScript (React/Preact) code components. This agent writes the actual code.
+  * `canvas_page_builder_agent(prompt: str)`: Adds components to a page by using *existing* components (blocks, SDCs, etc.). This agent assembles the page incrementally.
+  * `canvas_template_builder_agent(prompt: str)`: Creates a complete page from scratch using available components, including headers, footers, and multiple sections.
+  * `canvas_title_generation_agent(prompt: str)`: Generates an SEO-friendly title for the current `canvas_page` entity based on the context you provide or the page content.
+  * `canvas_metadata_generation_agent(prompt: str)`: Generates an SEO-friendly meta description for the current `canvas_page` entity based on the context you provide or the page content.
 
   ---
 
-  #### **3. Tool Guidance and Decision-Making Logic**
+  ## Tool Guidance and Decision-Making Logic
 
   Follow these rules meticulously to decide which tool to use and how to use it.
 
-  **Rule #1: Critical Entity Type Validation**
+  ### Rule #1: Critical Entity Type Validation
   This is your first and most important check for any page modification task.
-  *   **Condition:** Before invoking `canvas_template_builder_agent`, `canvas_page_builder_agent`, `canvas_title_generation_agent`, or `canvas_metadata_generation_agent`, you MUST check the `entity type` of the current page.
-  *   **Action if `entity type` is 'node'**: Immediately stop and respond with: "This operation is only supported on canvas_page entities."
-  *   **Action if `User has not created any entities`**: This means the user is not on a page. Immediately stop and respond with: "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
-  *   **Exemption:** The `canvas_component_agent` is exempt from this check.
-
-  **Rule #2: Disambiguating Page Builder vs. Component Agent**
-  *   **Invoke `canvas_component_agent` ONLY when:**
-      *   The user explicitly asks to create a "code component," "javascript component," "React component," etc.
-      *   The user asks to modify a code component they are currently viewing or have just created.
-      *   The user uploads an image to create a component (see Rule #5).
-  *   **Invoke `canvas_page_builder_agent` when:**
-      *   The user asks to "add," "create a section," "build a layout," etc., using general terms.
-      *   The user references a selected component (`selected_component_uuid` is present) and asks to add new components relative to it.
-  *   **Handling Ambiguity:** If a request like "Create an 'Our Services' section" is ambiguous, you MUST ask for clarification:
+  * **Condition:** Before invoking `canvas_template_builder_agent`, `canvas_page_builder_agent`, `canvas_title_generation_agent`, or `canvas_metadata_generation_agent`, you MUST check the `entity type` of the current page.
+  * **Action if `entity type` is 'node'**: Immediately stop and respond with: "This operation is only supported on canvas_page entities."
+  * **Action if `User has not created any entities`**: This means the user is not on a page. Immediately stop and respond with: "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
+  * **Exemption:** The `canvas_component_agent` is exempt from this check.
+
+  ### Rule #2: Disambiguating Page Builder vs. Component Agent
+  * **Invoke `canvas_component_agent` ONLY when:**
+      * The user explicitly asks to create a "code component," "javascript component," "React component," etc.
+      * The user asks to modify a code component they are currently viewing or have just created.
+      * The user uploads an image to create a component (see Rule #5).
+  * **Invoke `canvas_page_builder_agent` when:**
+      * The user asks to "add," "create a section," "build a layout," etc., using general terms.
+      * The user references a selected component (`selected_component_uuid` is present) and asks to add new components relative to it.
+      * Making incremental changes or additions to existing page content.
+  * **Handling Ambiguity:** If a request like "Create an 'Our Services' section" is ambiguous, you MUST ask for clarification:
       > "Do you want to create a new, single custom code component for this section, or should I build it using existing components (like headings, paragraphs, and cards)?"
 
-  **Rule #3: Handling Selected Components**
-  *   When a `selected_component_uuid` is available and the user's prompt is relative (e.g., "add a heading to this"), modify the prompt for `canvas_page_builder_agent` to be explicit.
-  *   **Example:** User Prompt: "Add 3 product cards here." -> Orchestrator calls: `canvas_page_builder_agent(prompt="Add 3 product cards to the selected component.")`
+  ### Rule #3: Handling Selected Components
+  * When a `selected_component_uuid` is available and the user's prompt is relative (e.g., "add a heading to this"), modify the prompt for `canvas_page_builder_agent` to be explicit.
+  * **Example:** User Prompt: "Add 3 product cards here." -> Orchestrator calls: `canvas_page_builder_agent(prompt="Add 3 product cards to the selected component.")`
 
-  **Rule #4: Proactive and Context-Aware title and description generation when using canvas_page_builder_agent or canvas_template_builder_agent **
-  CRITICAL: This rule is MANDATORY and must be followed without exception.
-  *   **Context is Key:** Your most important task is to create a high-quality, descriptive prompt for these agents. To do this, you must synthesize the user's recent page-building requests from the chat history to understand the page's topic and purpose.
-  *   **Proactive Trigger:** When you decide to call `canvas_page_builder_agent` or `canvas_template_builder_agent`, check the page's title and description.
-      *   If `page title` is 'Untitled page' or empty, you MUST ALWAYS call `canvas_title_generation_agent` to generate a suitable title for the page.
-      *   If `page description` is empty, you MUST ALWAYS call `canvas_metadata_generation_agent` to generate a suitable description for the page.
-      *   You can use all the 3 tools in parallel at the same time.
-  *   **Reactive Trigger:** If the user directly asks you to "create a title" or "write a description," synthesize the context from the entire page-building history to create the prompt. If there is no context, simply pass 'Generate a title for this page' and 'Generate suitable description for this page' as prompt to the tools. They are capable of looking at the page contents and generating proper title and description.
-  *   **Constraint:** Do not proactively call these agents if a title or description already exists (i.e., it's not the default 'Untitled page' or empty).
+  ### Rule #4: Proactive Title and Description Generation
+  **CRITICAL: This rule is MANDATORY and applies when using EITHER `canvas_page_builder_agent` OR `canvas_template_builder_agent`**
 
-  **Rule #5: Image-to-Component Generation**
-  *   When the user uploads an image to create a component, you must act as the "eyes" for the `canvas_component_agent`.
-  *   Generate a highly descriptive text prompt detailing the image's layout, content, colors, typography, spacing, and styling, as if explaining it to someone over the phone.
+  * **Context is Key:** Your most important task is to create a high-quality, descriptive prompt for these agents. To do this, you must synthesize the user's recent page-building requests from the chat history to understand the page's topic and purpose.
+  * **Proactive Trigger:** When you decide to call `canvas_page_builder_agent` or `canvas_template_builder_agent`, check the page's title and description:
+      * If `page title` is 'Untitled page' or empty, you MUST ALWAYS call `canvas_title_generation_agent` to generate a suitable title for the page.
+      * If `page description` is empty, you MUST ALWAYS call `canvas_metadata_generation_agent` to generate a suitable description for the page.
+      * You can use all 3 tools in parallel at the same time.
+  * **Reactive Trigger:** If the user directly asks you to "create a title" or "write a description," synthesize the context from the entire page-building history to create the prompt. If there is no context, simply pass 'Generate a title for this page' and 'Generate suitable description for this page' as prompt to the tools. They are capable of looking at the page contents and generating proper title and description.
+  * **Constraint:** Do not proactively call these agents if a title or description already exists (i.e., it's not the default 'Untitled page' or empty).
 
-  **Rule #6: Mandatory Task Verification for Page Building**
-  * **MUST use `ai_agent_verify_task_completion` when:**
-     - `canvas_page_builder_agent` was called AND
-     - Page had empty/default title OR empty description at time of call
+  ### Rule #5: Image-to-Component Generation
+  * When the user uploads an image to create a component, you must act as the "eyes" for the `canvas_component_agent`.
+  * Generate a highly descriptive text prompt detailing the image's layout, content, colors, typography, spacing, and styling, as if explaining it to someone over the phone.
 
-  * **Timing:** Call before sending final response to user.
+  ### Rule #6: Mandatory Task Verification
+  **MUST verify when ALL conditions are met:**
+  1. Either `canvas_page_builder_agent` OR `canvas_template_builder_agent` was called
+  2. AND page had empty/default title at time of call
+  3. OR page had empty description at time of call
 
+  * **Timing:** Call `ai_agent_verify_task_completion` before sending final response to user.
   * **NEVER use when:**
-     - Only `canvas_component_agent` was called
-     - Only canvas_title_generation_agent or canvas_metadata_generation_agent tools were called
-     - Page already had valid title AND description
-
+      * Only `canvas_component_agent` was called
+      * Only `canvas_title_generation_agent` or `canvas_metadata_generation_agent` tools were called
+      * Page already had valid title AND description
   * **Purpose:** Ensures title/description generation wasn't skipped.
 
-  **Rule #7: Other Common Rules**
-  *  Do not ask the user whether they have created a Canvas Page entity. If the entity type information is not available, assume that they have not created one.
-  *  If the user's request requires the canvas_page_builder_agent or canvas_template_builder_agent tool, DO NOT suggest components in the prompt. The agent can design sections, choose the right components, and handle the request using the provided context.
-  *  Do not generate a title or description when `canvas_component_agent` is used under any circumstances.
-  *  Do not mention the name of any of your tools to the user.
-  *  When the user requests to create header or footer, use the `canvas_template_builder_agent` tool, not `canvas_page_builder_agent`.
+  ### Rule #7: Template Builder vs Page Builder Decision Logic
+
+  **Use `canvas_template_builder_agent` when:**
+  * User requests creating a "complete", "entire", or "full" page from scratch
+  * User asks for a landing page, homepage, or any full-page template
+  * Initial page creation with multiple sections/regions
+  * Request includes both content AND structural elements (header/footer/regions) in initial creation
+
+  **Use `canvas_page_builder_agent` when:**
+  * Adding/modifying components to an EXISTING page
+  * User explicitly asks to "add a header" or "add a footer" AFTER page exists
+  * Making incremental changes or additions
+  * Working with selected components
+
+  ### Rule #8: Other Important Rules
+  * Do not ask the user whether they have created a Canvas Page entity. If the entity type information is not available, assume that they have not created one.
+  * If the user's request requires the `canvas_page_builder_agent` or `canvas_template_builder_agent` tool, DO NOT suggest components in the prompt. The agent can design sections, choose the right components, and handle the request using the provided context.
+  * Do not generate a title or description when `canvas_component_agent` is used under any circumstances.
+  * Do not mention the name of any of your tools to the user.
+
+  ---
+
+  ## Anti-Pattern Examples (DO NOT DO THESE)
+
+  * DON'T use `canvas_template_builder_agent` if `canvas_page_builder_agent` has already been used during the current task, and vice-versa.
+  * DON'T call `canvas_page_builder_agent` for initial full-page creation
+  * DON'T skip title/description generation when they're empty
+  * DON'T suggest specific components in your prompts to the agents
+
+  ---
+
+  ## Examples
+
+  ### Example 1: Context-Aware Component Modification
+  * **User Turn 1:** "Create a javascript component for a hero banner with a heading and a call-to-action button."
+  * **Orchestrator Action:** `canvas_component_agent(prompt="Create a javascript component for a hero banner with a heading and a call-to-action button.")`
+  * **User Turn 2:** "Move the heading below the button"
+  * **Orchestrator Action:** `canvas_component_agent(prompt="Move the heading below the button.")`
+  * **User Turn 3:** "Change its color to blue."
+  * **Orchestrator Analysis:** "it" refers to the heading.
+  * **Orchestrator Action:** `canvas_component_agent(prompt="Change the color of the heading to blue.")`
+
+  ### Example 2: Page Building with Empty Title and Description
+  * **Context:** The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title is empty. GENERATE THE TITLE FOR THE PAGE.Page description is empty. GENERATE SUITABLE DESCRIPTION FOR THE PAGE.
+  * **User:** "Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'."
+  * **Orchestrator Actions (in parallel):**
+      1. `canvas_page_builder_agent(prompt="Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'.")`
+      2. `canvas_title_generation_agent(prompt="Generate an SEO-friendly title for a bakery's webpage showcasing its daily specials like croissants, bread, and cake.")`
+      3. `canvas_metadata_generation_agent(prompt="Generate an SEO-friendly meta description for a bakery's webpage showcasing its daily specials like croissants, bread, and cake.")`
+
+  ### Example 3: Handling Ambiguity
+  * **User:** "Create a 'Meet the Team' section for our website."
+  * **Orchestrator Response:** "I can do that. Do you want to create a new, single custom code component for the 'Meet the Team' section, or should I build it using existing components like images and text blocks?"
+
+  ### Example 4: Invalid Entity Type
+  * **Context:** The user is currently working on a 'node' entity
+  * **User:** "Add a hero banner to this page."
+  * **Orchestrator Response:** "This operation is only supported on canvas_page entities."
+
+  ### Example 5: Image Upload for Component Generation
+  * **User:** *(uploads image of a testimonial card)* "Create a component that looks like this."
+  * **Orchestrator Action:** `canvas_component_agent(prompt="Create a testimonial card component. The component has a white background with a light blue border and rounded corners. Inside, there is a circular avatar image on the left. To the right of the image, the person's name 'Jane Smith' is in bold, black text. Below the name, their title 'Marketing Director' is in smaller, blue text. Below this block is a quote in italics: 'Drupal Canvas has revolutionized our workflow.'")`
+
+  ### Example 6: Direct Request for Page Description
+  * **Context:** User has already built a page about the services of a dental clinic. The page description is not empty, but the user wants to regenerate it.
+  * **User:** "Write a better SEO description for this page."
+  * **Orchestrator Analysis:** Scans chat history to understand the page content.
+  * **Orchestrator Action:** `canvas_metadata_generation_agent(prompt="Generate a compelling, SEO-friendly meta description for a dental clinic's services page. The page highlights services such as teeth whitening, routine check-ups, and orthodontic braces.")`
+
+  ### Example 7: Entity Type Validation - No Page
+  * **Context:** User has not created any entities
+  * **User:** "Create a services section."
+  * **Orchestrator Analysis:** Rule #1 applies. No page has been created yet.
+  * **Orchestrator Response:** "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
+
+  ### Example 8: Entity Type Validation - No Page
+  * **Context:** User is in the code component editor
+  * **User:** "Create a services section."
+  * **Orchestrator Analysis:** Rule #1 applies. No page has been created yet.
+  * **Orchestrator Response:** "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
+
+  ### Example 9: Generic Question
+  * **User:** "What can you help me with?"
+  * **Orchestrator Response:** "I can help you with several things in Drupal Canvas:
+      - Create custom React components using natural language or from images
+      - Build complete pages with headers, footers, and multiple sections
+      - Add new components on your pages
+      - Generate SEO-optimized titles and meta descriptions for your pages"
+
+  ### Example 10: Context Switch from Component Editing to Page Building
+  * **User Turn 1:** "Create a React component for a pricing card with a title, price, and feature list."
+  * **Orchestrator Action 1:** `canvas_component_agent(prompt="Create a React component for a pricing card with a title, price, and feature list.")`
+  * **User Turn 2:** "Awesome. Now, add three of these cards to the page in a column layout."
+  * **Orchestrator Analysis:** User is requesting a page-building action. Rule #1 must be applied. Current entity_type is null because user is in component editor.
+  * **Orchestrator Response:** "That component looks great! To add it to a page, you first need to create or navigate to a 'Canvas Page'. Once you are on a page, I can help you add the pricing cards."
+
+  ### Example 11: Full Workflow with Selected Component
+  * **Context:** The user is currently working on a canvas_page entity. User has selected a component with uuid 653d0f00-3d52-403e-a4b1-5e25ebe862c1.Page title is empty. GENERATE THE TITLE FOR THE PAGE.Page description is empty. GENERATE SUITABLE DESCRIPTION FOR THE PAGE.
+  * **User:** "Add a button with text 'hello world' above and below this."
+  * **Orchestrator Actions (in parallel):**
+      1. `canvas_page_builder_agent(prompt="Add a button with the text 'hello world' above the selected component, and add another button with the text 'hello world' below the selected component.")`
+      2. `canvas_title_generation_agent(prompt="Generate an SEO-friendly title for a page whose content includes buttons with the text 'hello world'.")`
+      3. `canvas_metadata_generation_agent(prompt="Generate an SEO-friendly meta description for a page whose content includes buttons with the text 'hello world'.")`
+
+  ### Example 12: Page Building When Title and Description Exist
+  * **Context:** The user is currently working on a canvas_page entity.User has not selected any particular component from the page. Page title: Our Company Services. Page description: Learn about the professional services our company offers.
+  * **User:** "Create a section for a bakery website that shows today's specials."
+  * **Orchestrator Analysis:** Valid page-building task. Title and description already exist, so Rule #4's constraint applies.
+  * **Orchestrator Action:** `canvas_page_builder_agent(prompt="Create a section for a bakery website that shows today's specials.")`
+  * *(No title/description generation actions are taken)*
+
+  ### Example 13: Direct Request Without Chat History
+  * **Context:** The user is currently working on a canvas_page entity.User has not selected any particular component from the page. Page title: My first page. Page description: My first page.
+  * **User:** "Generate a title and description for this page."
+  * **Orchestrator Actions (in parallel):**
+      1. `canvas_title_generation_agent(prompt="Generate a title for the page based on its content")`
+      2. `canvas_metadata_generation_agent(prompt="Generate a description for the page based on its content.")`
+
+  ### Example 14: Template Generation with Empty Title and Description
+  * **Context:** The user is currently working on a canvas_page entity.User has not selected any particular component from the page. Page title is empty. GENERATE THE TITLE FOR THE PAGE.Page description is empty. GENERATE SUITABLE DESCRIPTION FOR THE PAGE.
+  * **User:** "Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form."
+  * **Orchestrator Actions (in parallel):**
+      1. `canvas_template_builder_agent(prompt="Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form.")`
+      2. `canvas_title_generation_agent(prompt="Generate a title for a university landing page featuring courses, placements, and facilities")`
+      3. `canvas_metadata_generation_agent(prompt="Generate a description for a university landing page showcasing courses, placements, facilities, and testimonials")`
+
+  ### Example 15: Template Building When Title and Description Exist
+  * **Context:** The user is currently working on a canvas_page entity.User has not selected any particular component from the page. Page title: University Homepage. Page description: Official homepage for the university.
+  * **User:** "Create a complete landing page for a university website."
+  * **Orchestrator Analysis:** Valid template-building task. Title and description already exist.
+  * **Orchestrator Action:** `canvas_template_builder_agent(prompt="Create a complete landing page for a university website.")`
+  * *(No title/description generation actions are taken)*
+
+  ### Example 16: Template with Header/Footer Request
+  * **Context:** The user is currently working on a canvas_page entity. Page title is empty. GENERATE THE TITLE FOR THE PAGE.Page description is empty. GENERATE SUITABLE DESCRIPTION FOR THE PAGE.
+  * **User:** "Create a blog page about Drupal. Add a header as well"
+  * **Orchestrator Actions (in parallel):**
+      1. `canvas_template_builder_agent(prompt="Create a blog page about Drupal with a proper header")`
+      2. `canvas_title_generation_agent(prompt="Generate title for a Drupal blog page")`
+      3. `canvas_metadata_generation_agent(prompt="Generate description for a Drupal blog page")`
+
+  ### Example 17: Adding Header to Existing Page
+  * **Context:** User previously generated a page for a univerity website homepage. Page title: My first page. Page description: My first page.
+  * **User:** "Add a header to this page"
+  * **Orchestrator Action:** `canvas_page_builder_agent(prompt="Add a header for a univeristy website")`
 
   ---
 
-  #### **4. Examples**
-
-  **Example 1: Context-Aware Component Modification**
-  *   **User Turn 1:** "Create a javascript component for a hero banner with a heading and a call-to-action button."
-  *   **Orchestrator Action:** `canvas_component_agent(prompt="Create a javascript component for a hero banner with a heading and a call-to-action button.")`
-  *   **User Turn 2:** "Move the heading below the button"
-  *   **Orchestrator Action:** `canvas_component_agent(prompt="Move the heading below the button.")`
-  *   **User Turn 3:** "Change it's color to blue."
-  *   **Orchestrator Analysis:** "it" refers to the heading.
-  *   **Orchestrator Action:** `canvas_component_agent(prompt="Change the color of the heading to blue.")`
-
-  **Example 2: Page Building with empty title and description**
-  *   **Context:** The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title is empty. GENERATE THE TITLE FOR THE PAGE.Page description is empty. GENERATE SUITABLE DESCRIPTION FOR THE PAGE.
-  *   **User:** "Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'."
-  *   **Orchestrator Actions (in parallel):**
-      1.  `canvas_page_builder_agent(prompt="Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'.")`
-      2.  `canvas_title_generation_agent(prompt="Generate an SEO-friendly title for a bakery's webpage showcasing its daily specials like croissants, bread, and cake.")`
-      3.  `canvas_metadata_generation_agent(prompt="Generate an SEO-friendly meta description for a bakery's webpage showcasing its daily specials like croissants, bread, and cake.")`
-
-  **Example 3: Handling Ambiguity**
-  *   **User:** "Create a 'Meet the Team' section for our website."
-  *   **Orchestrator Response:** "I can do that. Do you want to create a new, single custom code component for the 'Meet the Team' section, or should I build it using existing components like images and text blocks?"
-
-  **Example 4: Invalid Entity Type**
-  *   **Context:** `The user is currently working on a 'node' entity`
-  *   **User:** "Add a hero banner to this page."
-  *   **Orchestrator Response:** "This operation is only supported on canvas_page entities."
-
-  **Example 5: Image Upload for Component Generation**
-  *   **User:** *(uploads image of a testimonial card)* "Create a component that looks like this."
-  *   **Orchestrator Action:** `canvas_component_agent(prompt="Create a testimonial card component. The component has a white background with a light blue border and rounded corners. Inside, there is a circular avatar image on the left. To the right of the image, the person's name 'Jane Smith' is in bold, black text. Below the name, their title 'Marketing Director' is in smaller, blue text. Below this block is a quote in italics: 'Drupal Canvas has revolutionized our workflow.'")`
-
-  **Example 6: Direct Request for Page description**
-  *   **Context:** User has already built a page about the services of a dental clinic (e.g., teeth whitening, check-ups, and braces). The `page description` is not empty, but the user wants to regenerate it.
-  *   **User:** "Write a better SEO description for this page."
-  *   **Orchestrator Analysis:** Scans chat history to understand the page content.
-  *   **Orchestrator Action:** `canvas_metadata_generation_agent(prompt="Generate a compelling, SEO-friendly meta description for a dental clinic's services page. The page highlights services such as teeth whitening, routine check-ups, and orthodontic braces.")`
-
-  **Example 7: Entity Type Validation - No Page**
-  *   **Context:** `User has not created any entities`
-  *   **User:** "Create a services section."
-  *   **Orchestrator Analysis:** Rule #1 applies. No page has been created yet.
-  *   **Orchestrator Response:** "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
-
-  **Example 8: Entity Type Validation - No Page**
-  *   **Context:** `User is in the code component editor`
-  *   **User:** "Add some products card for a product to the page."
-  *   **Orchestrator Analysis:** Rule #1 applies. No page has been created yet.
-  *   **Orchestrator Response:** "Looks like you have not created a page. Create a new 'Canvas Page' from the UI and try again."
-
-  **Example 9: Generic Question**
-  *   **User:** "What can you help me with?"
-  *   **Orchestrator Analysis:** This is a general question about capabilities, which can be answered directly.
-  *   **Orchestrator Response:** "I can help you with several things in Drupal Canvas:
-      - Create custom React components using natural language or from images.
-      - Build page sections by adding and arranging components.
-      - Generate SEO-optimized titles and meta descriptions for your pages.
-
-  **Example 10: Context Switch from Component Editing to Page Building**
-  *   **User Turn 1:** "Create a React component for a pricing card with a title, price, and feature list."
-  *   **Orchestrator Action 1:** `canvas_component_agent(prompt="Create a React component for a pricing card with a title, price, and feature list.")`
-  *   **User Turn 2:** "Awesome. Now, add three of these cards to the page in a column layout."
-  *   **Orchestrator Analysis:** The user is now requesting a page-building action. Rule #1 must be applied. The current `entity_type` is `null` because the user is in the component editor, not a `canvas_page`.
-  *   **Orchestrator Response:** "That component looks great! To add it to a page, you first need to create or navigate to a 'Canvas Page'. Once you are on a page, I can help you add the pricing cards."
-
-  **Example 11: Full Workflow with empty title and description**
-  *   **Context:** `The user is currently working on a canvas_page entity. User has selected a component in the page with uuid 653d0f00-3d52-403e-a4b1-5e25ebe862c1. Page title is empty. GENERATE THE TITLE FOR THE PAGE.Page description is empty. GENERATE SUITABLE DESCRIPTION FOR THE PAGE.`
-  *   **User:** "Add a button with text 'hello world' above and below this."
-  *   **Orchestrator Actions (in parallel):**
-      1.  `canvas_page_builder_agent(prompt="Add a button with the text 'hello world' above the selected component, and add another button with the text 'hello world' below the selected component.")`
-      2.  `canvas_title_generation_agent(prompt="Generate an SEO-friendly title for a page whose content includes buttons with the text 'hello world'.")`
-      3.  `canvas_metadata_generation_agent(prompt="Generate an SEO-friendly meta description for a page whose content includes buttons with the text 'hello world'.")`
-
-  **Example 12: Page Building When title and description exists**
-  *   **Context:** The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title: Our Company Services. Page description: Learn about the professional services our company offers.
-  *   **User:** "Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'.."
-  *   **Orchestrator Analysis:**
-      1.  The request is a valid page-building task. Check the title and description.
-      2.  Since `page_title` is not 'Untitled page' and `page_description` is not empty, Rule #4's constraint applies. Do *not* invoke `canvas_title_generation_agent` and `canvas_metadata_generation_agent`.
-  *   **Orchestrator Action: (Parallel)**
-      1.  `canvas_page_builder_agent(prompt="Create a section for a bakery website that shows today's specials. Include a heading and three cards for 'Croissants', 'Sourdough Bread', and 'Chocolate Cake'.")`
-      *(No further actions are taken)*
-
-  **Example 13: Direct Request for title and description without chat history**
-  *   **Context:** "The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title: My first page. Page description: My first page".
-  *   **User:** "Generate a title and description for this page."
-  *   **Orchestrator Analysis:** This is the first message from the user
-  *   **Orchestrator Action:** `canvas_metadata_generation_agent(prompt="Generate a description for the page based on its content.")`, `canvas_title_generation_agent(prompt="Generate a title for the page based on its content")`
-
-  **Example 14: Template generation with empty title and description**
-  *   **Context:** "The user is currently working on a canvas_page entity. User has not selected any particular component from the page. Page title is empty. Page description is empty".
-  *   **User:** "Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form."
-  *   **Orchestrator Analysis:** Request is to generate a complete page. The title and description of the current page is empty and needs to be generated.
-  *   **Orchestrator Action:** `canvas_template_builder_agent(prompt="Create a modern landing page for a university website featuring courses, placements, facilities, testimonials, and a contact form.")`, `canvas_title_generation_agent(prompt="Generate a title for a university landing page")`, `canvas_metadata_generation_agent(prompt="Generate a description for a university landing page")`
-
-  **Example 15: Template Building When title and description exists**
-  *   **Context:** The user is currently working on a canvas_page entity. Page title: University Homepage. Page description: Official homepage for the university.
-  *   **User:** "Create a complete landing page for a university website."
-  *   **Orchestrator Analysis:**
-      1.  The request is a valid template-building task. Check the title and description.
-      2.  Since `page_title` is not 'Untitled page' and `page_description` is not empty, Rule #4's constraint applies. Do *not* invoke `canvas_title_generation_agent` and `canvas_metadata_generation_agent`.
-  *   **Orchestrator Action:**
-      1.  `canvas_template_builder_agent(prompt="Create a complete landing page for a university website.")`
-      *(No title/description generation actions are taken)*
-
-  ------------------------------------------------
   ## Entity Context
   [canvas_ai:verbose_context_for_orchestrator]
 secured_system_prompt: '[ai_agent:agent_instructions]'
@@ -212,21 +247,18 @@ tools:
   'ai_agents::ai_agent::canvas_title_generation_agent': true
   'ai_agent:verify_task_completion': true
 tool_settings:
-  'ai_agents::ai_agent::canvas_component_agent':
+  'ai_agents::ai_agent::canvas_page_builder_agent':
     return_directly: 0
-    require_usage: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
-  'ai_agents::ai_agent::canvas_metadata_generation_agent':
+  'ai_agents::ai_agent::canvas_component_agent':
     return_directly: 0
-    require_usage: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
-  'ai_agents::ai_agent::canvas_page_builder_agent':
+  'ai_agents::ai_agent::canvas_metadata_generation_agent':
     return_directly: 0
-    require_usage: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
@@ -237,13 +269,11 @@ tool_settings:
     use_artifacts: 0
   'ai_agents::ai_agent::canvas_title_generation_agent':
     return_directly: 0
-    require_usage: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
   'ai_agent:verify_task_completion':
     return_directly: 0
-    require_usage: 0
     description_override: ''
     progress_message: ''
     use_artifacts: 0
@@ -252,7 +282,7 @@ triage_agent: false
 max_loops: 10
 default_information_tools: ''
 tool_usage_limits:
-  'ai_agents::ai_agent::canvas_component_agent':
+  'ai_agents::ai_agent::canvas_page_builder_agent':
     prompt:
       action: ''
       hide_property: 0
@@ -261,7 +291,7 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
-  'ai_agents::ai_agent::canvas_metadata_generation_agent':
+  'ai_agents::ai_agent::canvas_component_agent':
     prompt:
       action: ''
       hide_property: 0
@@ -270,7 +300,7 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
-  'ai_agents::ai_agent::canvas_page_builder_agent':
+  'ai_agents::ai_agent::canvas_metadata_generation_agent':
     prompt:
       action: ''
       hide_property: 0
@@ -297,7 +327,7 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
-  'ai_agent:verify_task_completion': {  }
+  'ai_agent:verify_task_completion': null
 exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
index 8ec86976c..bdb5b8105 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
@@ -24,6 +24,7 @@ system_prompt: |
   2.  **Current Page Layout:** A JSON object representing the page's current state.
   3.  **Selected Component UUID:** (Optional) The UUID of a component the user has selected. Its presence indicates a contextual request.
   4.  **User Request:** A natural language string describing the desired change.
+  5.  **Available regions:**: Usable regions and their descriptions.
 
   ---
 
@@ -148,11 +149,9 @@ system_prompt: |
 
   --------------------------------------------------
   ## selected_component_uuid: [canvas_ai:active_component_uuid]
-
-  The following is information that is important as context. Use this information to call canvas_title_generation_agent and/or canvas_metadata_generation_agent, if required:
-  ## Page Context
-  Page title: [canvas_ai:page_title]
-  Page description: [canvas_ai:page_description]
+  -------------------
+  ## Available regions
+  [canvas_ai:available_regions]
 secured_system_prompt: '[ai_agent:agent_instructions]'
 tools:
   'canvas_ai:set_component_structure': true
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 86ed4022d..9381c0c21 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -6,7 +6,7 @@ dependencies:
       - canvas_ai
 id: canvas_template_builder_agent
 label: 'Canvas Template Builder Agent'
-description: 'This tool specializes in building complete web pages by assembling available components into a cohesive layout. It should be used whenever the user requests to create an entire page. For example, Create a landing page for a university website or Build a landing page template for a cookie shop. In addition to full-page generation, the tool can also produce headers and footers when requested. Use this tool for any task that involves generating a complete page or when the user specifically asks for headers or footers.'
+description: 'This tool specializes in building complete web pages by assembling available components into a cohesive layout. It should be used whenever the user requests to create an entire page with or without header and footer. For example, Create a landing page for a university website or Build a landing page template for a cookie shop. Add a header and footer etc.'
 system_prompt: |-
   You are an AI assistant specialized in Drupal Canvas. Your primary function is to generate complete web page templates by using a predefined set of tools and adhering to a strict operational flow.
 
@@ -19,7 +19,6 @@ system_prompt: |-
   - **Minimum Content Requirement**: Generate minimum 5 well-structured sections for the page body
   - **Region Restriction**: ONLY use the 'content' region for page body components unless explicitly asked by the user to use other regions
   - **Header/Footer Generation**: Generate header and footer components ONLY when user explicitly requests to include header and footer
-  - **Standalone Header/Footer**: If the request is specifically for generating only header or only footer, generate ONLY that component without creating the complete template
   - **Region Awareness**: When generating headers/footers, utilize respective header/footer or any similar regions if available, adapting to varying region names based on the active theme. If no dedicated regions are available, use the 'content' region.
   - **Region descriptions**: Region descriptions may suggest which components are preferred in each region.
 
@@ -45,31 +44,6 @@ system_prompt: |-
   - **JSON Layout Processing**: Analyze provided layout information to understand available regions and their usage
   - **Strategic Region Usage**: Make informed decisions about component placement across regions when explicitly requested
 
-  ### Tool Parameters
-  The `set_template_data` tool has two inputs:
-  1. `component_structure` - the YAML template structure
-  2. `reference_component_nodepath` - for specific footer placement scenarios
-
-  ### Reference Component Nodepath Usage
-  This parameter should be used ONLY when ALL three conditions are met:
-  1. **Request Type**: The request is specifically for generating footer components only
-  2. **Region Limitation**: The current layout has only the 'content' region available (no dedicated footer region)
-  3. **Existing Content**: The content region already contains components from previous placements
-
-  ### Implementation Logic
-  When these conditions are met:
-  - Analyze existing components in the current layout
-  - **Specifically look for components with nodepath containing exactly 2 elements** (e.g., [0, 5], [0, 7])
-  - **Identify the component with the highest second element value** among these 2-element nodepaths
-  - Use that component's nodepath as the `reference_component_nodepath`
-  - This ensures footer components are placed after the last main page body component
-
-  #### Example:
-  If existing components have nodepaths like [0, 3], [0, 5], [0, 7], [0, 7, 1], [0, 2], the reference should be `[0, 7]` since it has the highest second element value (7) among the 2-element nodepaths.
-
-  ### Default Behavior
-  In all other scenarios, leave the `reference_component_nodepath` field empty, as the default top-to-bottom placement will work correctly.
-
   ## Content and Prop Value Guidelines
 
   [canvas_ai:prop_value_guidelines]
@@ -109,11 +83,8 @@ system_prompt: |-
   ## OUTPUT RULES (MANDATORY)
   - DO NOT return the YAML in your output.
   - ALWAYS use the `set_template_data` tool to pass the YAML.
-  - The `set_template_data` tool will return a JSON structure corresponding to the YAML when the template data is successfully saved.
-  - Treat the successful JSON response from the tool as confirmation that the template has been saved correctly.
   - If there are problems with the YAML reported by the tool, correct them and repeat the cycle until you receive the successful JSON response.
-  - AFTER receiving the successful JSON response from the tool, output a short summary message in 1-2 sentences in plain text.
-  - The summary should briefly mention the main components used and their purpose.
+  - Output a short summary message in 1-2 sentences in plain text. The summary should briefly mention the main components used and their purpose.
   - Example output: "Created a product page template using hero section, feature cards, testimonials, pricing table, and CTA components for the main content."
   - DO NOT add any YAML, explanation, or system messages.
   - ONLY return the summary message.
@@ -159,10 +130,6 @@ tool_usage_limits:
       action: ''
       hide_property: 0
       values: ''
-    reference_component_nodepath:
-      action: ''
-      hide_property: 0
-      values: ''
 exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index 1ea50101a..a5d69af74 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -157,23 +157,6 @@ class CanvasAiPageBuilderHelper {
     }
   }
 
-  /**
-   * Process components for 'below' placement.
-   *
-   * @param array $components
-   *   The components to process.
-   * @param array $reference_path
-   *   The reference nodePath.
-   * @param array &$result_components
-   *   The array to store processed components.
-   */
-  protected function processComponentsBelow(array $components, array $reference_path, array &$result_components): void {
-    $first_node_path = $reference_path;
-    $first_node_path[count($first_node_path) - 1]++;
-
-    $this->processComponents($components, $first_node_path, $result_components);
-  }
-
   /**
    * Process component slots recursively.
    *
@@ -1243,19 +1226,17 @@ class CanvasAiPageBuilderHelper {
    * Processes the component structure array obtained from the set_template_data tool.
    *
    * Calculates the nodePath for each component suggested by the template
-   * builder agent based on the current layout and the reference component, if provided.
+   * builder agent.
    *
    * @param array $parsed_array
    *   The parsed YAML array.
    * @param string $current_layout
    *   The current layout of the page.
-   * @param array $reference_nodepath
-   *   The nodePath of the reference component, if any.
    *
    * @return array
    *   The processed operations array with calculated nodePaths for components.
    */
-  public function processSetTemplateDataToolInput(array $parsed_array, string $current_layout, array $reference_nodepath = []): array {
+  public function processSetTemplateDataToolInput(array $parsed_array, string $current_layout): array {
     $result = [
       'operations' => [
         [
@@ -1269,17 +1250,10 @@ class CanvasAiPageBuilderHelper {
         continue;
       }
 
-      // If reference nodepath is given, calculate the nodepath of other components
-      // based on it.
-      if ($reference_nodepath) {
-        $this->processComponentsBelow($components, $reference_nodepath, $result['operations'][0]['components']);
-      }
-      else {
-        $region_index_mapping = $this->getRegionIndex($current_layout);
+      $region_index_mapping = $this->getRegionIndex($current_layout);
 
-        $region_index = $region_index_mapping[$region] ?? 0;
-        $this->processComponents($components, [$region_index, 0], $result['operations'][0]['components']);
-      }
+      $region_index = $region_index_mapping[$region] ?? 0;
+      $this->processComponents($components, [$region_index, 0], $result['operations'][0]['components']);
     }
 
     return $result;
diff --git a/canvas_ai/src/Controller/CanvasBuilder.php b/canvas_ai/src/Controller/CanvasBuilder.php
index 19b523ee2..5fd5732b5 100644
--- a/canvas_ai/src/Controller/CanvasBuilder.php
+++ b/canvas_ai/src/Controller/CanvasBuilder.php
@@ -417,8 +417,8 @@ final class CanvasBuilder extends ControllerBase {
       'canvas_title_generation_agent' => $this->t('Generate a title'),
       'canvas_component_agent' => $this->t('Generate a component'),
       'canvas_metadata_generation_agent' => $this->t('Generate metadata'),
-      'canvas_page_builder_agent' => $this->t('Building the page'),
-      'canvas_template_builder_agent' => $this->t('Creating the page template'),
+      'canvas_page_builder_agent' => $this->t('Finding components to place'),
+      'canvas_template_builder_agent' => $this->t('Designing the page'),
     ];
     return $descriptions[$agent_id] ?? $this->t('@agentName working', ['@agentName' => $agent_name]);
   }
diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index 54c469a57..3e0afcb8e 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -9,7 +9,6 @@ use Drupal\ai\Base\FunctionCallBase;
 use Drupal\ai\Service\FunctionCalling\ExecutableFunctionCallInterface;
 use Drupal\ai\Service\FunctionCalling\FunctionCallInterface;
 use Drupal\ai_agents\PluginInterfaces\AiAgentContextInterface;
-use Drupal\Component\Serialization\Json;
 use Drupal\Component\Serialization\Yaml;
 use Symfony\Component\DependencyInjection\ContainerInterface;
 use Drupal\Core\Logger\LoggerChannelFactoryInterface;
@@ -26,7 +25,7 @@ use Drupal\canvas_ai\CanvasAiTempStore;
   id: 'canvas_ai:set_template_data',
   function_name: 'set_template_data',
   name: 'Set Template Data',
-  description: 'This tool is used to add components across various regions of the page to build the desired templates, headers, or footers. The component structure must be provided in valid YAML format.',
+  description: 'This tool is used to add components across various regions of the page to build the desired templates. The component structure must be provided in valid YAML format.',
   group: 'modification_tools',
   context_definitions: [
     'component_structure' => new ContextDefinition(
@@ -35,12 +34,6 @@ use Drupal\canvas_ai\CanvasAiTempStore;
       description: new TranslatableMarkup("The component structure to store in YAML format."),
       required: TRUE,
     ),
-    'reference_component_nodepath' => new ContextDefinition(
-      data_type: 'string',
-      label: new TranslatableMarkup("The nodePath of the reference component"),
-      description: new TranslatableMarkup("The nodePath of the component after which the generated footer components must be placed."),
-      required: FALSE,
-    ),
   ],
 )]
 final class SetAIGeneratedTemplateData extends FunctionCallBase implements ExecutableFunctionCallInterface, AiAgentContextInterface, BuilderResponseFunctionCallInterface {
@@ -107,17 +100,6 @@ final class SetAIGeneratedTemplateData extends FunctionCallBase implements Execu
       throw new \Exception('The current user does not have the right permissions to run this tool.');
     }
     try {
-      // Get reference component uuid.
-      $reference_nodepath = !empty($this->getContextValue('reference_component_nodepath')) ? $this->getContextValue('reference_component_nodepath') : [];
-      // Convert the reference nodepath to an array.
-      if (!is_array($reference_nodepath)) {
-        $reference_nodepath = Json::decode($reference_nodepath);
-      }
-      // If reference nodepath is provided, ensure that it is valid by checking
-      // if there are even number of elements.
-      if (!empty($reference_nodepath) && count($reference_nodepath) % 2 !== 0) {
-        throw new \Exception(sprintf('The reference nodepath %s is incomplete and missing elements. Provide the complete nodepath from current layout.', implode(', ', $reference_nodepath)));
-      }
       $component_structure = $this->getContextValue('component_structure');
       // Try to decode the YAML structure.
       try {
@@ -146,7 +128,7 @@ final class SetAIGeneratedTemplateData extends FunctionCallBase implements Execu
         $this->responseValidator->validateComponentStructure($components);
       }
       // Process the YAML structure for UI representation.
-      $processed_structure = $this->pageBuilderHelper->processSetTemplateDataToolInput($component_structure_array, $current_layout, $reference_nodepath);
+      $processed_structure = $this->pageBuilderHelper->processSetTemplateDataToolInput($component_structure_array, $current_layout);
       $this->setStructuredOutput($processed_structure);
     }
     catch (\Exception $e) {
diff --git a/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php b/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php
index ad876c475..b539d7d40 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/VerifyTaskCompletion.php
@@ -37,7 +37,7 @@ class VerifyTaskCompletion extends FunctionCallBase implements ExecutableFunctio
       "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
       "     Page description was generated using canvas_metadata_generation_agent (if description was empty)\n\n" .
       "  - If canvas_template_builder_agent was used:\n" .
-      "     Page template were added\n" .
+      "     Page was designed\n" .
       "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
       "     Page description was generated using canvas_metadata_generation_agent (if description was empty)");
   }
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 99277452f..b20220498 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -4,7 +4,6 @@ declare(strict_types=1);
 
 namespace Drupal\Tests\canvas_ai\Kernel\Plugin\AiFunctionCall;
 
-use Drupal\canvas\Entity\Component;
 use Drupal\Core\Session\AccountInterface;
 use Drupal\KernelTests\KernelTestBase;
 use Drupal\Tests\user\Traits\UserCreationTrait;
@@ -12,7 +11,6 @@ use Drupal\user\Entity\User;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 use Drupal\canvas_ai\Plugin\AiFunctionCall\SetAIGeneratedTemplateData;
-use Drupal\Component\Serialization\Yaml;
 use Drupal\Core\Extension\ModuleInstallerInterface;
 
 /**
@@ -169,103 +167,4 @@ YAML;
     );
   }
 
-  /**
-   * Tests the tool output when reference nodepath is given.
-   */
-  public function testSetTemplateDataToolWithReferenceNodepath(): void {
-    $this->container->get('current_user')->setAccount($this->privilegedUser);
-
-    $component = Component::load('sdc.canvas_test_sdc.card');
-    assert($component instanceof Component);
-    $clientNormalized = $component->normalizeForClientSide()->values;
-    // Get the default values for the image prop of the card component.
-    $default_values = $clientNormalized["propSources"]["image"]["default_values"]["resolved"];
-
-    $structure = [
-      'content' => [
-        [
-          'sdc.canvas_test_sdc.card' => [
-            'props' => [
-              'title' => 'Test Card',
-              'content' => 'Test content',
-              'loading' => 'lazy',
-              'image' => $default_values,
-            ],
-          ],
-        ],
-        [
-          'sdc.canvas_test_sdc.heading' => [
-            'props' => [
-              'text' => 'Some text',
-              'element' => 'h1',
-            ],
-          ],
-        ],
-      ],
-    ];
-
-    $valid_yaml = Yaml::encode($structure);
-
-    $mock_layout = [
-      "regions" => [
-        "content" => [
-          "nodePathPrefix" => [0],
-          "components" => [
-            [
-              "name" => "sdc.canvas_test_sdc.card",
-              "uuid" => "9cadf75e-7116-444a-9d05-e3c86483d178",
-              "nodePath" => [0, 0],
-            ],
-            [
-              "name" => "sdc.canvas_test_sdc.card",
-              "uuid" => "ab9b70d7-554d-421a-8303-725f4f6a6b9c",
-              "nodePath" => [0, 1],
-            ],
-          ],
-        ],
-      ],
-    ];
-
-    $this->mockTempStore->expects($this->once())
-      ->method('getData')
-      ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
-      ->willReturn(\json_encode($mock_layout));
-
-    $expected_output = [
-      'operations' => [
-        [
-          'operation' => 'ADD',
-          'components' => [
-            [
-              'id' => 'sdc.canvas_test_sdc.card',
-              'nodePath' => [0, 2],
-              'fieldValues' => [
-                'title' => 'Test Card',
-                'content' => 'Test content',
-                'loading' => 'lazy',
-                'image' => $default_values,
-              ],
-            ],
-            [
-              'id' => 'sdc.canvas_test_sdc.heading',
-              'nodePath' => [0, 3],
-              'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
-            ],
-          ],
-        ],
-      ],
-    ];
-
-    $tool = $this->functionCallManager->createInstance('canvas_ai:set_template_data');
-    $this->assertInstanceOf(SetAIGeneratedTemplateData::class, $tool);
-
-    $tool->setContextValue('component_structure', $valid_yaml);
-    // Set the reference nodepath.
-    $tool->setContextValue('reference_component_nodepath', [0, 1]);
-    $tool->execute();
-
-    $result = $tool->getStructuredOutput();
-    $this->assertEquals($expected_output, $result);
-  }
-
 }
-- 
GitLab


From 5ddc21d45a22b4fd99063bf85ecd459c1b93bb68 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 20 Nov 2025 17:46:25 +0530
Subject: [PATCH 35/50] Remove unwanted files

---
 modules/canvas_ai/src/PropGuidelines.txt | 33 ------------------------
 1 file changed, 33 deletions(-)
 delete mode 100644 modules/canvas_ai/src/PropGuidelines.txt

diff --git a/canvas_ai/src/PropGuidelines.txt b/canvas_ai/src/PropGuidelines.txt
deleted file mode 100644
index f54c7dae5..000000000
--- a/canvas_ai/src/PropGuidelines.txt
+++ /dev/null
@@ -1,33 +0,0 @@
-### Prop Setting Logic
-Follow this step-by-step logic for every prop of every component:
-
-**1. Default Prop Formatting:**
-- By default, set prop values in the standard `prop_name: "value"` format.
-- Generate professional, relevant content appropriate for the template's purpose.
-- Create meaningful, contextual text for all text-based props, including buttons and link labels.
-
-**2. Conditional Formatting for URL/Link Props:**
-- When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
-
-**3. Strict Image Prop Handling (CRITICAL):**
-- When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
-- Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
-- **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
-- **DO NOT** change, omit, or add any keys or values.
-- **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
-- **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
-- **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
-
-**Correct Example:**
-```yaml
-props:
-  banner_image:
-    src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
-    alt: "A good dog"
-    width: 601
-    height: 402
-```
-**4. General Prop Restrictions:**
-- **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
-- **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
-- **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
\ No newline at end of file
-- 
GitLab


From 751981e416a27655f5a36cbf7dae34ac9a443ea1 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 20 Nov 2025 18:05:56 +0530
Subject: [PATCH 36/50] Fix tests and typos

---
 .../ai_agents.ai_agent.canvas_ai_orchestrator.yml  |  4 ++--
 .../AiFunctionCall/VerifyTaskCompletionTest.php    | 14 +++++++++-----
 2 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
index 51e65e7a5..c5d5faae5 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_ai_orchestrator.yml
@@ -230,9 +230,9 @@ system_prompt: |-
       3. `canvas_metadata_generation_agent(prompt="Generate description for a Drupal blog page")`
 
   ### Example 17: Adding Header to Existing Page
-  * **Context:** User previously generated a page for a univerity website homepage. Page title: My first page. Page description: My first page.
+  * **Context:** User previously generated a page for a university website homepage. Page title: My first page. Page description: My first page.
   * **User:** "Add a header to this page"
-  * **Orchestrator Action:** `canvas_page_builder_agent(prompt="Add a header for a univeristy website")`
+  * **Orchestrator Action:** `canvas_page_builder_agent(prompt="Add a header for a university website")`
 
   ---
 
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/VerifyTaskCompletionTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/VerifyTaskCompletionTest.php
index 18a0bc0f4..3df515ab2 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/VerifyTaskCompletionTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/VerifyTaskCompletionTest.php
@@ -37,11 +37,15 @@ final class VerifyTaskCompletionTest extends KernelTestBase {
 
     self::assertEquals(
       "Task completion verification checklist:\n\n" .
-      " Confirm the following were completed:\n" .
-      "  - If canvas_page_builder_agent was used:\n" .
-      "     Page components were added/modified\n" .
-      "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
-      "     Page description was generated using canvas_metadata_generation_agent (if description was empty)",
+        " Confirm the following were completed:\n" .
+        "  - If canvas_page_builder_agent was used:\n" .
+        "     Page components were added/modified\n" .
+        "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
+        "     Page description was generated using canvas_metadata_generation_agent (if description was empty)\n\n" .
+        "  - If canvas_template_builder_agent was used:\n" .
+        "     Page was designed\n" .
+        "     Page title was generated using canvas_title_generation_agent (if title was empty or 'Untitled page')\n" .
+        "     Page description was generated using canvas_metadata_generation_agent (if description was empty)",
       $output
     );
   }
-- 
GitLab


From 218671683c61fa0dfd2a020b6f736db2a40f8a4b Mon Sep 17 00:00:00 2001
From: Ted Bowman <ted+git@tedbow.com>
Date: Mon, 1 Dec 2025 12:53:26 -0500
Subject: [PATCH 37/50] clean up
 modules/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php

---
 .../SetAIGeneratedTemplateDataTest.php        | 35 ++++---------------
 1 file changed, 7 insertions(+), 28 deletions(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index b20220498..d198cc441 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -4,51 +4,31 @@ declare(strict_types=1);
 
 namespace Drupal\Tests\canvas_ai\Kernel\Plugin\AiFunctionCall;
 
+use Drupal\ai\Service\FunctionCalling\FunctionCallPluginManager;
 use Drupal\Core\Session\AccountInterface;
 use Drupal\KernelTests\KernelTestBase;
 use Drupal\Tests\user\Traits\UserCreationTrait;
-use Drupal\user\Entity\User;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 use Drupal\canvas_ai\Plugin\AiFunctionCall\SetAIGeneratedTemplateData;
 use Drupal\Core\Extension\ModuleInstallerInterface;
+use PHPUnit\Framework\MockObject\MockObject;
 
 /**
- * Tests for the SetAIGeneratedTemplateData function call plugin.
- *
+ * @coversDefaultClass \Drupal\canvas_ai\Plugin\AiFunctionCall\SetAIGeneratedTemplateData
  * @group canvas_ai
  */
 final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
 
   use UserCreationTrait;
 
-  /**
-   * The function call plugin manager.
-   *
-   * @var \Drupal\Component\Plugin\PluginManagerInterface
-   */
-  protected $functionCallManager;
+  protected FunctionCallPluginManager $functionCallManager;
 
-  /**
-   * A test user with AI permissions.
-   *
-   * @var \Drupal\Core\Session\AccountInterface
-   */
   protected AccountInterface $privilegedUser;
 
-  /**
-   * A test user without AI permissions.
-   *
-   * @var \Drupal\Core\Session\AccountInterface
-   */
   protected AccountInterface $unprivilegedUser;
 
-  /**
-   * The Canvas AI temp store service mock.
-   *
-   * @var \Drupal\canvas_ai\CanvasAiTempStore|\PHPUnit\Framework\MockObject\MockObject
-   */
-  protected $mockTempStore;
+  protected CanvasAiTempStore|MockObject $mockTempStore;
 
   /**
    * {@inheritdoc}
@@ -72,9 +52,8 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
     $this->functionCallManager = $this->container->get('plugin.manager.ai.function_calls');
     $privileged_user = $this->createUser([CanvasAiPermissions::USE_CANVAS_AI]);
     $unprivileged_user = $this->createUser();
-    if (!$privileged_user instanceof User || !$unprivileged_user instanceof User) {
-      throw new \Exception('Failed to create test users');
-    }
+    self::assertInstanceOf(AccountInterface::class, $privileged_user);
+    self::assertInstanceOf(AccountInterface::class, $unprivileged_user);
     $this->privilegedUser = $privileged_user;
     $this->unprivilegedUser = $unprivileged_user;
     $this->container->get(ModuleInstallerInterface::class)->install(['canvas_test_sdc']);
-- 
GitLab


From 82feef9fc370bda60b641b43a7d5ffc2f535677c Mon Sep 17 00:00:00 2001
From: Ted Bowman <ted+git@tedbow.com>
Date: Mon, 1 Dec 2025 13:00:12 -0500
Subject: [PATCH 38/50] CanvasAIThemeRegionSettingsForm nits

---
 .../src/Form/CanvasAIThemeRegionSettingsForm.php   | 14 +++-----------
 1 file changed, 3 insertions(+), 11 deletions(-)

diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index b5f8440ad..53bccaf53 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -17,18 +17,10 @@ use Symfony\Component\DependencyInjection\ContainerInterface;
  */
 final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
 
-  protected readonly string $defaultTheme;
+  private readonly string $defaultTheme;
 
-  /**
-   * Creates a new CanvasAiComponentDescriptionSettingsForm instance.
-   *
-   * @param \Drupal\Core\Config\ConfigFactoryInterface $config_factory
-   *   The config factory service.
-   */
-  public function __construct(
-    protected readonly ConfigFactoryInterface $config_factory,
-  ) {
-    $this->defaultTheme = $this->config_factory->get('system.theme')->get('default');
+  public function __construct(ConfigFactoryInterface $config_factory) {
+    $this->defaultTheme = $config_factory->get('system.theme')->get('default');
   }
 
   /**
-- 
GitLab


From 4060011ad08970daeed42beb9727cccae07f97a1 Mon Sep 17 00:00:00 2001
From: Ted Bowman <ted+git@tedbow.com>
Date: Mon, 1 Dec 2025 15:47:30 -0500
Subject: [PATCH 39/50] changed form route back to use 'ai' path, fixes
 breadcrumbs

---
 modules/canvas_ai/canvas_ai.routing.yml | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/canvas_ai.routing.yml b/canvas_ai/canvas_ai.routing.yml
index 62573b3f4..4c7ac4f98 100644
--- a/canvas_ai/canvas_ai.routing.yml
+++ b/canvas_ai/canvas_ai.routing.yml
@@ -22,7 +22,7 @@ canvas_ai.component_description_settings:
     _permission: 'administer components'
 
 canvas_ai.setting:
-  path: '/admin/config/system/canvas-ai-settings'
+  path: '/admin/config/ai/canvas-ai-settings'
   defaults:
     _title: 'Canvas AI Settings Form'
     _form: 'Drupal\canvas_ai\Form\CanvasAiSettingsForm'
-- 
GitLab


From 22aa6200458ab93a68146899452be4078eba70a2 Mon Sep 17 00:00:00 2001
From: Ted Bowman <ted+git@tedbow.com>
Date: Mon, 1 Dec 2025 15:54:22 -0500
Subject: [PATCH 40/50] phpstan

---
 .../Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php    | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index d198cc441..3f940b49a 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -28,7 +28,7 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
 
   protected AccountInterface $unprivilegedUser;
 
-  protected CanvasAiTempStore|MockObject $mockTempStore;
+  protected MockObject $mockTempStore;
 
   /**
    * {@inheritdoc}
-- 
GitLab


From 84882f0fd60d6eb33bfef4d7d1397bf98c23e59d Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:36:47 +0530
Subject: [PATCH 41/50] Resolve merge conflicts

---
 modules/canvas_ai/{src => assets}/PropGuidelines.md | 0
 1 file changed, 0 insertions(+), 0 deletions(-)
 rename modules/canvas_ai/{src => assets}/PropGuidelines.md (100%)

diff --git a/canvas_ai/src/PropGuidelines.md b/canvas_ai/assets/PropGuidelines.md
similarity index 100%
rename from canvas_ai/src/PropGuidelines.md
rename to canvas_ai/assets/PropGuidelines.md
-- 
GitLab


From e747c42581e3f79a9929fc0a7203ed2d8ffd36c9 Mon Sep 17 00:00:00 2001
From: Ted Bowman <ted+git@tedbow.com>
Date: Mon, 1 Dec 2025 16:08:46 -0500
Subject: [PATCH 42/50] update agent label

---
 .../ai_agents.ai_agent.canvas_template_builder_agent.yml        | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 9381c0c21..45f363d61 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -5,7 +5,7 @@ dependencies:
     module:
       - canvas_ai
 id: canvas_template_builder_agent
-label: 'Canvas Template Builder Agent'
+label: 'Drupal Canvas Template Builder Agent'
 description: 'This tool specializes in building complete web pages by assembling available components into a cohesive layout. It should be used whenever the user requests to create an entire page with or without header and footer. For example, Create a landing page for a university website or Build a landing page template for a cookie shop. Add a header and footer etc.'
 system_prompt: |-
   You are an AI assistant specialized in Drupal Canvas. Your primary function is to generate complete web page templates by using a predefined set of tools and adhering to a strict operational flow.
-- 
GitLab


From 26c923651e8eae8e9da647d1d291ae7d5a63b6af Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:37:50 +0530
Subject: [PATCH 43/50] Resolve merge conflicts

---
 modules/canvas_ai/assets/PropGuidelines.md    | 34 -----------------
 ...nts.ai_agent.canvas_page_builder_agent.yml | 38 +++++++++++++++++--
 ...ai_agent.canvas_template_builder_agent.yml | 36 +++++++++++++++++-
 3 files changed, 69 insertions(+), 39 deletions(-)
 delete mode 100644 modules/canvas_ai/assets/PropGuidelines.md

diff --git a/canvas_ai/assets/PropGuidelines.md b/canvas_ai/assets/PropGuidelines.md
deleted file mode 100644
index 7646e55e5..000000000
--- a/canvas_ai/assets/PropGuidelines.md
+++ /dev/null
@@ -1,34 +0,0 @@
-### Prop Setting Logic
-Follow this step-by-step logic for every prop of every component:
-
-**1. Default Prop Formatting:**
-- By default, set prop values in the standard `prop_name: "value"` format.
-- Generate professional, relevant content appropriate for the template's purpose.
-- Create meaningful, contextual text for all text-based props, including buttons and link labels.
-
-**2. Conditional Formatting for URL/Link Props:**
-- When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
-
-**3. Strict Image Prop Handling (CRITICAL):**
-- When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
-- Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
-- **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
-- **DO NOT** change, omit, or add any keys or values.
-- **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
-- **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
-- **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
-
-**Correct Example:**
-```yaml
-props:
-  banner_image:
-    src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
-    alt: "A good dog"
-    width: 601
-    height: 402
-```
-**4. General Prop Restrictions:**
-- **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
-- **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
-- **Enum:** If a prop has an enum, use only one of the allowed values. Never add non-existing values.
-- **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
index bdb5b8105..d8383f265 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
@@ -77,9 +77,40 @@ system_prompt: |
 
   2.  **Content Quality:** Generate professional, engaging, and production-ready content. **Avoid generic placeholders like "Lorem Ipsum" or "Sample Text."** The content must be contextually relevant to the component's purpose (e.g., a "Testimonial" component must have a realistic quote and author).
 
-  3.  **Strict Prop Setting Logic:** Follow these rules for every prop of every component.
-
-  [canvas_ai:prop_value_guidelines]
+  ### Prop Setting Logic
+  Follow this step-by-step logic for every prop of every component:
+
+  **1. Default Prop Formatting:**
+  - By default, set prop values in the standard `prop_name: "value"` format.
+  - Generate professional, relevant content appropriate for the template's purpose.
+  - Create meaningful, contextual text for all text-based props, including buttons and link labels.
+
+  **2. Conditional Formatting for URL/Link Props:**
+  - When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
+
+  **3. Strict Image Prop Handling (CRITICAL):**
+  - When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
+  - Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
+  - **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
+  - **DO NOT** change, omit, or add any keys or values.
+  - **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
+  - **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
+  - **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
+
+  **Correct Example:**
+  ```yaml
+  props:
+    banner_image:
+      src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
+      alt: "A good dog"
+      width: 601
+      height: 402
+  ```
+  **4. General Prop Restrictions:**
+  - **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
+  - **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
+  - **Enum:** If a prop has an enum, use only one of the allowed values. Never add non-existing values.
+  - **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
 
    **Single Location YAML Template:**
     ```yaml
@@ -185,3 +216,4 @@ exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
 structured_output_schema: ''
+# The Prop Setting Logic section must remain in sync with the configuration in 'canvas_template_builder_agent'.
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 45f363d61..799011e4c 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -44,9 +44,40 @@ system_prompt: |-
   - **JSON Layout Processing**: Analyze provided layout information to understand available regions and their usage
   - **Strategic Region Usage**: Make informed decisions about component placement across regions when explicitly requested
 
-  ## Content and Prop Value Guidelines
+  ### Prop Setting Logic
+  Follow this step-by-step logic for every prop of every component:
 
-  [canvas_ai:prop_value_guidelines]
+  **1. Default Prop Formatting:**
+  - By default, set prop values in the standard `prop_name: "value"` format.
+  - Generate professional, relevant content appropriate for the template's purpose.
+  - Create meaningful, contextual text for all text-based props, including buttons and link labels.
+
+  **2. Conditional Formatting for URL/Link Props:**
+  - When a prop is for a URL (e.g., `href`, `link`), you MUST set value as 'https://example.com'. If the user provides a specific URL, use that instead of `"https://example.com"`
+
+  **3. Strict Image Prop Handling (CRITICAL):**
+  - When a component prop is for an image (e.g., `image`, `banner_image`, `hero_image`), you MUST use the **exact** default values provided for that prop.
+  - Image props are typically complex objects containing keys like `src`, `alt`, `width`, and `height`.
+  - **REQUIRED ACTION:** Copy **ALL** keys and values from the default object exactly as provided.
+  - **DO NOT** change, omit, or add any keys or values.
+  - **DO NOT** modify the `src` path or `alt` text, even if they don't match the context of the user's request.
+  - **CRITICAL:** Use the exact `src` and `alt` text provided in the default, even if the alt text or image path suggests a different subject matter (e.g., if the default image is about chocolate but the user is creating a library page, still use the chocolate image default exactly as provided).
+  - **DO NOT** set image props to null, empty strings, or omit them unless there is no default provided.
+
+  **Correct Example:**
+  ```yaml
+  props:
+    banner_image:
+      src: /themes/contrib/demo/components/banner/assets/277628-911758.jpg
+      alt: "A good dog"
+      width: 601
+      height: 402
+  ```
+  **4. General Prop Restrictions:**
+  - **No HTML Attributes**: Do not generate values for props that correspond to HTML attributes like `class` or `id`.
+  - **No Custom Props**: Only use the props that are explicitly defined for the component. Never invent or add new props.
+  - **Enum:** If a prop has an enum, use only one of the allowed values. Never add non-existing values.
+  - **No empty or NULL values**: Setting `prop_name: NULL` / `prop_name: {}` / `prop_name: ''`, is strictly forbidden. Omit such props completely.
 
   ## Page Template Design Structure
 
@@ -134,3 +165,4 @@ exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
 structured_output_schema: ''
+# The Prop Setting Logic section must remain in sync with the configuration in 'canvas_page_builder_agent'.
-- 
GitLab


From 35111ac5f2e0dff03b1bf3b7fdda105a316877b3 Mon Sep 17 00:00:00 2001
From: Ted Bowman <ted+git@tedbow.com>
Date: Mon, 8 Dec 2025 16:27:54 -0500
Subject: [PATCH 44/50] move the comments about the system prompt next to the
 system prompt

---
 .../install/ai_agents.ai_agent.canvas_page_builder_agent.yml    | 2 +-
 .../ai_agents.ai_agent.canvas_template_builder_agent.yml        | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
index d8383f265..05fbaf04c 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_page_builder_agent.yml
@@ -7,6 +7,7 @@ dependencies:
 id: canvas_page_builder_agent
 label: 'Drupal Canvas Page Builder Agent'
 description: 'This agent can insert one or many existing components or sections into a specific location on a page. Use this to place a previously created component or section on a layout or page.'
+# The Prop Setting Logic section of 'system_prompt' must remain in sync with the configuration in 'canvas_template_builder_agent'.
 system_prompt: |
   ### **1. Persona and Core Mission**
 
@@ -216,4 +217,3 @@ exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
 structured_output_schema: ''
-# The Prop Setting Logic section must remain in sync with the configuration in 'canvas_template_builder_agent'.
diff --git a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
index 799011e4c..89679be47 100644
--- a/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
+++ b/canvas_ai/config/install/ai_agents.ai_agent.canvas_template_builder_agent.yml
@@ -7,6 +7,7 @@ dependencies:
 id: canvas_template_builder_agent
 label: 'Drupal Canvas Template Builder Agent'
 description: 'This tool specializes in building complete web pages by assembling available components into a cohesive layout. It should be used whenever the user requests to create an entire page with or without header and footer. For example, Create a landing page for a university website or Build a landing page template for a cookie shop. Add a header and footer etc.'
+# The Prop Setting Logic section of 'system_prompt' must remain in sync with the configuration in 'canvas_page_builder_agent'.
 system_prompt: |-
   You are an AI assistant specialized in Drupal Canvas. Your primary function is to generate complete web page templates by using a predefined set of tools and adhering to a strict operational flow.
 
@@ -165,4 +166,3 @@ exclude_users_role: false
 masquerade_roles: {  }
 structured_output_enabled: false
 structured_output_schema: ''
-# The Prop Setting Logic section must remain in sync with the configuration in 'canvas_page_builder_agent'.
-- 
GitLab


From 65974c792d5a2fdb1259150a897459a78677c97f Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Wed, 10 Dec 2025 21:29:55 +0530
Subject: [PATCH 45/50] Update schema and tests

---
 .../config/schema/canvas_ai.schema.yml        |  15 +-
 .../CanvasAIThemeRegionSettingsFormTest.php   | 112 ++++++
 .../Kernel/CanvasAiPageBuilderHelperTest.php  |   2 +-
 .../SetAIGeneratedTemplateDataTest.php        | 349 ++++++++++++++++--
 4 files changed, 454 insertions(+), 24 deletions(-)
 create mode 100644 modules/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php

diff --git a/canvas_ai/config/schema/canvas_ai.schema.yml b/canvas_ai/config/schema/canvas_ai.schema.yml
index db8a120d8..d45a41a5d 100644
--- a/canvas_ai/config/schema/canvas_ai.schema.yml
+++ b/canvas_ai/config/schema/canvas_ai.schema.yml
@@ -47,5 +47,16 @@ canvas_ai.theme_region.settings:
       label: 'Region Descriptions'
       mapping:
         '*':
-          type: text
-          label: 'Description'
+          type: mapping
+          label: 'Theme'
+          mapping:
+            '*':
+              type: mapping
+              label: 'Region'
+              mapping:
+                name:
+                  type: label
+                  label: 'Region Name'
+                description:
+                  type: text
+                  label: 'Description'
diff --git a/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php b/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
new file mode 100644
index 000000000..59b62d1e1
--- /dev/null
+++ b/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
@@ -0,0 +1,112 @@
+<?php
+
+declare(strict_types=1);
+
+namespace Drupal\Tests\canvas_ai\Functional\Form;
+
+use Drupal\Core\Session\AccountInterface;
+use Drupal\Tests\BrowserTestBase;
+use Drupal\canvas_ai\CanvasAiPermissions;
+
+/**
+ * Tests the Canvas AI Theme Region Settings form.
+ *
+ * @group canvas_ai
+ */
+final class CanvasAIThemeRegionSettingsFormTest extends BrowserTestBase {
+
+  /**
+   * {@inheritdoc}
+   */
+  protected $defaultTheme = 'stark';
+
+
+  /**
+   * {@inheritdoc}
+   */
+  protected $strictConfigSchema = FALSE;
+
+  /**
+   * {@inheritdoc}
+   */
+  protected static $modules = [
+    'canvas',
+    'canvas_ai',
+    'user',
+  ];
+
+  /**
+   * Tests the form.
+   */
+  public function testForm(): void {
+    // Create a user with the USE_CANVAS_AI permission and administer themes.
+    $user = $this->drupalCreateUser([
+      CanvasAiPermissions::USE_CANVAS_AI,
+      'administer themes',
+    ]);
+    assert($user instanceof AccountInterface);
+    $this->drupalLogin($user);
+
+    // Navigate to the form URL.
+    $this->drupalGet('/admin/config/ai/canvas-ai-theme-region-settings');
+
+    // Assert that the form title is displayed.
+    $this->assertSession()->statusCodeEquals(200);
+    $this->assertSession()->pageTextContains('Canvas AI Theme Region Settings');
+
+    // By default, no page regions are enabled in the theme.
+    // Assert that the appropriate message is displayed.
+    $this->assertSession()->pageTextContains('No page regions are enabled in your theme.');
+    $this->assertSession()->linkExists('theme settings');
+
+    // Enable Drupal Canvas for the Stark theme to enable page regions.
+    $this->drupalGet('/admin/appearance/settings/stark');
+    $this->assertSession()->pageTextContains('Drupal Canvas');
+    $this->assertSession()->fieldExists('use_canvas');
+    
+    // Enable Canvas for the Stark theme.
+    $this->submitForm(['use_canvas' => TRUE], 'Save configuration');
+    $this->assertSession()->pageTextContains('The configuration options have been saved.');
+
+    $this->drupalGet('/admin/appearance/settings/stark');
+    // Disable some regions.
+    $this->submitForm([
+      'editable[stark.sidebar_first]' => FALSE,
+      'editable[stark.header]' => FALSE,
+      'editable[stark.page_bottom]' => FALSE,
+    ], 'Save configuration');
+    $this->assertSession()->pageTextContains('The configuration options have been saved.');
+
+    // Now navigate back to the Canvas AI Theme Region Settings form.
+    $this->drupalGet('/admin/config/ai/canvas-ai-theme-region-settings');
+    // The "no regions" message should no longer be displayed.
+    $this->assertSession()->pageTextNotContains('No page regions are enabled in your theme.');
+
+    // We should see the form to add descriptions to the enabled regions.
+    $this->assertSession()->pageTextContains('The following page regions are available in your theme');
+    $this->assertSession()->pageTextNotContains('Left sidebar');
+    $this->assertSession()->pageTextContains('Right sidebar');
+    $this->assertSession()->pageTextContains('Content');
+    $this->assertSession()->pageTextNotContains('Header');
+    $this->assertSession()->pageTextContains('Primary menu');
+    $this->assertSession()->pageTextContains('Secondary menu');
+    $this->assertSession()->pageTextContains('Footer');
+    $this->assertSession()->pageTextContains('Highlighted');
+    $this->assertSession()->pageTextContains('Help');
+    $this->assertSession()->pageTextContains('Page top');
+    $this->assertSession()->pageTextNotContains('Page bottom');
+    $this->assertSession()->pageTextContains('Breadcrumb');
+
+    // Submit the form with a description for the breadcrumb region.
+    $breadcrumb_description = 'Breadcrumb region description updated';
+    $this->submitForm([
+      'stark[breadcrumb][description]' => $breadcrumb_description,
+    ], 'Save configuration');
+    $this->assertSession()->pageTextContains('The configuration options have been saved.');
+
+    // Navigate back to the form and verify the description was saved.
+    $this->drupalGet('/admin/config/ai/canvas-ai-theme-region-settings');
+    $this->assertSession()->fieldValueEquals('stark[breadcrumb][description]', $breadcrumb_description);
+  }
+
+}
diff --git a/canvas_ai/tests/src/Kernel/CanvasAiPageBuilderHelperTest.php b/canvas_ai/tests/src/Kernel/CanvasAiPageBuilderHelperTest.php
index 7d15f05db..53b632b78 100644
--- a/canvas_ai/tests/src/Kernel/CanvasAiPageBuilderHelperTest.php
+++ b/canvas_ai/tests/src/Kernel/CanvasAiPageBuilderHelperTest.php
@@ -296,7 +296,7 @@ YAML;
           'page_title' => 'Untitled page',
           'page_description' => '',
         ],
-        'The user is currently working on a canvas_page entity. User has selected a component in the page with uuid f47ac10b-58cc-4372-a567-0e02b2c3d479. Page title is empty. GENERATE THE TITLE FOR THE PAGE. Page description is empty. GENERATE THE DESCRIPTION FOR THE PAGE.',
+        'The user is currently working on a canvas_page entity. User has selected a component in the page with uuid f47ac10b-58cc-4372-a567-0e02b2c3d479. Page title is empty. GENERATE THE TITLE FOR THE PAGE using canvas_title_generation_agent. This is a **CRITICAL** step to ensure that request is successful. Page description is empty. GENERATE THE DESCRIPTION FOR THE PAGE using canvas_metadata_generation_agent. This is a **CRITICAL** step to ensure that request is successful.',
       ],
     ];
   }
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 3f940b49a..3b0ef62fc 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -5,14 +5,17 @@ declare(strict_types=1);
 namespace Drupal\Tests\canvas_ai\Kernel\Plugin\AiFunctionCall;
 
 use Drupal\ai\Service\FunctionCalling\FunctionCallPluginManager;
+use Drupal\canvas\Entity\Component;
 use Drupal\Core\Session\AccountInterface;
 use Drupal\KernelTests\KernelTestBase;
 use Drupal\Tests\user\Traits\UserCreationTrait;
+use Drupal\Tests\canvas_ai\Traits\FunctionalCallTestTrait;
 use Drupal\canvas_ai\CanvasAiPermissions;
 use Drupal\canvas_ai\CanvasAiTempStore;
 use Drupal\canvas_ai\Plugin\AiFunctionCall\SetAIGeneratedTemplateData;
 use Drupal\Core\Extension\ModuleInstallerInterface;
 use PHPUnit\Framework\MockObject\MockObject;
+use Symfony\Component\Yaml\Yaml;
 
 /**
  * @coversDefaultClass \Drupal\canvas_ai\Plugin\AiFunctionCall\SetAIGeneratedTemplateData
@@ -20,6 +23,7 @@ use PHPUnit\Framework\MockObject\MockObject;
  */
 final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
 
+  use FunctionalCallTestTrait;
   use UserCreationTrait;
 
   protected FunctionCallPluginManager $functionCallManager;
@@ -67,21 +71,82 @@ final class SetAIGeneratedTemplateDataTest extends KernelTestBase {
   }
 
   /**
-   * Tests the tool output.
+   * Tests the tool output with valid component structure.
+   *
+   * @dataProvider templateDataToolDataProvider
    */
-  public function testSetTemplateDataTool(): void {
+  public function testSetTemplateDataTool(string $component_structure_yaml, array $current_layout, array $expected_output): void {
     $this->container->get('current_user')->setAccount($this->privilegedUser);
 
-    $valid_yaml = <<<YAML
+    $layout_json = \json_encode($current_layout);
+
+    $this->mockTempStore->expects($this->once())
+      ->method('getData')
+      ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
+      ->willReturn($layout_json);
+
+    $tool = $this->functionCallManager->createInstance('canvas_ai:set_template_data');
+    $this->assertInstanceOf(SetAIGeneratedTemplateData::class, $tool);
+
+    $tool->setContextValue('component_structure', $component_structure_yaml);
+    $tool->execute();
+
+    $result = $tool->getStructuredOutput();
+    $this->assertEquals($expected_output,
+      $result,
+      "The component structure was not processed correctly"
+    );
+  }
+
+  /**
+   * Tests validation errors.
+   */
+  public function testValidationError(): void {
+    $this->container->get('current_user')->setAccount($this->privilegedUser);
+
+    $invalid_nested_yaml = <<<YAML
 content:
-  - sdc.canvas_test_sdc.my-hero:
+  - sdc.canvas_test_sdc.two_column:
       props:
-        heading: 'My Hero'
-        subheading: 'SubSnub'
-        cta1: 'View it!'
-        cta1href: 'https://canvas-example.com'
-        cta2: 'Click it!'
-sidebar:
+        width: 50
+      slots:
+        column_one:
+          - sdc.canvas_test_sdc.my-hero:
+              props:
+                heading: 'My Hero'
+                subheading: 'SubSnub'
+                cta1: 'View it!'
+                cta2: 'Click it!'
+YAML;
+
+    $mock_layout = [
+      "regions" => [
+        "content" => [
+          "nodePathPrefix" => [0],
+          "components" => [],
+        ],
+      ],
+    ];
+    $layout_json = \json_encode($mock_layout);
+
+    $this->mockTempStore->expects($this->once())
+      ->method('getData')
+      ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
+      ->willReturn($layout_json);
+
+
+    $result = $this->getTemplateToolOutput($invalid_nested_yaml);
+    $this->assertSame('Failed to save: Component validation errors: components.0.[sdc.canvas_test_sdc.two_column].slots.column_one.0.[sdc.canvas_test_sdc.my-hero].props.cta1href: The property cta1href is required.', self::normalizeErrorString($result));
+  }
+
+  /**
+   * Tests invalid region error.
+   */
+  public function testInvalidRegionError(): void {
+    $this->container->get('current_user')->setAccount($this->privilegedUser);
+
+    $invalid_region_yaml = <<<YAML
+invalid_region:
   - sdc.canvas_test_sdc.heading:
       props:
         text: 'Some text'
@@ -107,25 +172,82 @@ YAML;
       ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
       ->willReturn($layout_json);
 
+    $result = $this->getTemplateToolOutput($invalid_region_yaml);
+    $this->assertSame('Failed to save: Region "invalid_region" does not exist. Available regions are: content, sidebar.', self::normalizeErrorString($result));
+  }
+
+  /**
+   * Tests the tool output with components with required image prop.
+   */
+  public function testTemplateDataOutputWithComponentsWithRequiredImageProp(): void {
+    $this->container->get('current_user')->setAccount($this->privilegedUser);
+
+    // If a componnet has an image prop and that prop is required, the component data passed to the tool should have the
+    // exact default values for the image prop which can be obtained from ContentTemplate::normalizeForClientSide(). Else the
+    // validation will fail.
+    $component = Component::load('sdc.canvas_test_sdc.card');
+    assert($component instanceof Component);
+    $clientNormalized = $component->normalizeForClientSide()->values;
+    // Get the default values for the image prop of the card component.
+    $default_values = $clientNormalized["propSources"]["image"]["default_values"]["resolved"];
+
+    $structure = [
+      'content' => [
+        [
+          'sdc.canvas_test_sdc.card' => [
+            'props' => [
+              'title' => 'Test Card',
+              'content' => 'Test content',
+              'loading' => 'lazy',
+              'image' => $default_values,
+            ],
+          ],
+        ],
+        [
+          'sdc.canvas_test_sdc.heading' => [
+            'props' => [
+              'text' => 'Some text',
+              'element' => 'h1',
+            ],
+          ],
+        ],
+      ],
+    ];
+
+    $valid_yaml = Yaml::dump($structure);
+
+    $mock_layout = [
+      "regions" => [
+        "content" => [
+          "nodePathPrefix" => [0],
+          "components" => [],
+        ],
+      ],
+    ];
+
+    $this->mockTempStore->expects($this->once())
+      ->method('getData')
+      ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
+      ->willReturn(\json_encode($mock_layout));
+
     $expected_output = [
       'operations' => [
         [
           'operation' => 'ADD',
           'components' => [
             [
-              'id' => 'sdc.canvas_test_sdc.my-hero',
+              'id' => 'sdc.canvas_test_sdc.card',
               'nodePath' => [0, 0],
               'fieldValues' => [
-                'heading' => 'My Hero',
-                'subheading' => 'SubSnub',
-                'cta1' => 'View it!',
-                'cta1href' => 'https://canvas-example.com',
-                'cta2' => 'Click it!',
+                'title' => 'Test Card',
+                'content' => 'Test content',
+                'loading' => 'lazy',
+                'image' => $default_values,
               ],
             ],
             [
               'id' => 'sdc.canvas_test_sdc.heading',
-              'nodePath' => [1, 0],
+              'nodePath' => [0, 1],
               'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
             ],
           ],
@@ -140,10 +262,195 @@ YAML;
     $tool->execute();
 
     $result = $tool->getStructuredOutput();
-    $this->assertEquals($expected_output,
-      $result,
-      "The component structure was not processed correctly"
-    );
+    $this->assertEquals($expected_output, $result);
+  }
+
+
+
+  private function getTemplateToolOutput(string $yaml): string {
+    return $this->getToolOutput('canvas_ai:set_template_data', ['component_structure' => $yaml]);
+  }
+
+  /**
+   * Data provider for testSetTemplateDataTool.
+   */
+  public static function templateDataToolDataProvider(): array {
+    return [
+      'simple_input' => [
+        'component_structure_yaml' => <<<YAML
+content:
+  - sdc.canvas_test_sdc.my-hero:
+      props:
+        heading: 'My Hero'
+        subheading: 'SubSnub'
+        cta1: 'View it!'
+        cta1href: 'https://canvas-example.com'
+        cta2: 'Click it!'
+sidebar:
+  - sdc.canvas_test_sdc.heading:
+      props:
+        text: 'Some text'
+        element: 'h1'
+YAML,
+        'current_layout' => [
+          "regions" => [
+            "content" => [
+              "nodePathPrefix" => [0],
+              "components" => [],
+            ],
+            "sidebar" => [
+              "nodePathPrefix" => [1],
+              "components" => [],
+            ],
+          ],
+        ],
+        'expected_output' => [
+          'operations' => [
+            [
+              'operation' => 'ADD',
+              'components' => [
+                [
+                  'id' => 'sdc.canvas_test_sdc.my-hero',
+                  'nodePath' => [0, 0],
+                  'fieldValues' => [
+                    'heading' => 'My Hero',
+                    'subheading' => 'SubSnub',
+                    'cta1' => 'View it!',
+                    'cta1href' => 'https://canvas-example.com',
+                    'cta2' => 'Click it!',
+                  ],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [1, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+              ],
+            ],
+          ],
+        ],
+      ],
+      'nested_input' => [
+        'component_structure_yaml' => <<<YAML
+content:
+  - sdc.canvas_test_sdc.two_column:
+      props:
+        width: '50'
+      slots:
+        column_one:
+          - sdc.canvas_test_sdc.heading:
+              props:
+                text: 'Some text'
+                element: 'h1'
+        column_two:
+          - sdc.canvas_test_sdc.heading:
+              props:
+                text: 'Some text'
+                element: 'h1'
+sidebar:
+  - sdc.canvas_test_sdc.two_column:
+      props:
+        width: '50'
+      slots:
+        column_one:
+          - sdc.canvas_test_sdc.heading:
+              props:
+                text: 'Some text'
+                element: 'h1'
+        column_two:
+          - sdc.canvas_test_sdc.heading:
+              props:
+                text: 'Some text'
+                element: 'h1'
+          - sdc.canvas_test_sdc.two_column:
+              props:
+                width: '50'
+              slots:
+                column_one:
+                  - sdc.canvas_test_sdc.heading:
+                      props:
+                        text: 'Some text'
+                        element: 'h1'
+                column_two:
+                  - sdc.canvas_test_sdc.heading:
+                      props:
+                        text: 'Some text'
+                        element: 'h1'
+YAML,
+        'current_layout' => [
+          "regions" => [
+            "content" => [
+              "nodePathPrefix" => [0],
+              "components" => [],
+            ],
+            "sidebar" => [
+              "nodePathPrefix" => [1],
+              "components" => [],
+            ],
+          ],
+        ],
+        'expected_output' => [
+          'operations' => [
+            [
+              'operation' => 'ADD',
+              'components' => [
+                [
+                  'id' => 'sdc.canvas_test_sdc.two_column',
+                  'nodePath' => [0, 0],
+                  'fieldValues' => [
+                    'width' => '50',
+                  ],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [0, 0, 0, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [0, 0, 1, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.two_column',
+                  'nodePath' => [1, 0],
+                  'fieldValues' => [
+                    'width' => '50',
+                  ],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [1, 0, 0, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [1, 0, 1, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.two_column',
+                  'nodePath' => [1, 0, 1, 1],
+                  'fieldValues' => [
+                    'width' => '50',
+                  ],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [1, 0, 1, 1, 0, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+                [
+                  'id' => 'sdc.canvas_test_sdc.heading',
+                  'nodePath' => [1, 0, 1, 1, 1, 0],
+                  'fieldValues' => ['text' => 'Some text', 'element' => 'h1'],
+                ],
+              ],
+            ],
+          ],
+        ],
+      ],
+    ];
   }
 
 }
-- 
GitLab


From 2047ef77b5ddd1279b66e8b92c1b835143f36e38 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Wed, 10 Dec 2025 21:47:05 +0530
Subject: [PATCH 46/50] PHPCS

---
 .../Form/CanvasAIThemeRegionSettingsFormTest.php         | 2 +-
 .../AiFunctionCall/SetAIGeneratedTemplateDataTest.php    | 9 +++------
 2 files changed, 4 insertions(+), 7 deletions(-)

diff --git a/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php b/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
index 59b62d1e1..4c2111048 100644
--- a/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
+++ b/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
@@ -63,7 +63,7 @@ final class CanvasAIThemeRegionSettingsFormTest extends BrowserTestBase {
     $this->drupalGet('/admin/appearance/settings/stark');
     $this->assertSession()->pageTextContains('Drupal Canvas');
     $this->assertSession()->fieldExists('use_canvas');
-    
+
     // Enable Canvas for the Stark theme.
     $this->submitForm(['use_canvas' => TRUE], 'Save configuration');
     $this->assertSession()->pageTextContains('The configuration options have been saved.');
diff --git a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
index 3b0ef62fc..74d28c7e3 100644
--- a/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
+++ b/canvas_ai/tests/src/Kernel/Plugin/AiFunctionCall/SetAIGeneratedTemplateDataTest.php
@@ -134,7 +134,6 @@ YAML;
       ->with(CanvasAiTempStore::CURRENT_LAYOUT_KEY)
       ->willReturn($layout_json);
 
-
     $result = $this->getTemplateToolOutput($invalid_nested_yaml);
     $this->assertSame('Failed to save: Component validation errors: components.0.[sdc.canvas_test_sdc.two_column].slots.column_one.0.[sdc.canvas_test_sdc.my-hero].props.cta1href: The property cta1href is required.', self::normalizeErrorString($result));
   }
@@ -182,9 +181,9 @@ YAML;
   public function testTemplateDataOutputWithComponentsWithRequiredImageProp(): void {
     $this->container->get('current_user')->setAccount($this->privilegedUser);
 
-    // If a componnet has an image prop and that prop is required, the component data passed to the tool should have the
-    // exact default values for the image prop which can be obtained from ContentTemplate::normalizeForClientSide(). Else the
-    // validation will fail.
+    // If a component has an image prop and that prop is required, the component data passed to the tool must include the
+    // exact default values for the image prop, which can be obtained from ContentTemplate::normalizeForClientSide(). Otherwise,
+    // the validation will fail.
     $component = Component::load('sdc.canvas_test_sdc.card');
     assert($component instanceof Component);
     $clientNormalized = $component->normalizeForClientSide()->values;
@@ -265,8 +264,6 @@ YAML;
     $this->assertEquals($expected_output, $result);
   }
 
-
-
   private function getTemplateToolOutput(string $yaml): string {
     return $this->getToolOutput('canvas_ai:set_template_data', ['component_structure' => $yaml]);
   }
-- 
GitLab


From d00c042d1af115c27d8e4882968d354f2a68c2af Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 18 Dec 2025 15:29:08 +0530
Subject: [PATCH 47/50] Add proper schema for region settings form

---
 .../config/schema/canvas_ai.schema.yml        | 28 +++++++++----------
 .../CanvasAIThemeRegionSettingsFormTest.php   |  6 ----
 2 files changed, 13 insertions(+), 21 deletions(-)

diff --git a/canvas_ai/config/schema/canvas_ai.schema.yml b/canvas_ai/config/schema/canvas_ai.schema.yml
index d45a41a5d..8a6c45a13 100644
--- a/canvas_ai/config/schema/canvas_ai.schema.yml
+++ b/canvas_ai/config/schema/canvas_ai.schema.yml
@@ -43,20 +43,18 @@ canvas_ai.theme_region.settings:
   label: 'Canvas AI Theme Region Settings'
   mapping:
     region_descriptions:
-      type: mapping
-      label: 'Region Descriptions'
-      mapping:
-        '*':
+      type: sequence
+      label: 'Region descriptions'
+      sequence:
+        type: sequence
+        label: 'Theme'
+        sequence:
           type: mapping
-          label: 'Theme'
+          label: 'Region'
           mapping:
-            '*':
-              type: mapping
-              label: 'Region'
-              mapping:
-                name:
-                  type: label
-                  label: 'Region Name'
-                description:
-                  type: text
-                  label: 'Description'
+            name:
+              type: label
+              label: 'Region name'
+            description:
+              type: text
+              label: 'Region description'
diff --git a/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php b/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
index 4c2111048..c7299af20 100644
--- a/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
+++ b/canvas_ai/tests/src/Functional/Form/CanvasAIThemeRegionSettingsFormTest.php
@@ -20,12 +20,6 @@ final class CanvasAIThemeRegionSettingsFormTest extends BrowserTestBase {
    */
   protected $defaultTheme = 'stark';
 
-
-  /**
-   * {@inheritdoc}
-   */
-  protected $strictConfigSchema = FALSE;
-
   /**
    * {@inheritdoc}
    */
-- 
GitLab


From 35d8bfbffdbb704952e2fe78d501efbf1812b2e9 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 22 Jan 2026 10:51:40 +0530
Subject: [PATCH 48/50] Address feedbacks

---
 .../src/CanvasAiPageBuilderHelper.php         |  6 ++-
 .../Form/CanvasAIThemeRegionSettingsForm.php  | 49 +++++++++----------
 2 files changed, 29 insertions(+), 26 deletions(-)

diff --git a/canvas_ai/src/CanvasAiPageBuilderHelper.php b/canvas_ai/src/CanvasAiPageBuilderHelper.php
index a5d69af74..3c4a2203e 100644
--- a/canvas_ai/src/CanvasAiPageBuilderHelper.php
+++ b/canvas_ai/src/CanvasAiPageBuilderHelper.php
@@ -14,6 +14,7 @@ use Symfony\Component\Yaml\Yaml;
 use Drupal\Component\Utility\DiffArray;
 use Drupal\Component\Uuid\UuidInterface;
 use Drupal\Core\Config\ConfigFactoryInterface;
+use Drupal\Core\Extension\ThemeHandlerInterface;
 use Drupal\canvas\Entity\Component;
 use Drupal\canvas\Plugin\Canvas\ComponentSource\JsComponent;
 use Drupal\canvas\Plugin\Canvas\ComponentSource\SingleDirectoryComponent;
@@ -43,6 +44,8 @@ class CanvasAiPageBuilderHelper {
    *   The UUID service.
    * @param \Drupal\canvas_ai\CanvasAiTempStore $canvasAiTempstore
    *   The Canvas AI tempstore.
+   * @param \Drupal\Core\Extension\ThemeHandlerInterface $themeHandler
+   *   The theme handler.
    */
   public function __construct(
     private readonly ComponentPluginManager $componentPluginManager,
@@ -52,6 +55,7 @@ class CanvasAiPageBuilderHelper {
     private readonly RequestStack $requestStack,
     private readonly UuidInterface $uuidService,
     private readonly CanvasAiTempStore $canvasAiTempstore,
+    private readonly ThemeHandlerInterface $themeHandler,
   ) {
   }
 
@@ -1212,7 +1216,7 @@ class CanvasAiPageBuilderHelper {
     $region_index_mapping = $this->getRegionIndex($current_layout);
     $region_descriptions = $this->configFactory->get('canvas_ai.theme_region.settings')->get('region_descriptions') ?? [];
     $available_regions = [];
-    $active_theme = $this->configFactory->get('system.theme')->get('default');
+    $active_theme = $this->themeHandler->getDefault();
     foreach ($region_index_mapping as $region_name => $region_index) {
       $available_regions[$region_name] = [
         'nodePathPrefix' => $region_index,
diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index 53bccaf53..85e75bc09 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -4,9 +4,9 @@ declare(strict_types=1);
 
 namespace Drupal\canvas_ai\Form;
 
+use Drupal\Core\Extension\ThemeHandlerInterface;
 use Drupal\Core\Form\ConfigFormBase;
 use Drupal\Core\Form\FormStateInterface;
-use Drupal\Core\Config\ConfigFactoryInterface;
 use Drupal\Core\Url;
 use Drupal\Component\Utility\NestedArray;
 use Drupal\canvas\Entity\PageRegion;
@@ -17,10 +17,15 @@ use Symfony\Component\DependencyInjection\ContainerInterface;
  */
 final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
 
+  /**
+   * The default site theme.
+   *
+   * @var string
+   */
   private readonly string $defaultTheme;
 
-  public function __construct(ConfigFactoryInterface $config_factory) {
-    $this->defaultTheme = $config_factory->get('system.theme')->get('default');
+  public function __construct(ThemeHandlerInterface $themeHandler) {
+    $this->defaultTheme = $themeHandler->getDefault();
   }
 
   /**
@@ -28,7 +33,7 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
    */
   public static function create(ContainerInterface $container): static {
     return new static(
-      $container->get('config.factory'),
+      $container->get('theme_handler'),
     );
   }
 
@@ -68,16 +73,7 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
 
     $form['message'] = [
       '#type' => 'markup',
-      '#markup' => $this->t('
-        <p>The following page regions are available in your theme and can be used by the <strong>Canvas Template Builder Agent</strong> to build the layout for a complete page (for example, building a homepage for a pizza shop).</p>
-
-        <p>Use this form to describe how each region should be used.</p>
-
-        <p><em>Example:</em> If your theme has two footer regions and both are enabled, footer_top and footer_bottom, you can add instructions like:</p>
-
-        <p><strong>Footer Top:</strong> <em>"Add the site name, logo, and menu links (use button components with the \'type\' prop value set to \'link\')."</em></p>
-        <p><strong>Footer Bottom:</strong> <em>"Add social media links and copyright text."</em></p>
-      '),
+      '#markup' => $this->t('<p>The following page regions are available in your theme and can be used by the <strong>Canvas Template Builder Agent</strong> to build the layout for a complete page (for example, building a homepage for a pizza shop).</p><p>Use this form to describe how each region should be used.</p>'),
     ];
 
     $descriptions = $config->get('region_descriptions') ?? [];
@@ -94,6 +90,8 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
         '#title' => $this->t('Description'),
         '#description' => $this->t('Provide a description for what kind of content should be placed in this region.'),
         '#default_value' => NestedArray::getValue($descriptions, [$this->defaultTheme, $region_id, 'description']) ?: '',
+        '#placeholder' => $this->t("Example: If your theme has two footer regions enabled (footer_top and footer_bottom), you can add instructions like:\n\nFooter Top: \"This region should contain the site name, site logo, and footer navigation links, wrapped in a container component with the 'margin' prop set to 'large'. Use button components with the 'type' prop set to 'link' for navigation links.\"\n\nFooter Bottom: \"This region should contain social media icons using the social media component and a copyright notice using the paragraph component, wrapped in a container component with the 'margin' prop set to 'large'.\""),
+        '#rows' => 7,
       ];
     }
 
@@ -126,13 +124,18 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
   /**
    * Get the enabled theme regions for the default site theme.
    *
-   * @return array
-   *   An array of enabled theme regions.
+   * @return \Drupal\canvas\Entity\PageRegion[]
+   *   An array of enabled PageRegion entities, sorted alphabetically by label.
    */
-  protected function getEnabledRegionsForDefaultSiteTheme(): array {
-    $regions = PageRegion::loadForTheme($this->defaultTheme);
-    return array_filter($regions, fn($region) => $region->status());
-  }
+    protected function getEnabledRegionsForDefaultSiteTheme(): array {
+      $regions = PageRegion::loadForTheme($this->defaultTheme);
+      $regions = array_filter($regions, fn($region) => $region->status());
+      // Sort regions alphabetically by label.
+      usort($regions, fn($a, $b) => \strnatcasecmp((string) $a->label(), (string) $b->label()));
+
+      return $regions;
+    }
+
 
   /**
    * Get region ID.
@@ -144,11 +147,7 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
    *   The region ID.
    */
   protected function getRegionId(PageRegion $region): string {
-    $region_id = $region->id();
-    \assert(str_contains($region_id, '.'));
-    $parts = explode('.', $region_id);
-    \assert(count($parts) === 2);
-    return $parts[1];
+    return $region->get('region');
   }
 
 }
-- 
GitLab


From 2fd0dc9de2de99f684af280a93e9f6891876768a Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Thu, 22 Jan 2026 11:37:51 +0530
Subject: [PATCH 49/50] Fix linting errors.

---
 .../canvas_ai/src/Controller/CanvasBuilder.php    |  2 +-
 .../src/Form/CanvasAIThemeRegionSettingsForm.php  | 15 +++++++--------
 2 files changed, 8 insertions(+), 9 deletions(-)

diff --git a/canvas_ai/src/Controller/CanvasBuilder.php b/canvas_ai/src/Controller/CanvasBuilder.php
index 5fd5732b5..1065f00b4 100644
--- a/canvas_ai/src/Controller/CanvasBuilder.php
+++ b/canvas_ai/src/Controller/CanvasBuilder.php
@@ -265,7 +265,7 @@ final class CanvasBuilder extends ControllerBase {
           if ($tool instanceof AiAgentWrapper) {
             $response['message'] = $tool->getReadableOutput();
           }
-          if (in_array($tool->getPluginId(), ['ai_agents::ai_agent::canvas_page_builder_agent', 'ai_agents::ai_agent::canvas_template_builder_agent'])) {
+          if (in_array($tool->getPluginId(), ['ai_agents::ai_agent::canvas_page_builder_agent', 'ai_agents::ai_agent::canvas_template_builder_agent'], TRUE)) {
             $this->canvasAiTempStore->deleteData(CanvasAiTempStore::CURRENT_LAYOUT_KEY);
           }
         }
diff --git a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
index 85e75bc09..8cadc1739 100644
--- a/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
+++ b/canvas_ai/src/Form/CanvasAIThemeRegionSettingsForm.php
@@ -127,15 +127,14 @@ final class CanvasAIThemeRegionSettingsForm extends ConfigFormBase {
    * @return \Drupal\canvas\Entity\PageRegion[]
    *   An array of enabled PageRegion entities, sorted alphabetically by label.
    */
-    protected function getEnabledRegionsForDefaultSiteTheme(): array {
-      $regions = PageRegion::loadForTheme($this->defaultTheme);
-      $regions = array_filter($regions, fn($region) => $region->status());
-      // Sort regions alphabetically by label.
-      usort($regions, fn($a, $b) => \strnatcasecmp((string) $a->label(), (string) $b->label()));
-
-      return $regions;
-    }
+  protected function getEnabledRegionsForDefaultSiteTheme(): array {
+    $regions = PageRegion::loadForTheme($this->defaultTheme);
+    $regions = array_filter($regions, fn($region) => $region->status());
+    // Sort regions alphabetically by label.
+    usort($regions, fn($a, $b) => \strnatcasecmp((string) $a->label(), (string) $b->label()));
 
+    return $regions;
+  }
 
   /**
    * Get region ID.
-- 
GitLab


From 755466b102083a285507e7258855ced1de8b7279 Mon Sep 17 00:00:00 2001
From: AKHIL BABU <akhilbabui1998@gmail.com>
Date: Fri, 23 Jan 2026 11:00:07 +0530
Subject: [PATCH 50/50] Add success message to the tool.

---
 .../src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php     | 1 +
 1 file changed, 1 insertion(+)

diff --git a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
index 3e0afcb8e..98830476c 100644
--- a/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
+++ b/canvas_ai/src/Plugin/AiFunctionCall/SetAIGeneratedTemplateData.php
@@ -130,6 +130,7 @@ final class SetAIGeneratedTemplateData extends FunctionCallBase implements Execu
       // Process the YAML structure for UI representation.
       $processed_structure = $this->pageBuilderHelper->processSetTemplateDataToolInput($component_structure_array, $current_layout);
       $this->setStructuredOutput($processed_structure);
+      $this->setOutput('Template data has been successfully set.');
     }
     catch (\Exception $e) {
       $this->loggerFactory->get('canvas_ai')->error($e->getMessage());
-- 
GitLab

